<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Win-Man&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Win-Man&#39;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Win-Man&#39;s Blog">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>Win-Man's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Win-Man's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(六)——MySQL常见binlog event解析（中）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(六)——MySQL常见binlog event解析（中）/" class="post-title-link" itemprop="url">MySQL Binlog(六)——MySQL常见binlog event解析（中）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:43:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:43:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-六-——MySQL常见binlog-event解析（中）"><a href="#MySQL-Binlog-六-——MySQL常见binlog-event解析（中）" class="headerlink" title="MySQL Binlog(六)——MySQL常见binlog event解析（中）"></a>MySQL Binlog(六)——MySQL常见binlog event解析（中）</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文继续介绍binlog中常见的event：Table_map_event、Write_rows_log_event、Update_rows_log_event、Delete_rows_log_event、Xid_event。</p>
<h2 id="Table-map-event"><a href="#Table-map-event" class="headerlink" title="Table_map_event"></a>Table_map_event</h2><p>TABLE_MAP_EVENT只有在binlog文件是以ROW格式记录的时候，才会使用。binlog中记录的每个更改的记录之前都会有一个对应要操作的表的TABLE_MAP_EVENT。TABLE_MAP_EVENT中记录了表的定义（包括database name,table name，字段定义），并且会将这个表的定义对应于一个数字，称为table_id。设计TABLE_MAP_EVENT类型event的目的是为了当主库和从库之间有不同的表定义的时候，复制仍能进行。如果一个事务中操作了多个表，多行记录，在binlog中会将对多行记录的操作event进行分组，每组行记录操作event前面会出现对应表的TABLE_MAP_EVENT。</p>
<h3 id="post-header部分"><a href="#post-header部分" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>table_id</td>
<td>6字节</td>
<td>操作的表的table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2字节</td>
<td>目前版本没有用，都是0，保留给之后的版本使用</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分"><a href="#event-body部分" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>database_name</td>
<td>1个字节表示字符串长度，之后接一个null-terminated类型的字符串</td>
<td></td>
<td>操作的数据库的名称</td>
</tr>
<tr>
<td>table_name</td>
<td>1个字节表示字符串长度，之后接一个null-terminated类型的字符串</td>
<td>操作的表的名称</td>
</tr>
<tr>
<td>column_count</td>
<td>packed integer(1或3或4或9个字节)</td>
<td>对应表中的字段数量</td>
</tr>
<tr>
<td>column_type</td>
<td>每个字段占用一个字节，字段类型定义在enum_field_types中</td>
<td>字段类型</td>
</tr>
<tr>
<td>metadata_length</td>
<td>packed integer(1或3或4或9个字节)</td>
<td>对应字段的元数据信息的长度</td>
</tr>
<tr>
<td>metadata</td>
<td>根据enum_field_type中的定义确定不同字段的元数据，如果某字段类型没有元数据，则不记录</td>
<td>每个字段的元数据信息，比如varchar字段需要记录最长长度</td>
</tr>
<tr>
<td>null_bits</td>
<td>int((column_count + 7)/8) 字节</td>
<td>一个bit表示一个字段是否可以为NULL，顺序是：第一个字节的最低位开始向最高位增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>check_sum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例"><a href="#字节解析示例" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test1` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<p>二进制内容解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">6c 00 00 00 00 00 //table_id :小端存储，16进制转换为10进制为108</span><br><span class="line">01 00 //flag :</span><br><span class="line">08 67 61 6e 67 73 68 65 6e 00 //database_name :1个字节是字符串长度，后接一个null-terminated string 第一个字节表示字符串长度为8，后面内容将16进制转换为ascii字符为gangshen</span><br><span class="line">05 74 65 73 74 31 00 //table_name: 1个字节是字符串长度，后接一个null-terminated string第一个字节表示字符串长度为5，后面内容将16进制转换为ascii字符为test1</span><br><span class="line">02 //columns count :packet integer类型，转换之后，数值为2 表示表中有两个字段</span><br><span class="line">03 0f //column type : 一个字节表示一个字段的类型，字段类型定义在enum enum_field_types ，分别是一个int类型以及一个varchar类型,具体的字段类型及记录格式等信息可以查看《MySQL中Rows_event中字段表示》文档</span><br><span class="line">02 //metadata length : packet integer类型,转换之后，数值为2，表示记录表中的metadata内容占用2个字节</span><br><span class="line">14 00 // :varchar 的max length 因为int没有metadata所以跳过</span><br><span class="line">02 //null_bits :int((column_count + 7) / 8)个字节 一个bit表示一个字段是否可以为null </span><br><span class="line">52 53 4a d9 checksum</span><br></pre></td></tr></table></figure>
<h2 id="Write-rows-log-event"><a href="#Write-rows-log-event" class="headerlink" title="Write_rows_log_event"></a>Write_rows_log_event</h2><p>在以ROW格式记录的binlog文件中，Write_rows_log_event记录了插入的行记录。</p>
<h3 id="post-header部分-1"><a href="#post-header部分-1" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>table_id</td>
<td>6字节</td>
<td>操作的表的table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2字节</td>
<td>目前版本没有用，都是0，保留给之后的版本使用</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-1"><a href="#event-body部分-1" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>var_header</td>
<td>2字节</td>
<td></td>
</tr>
<tr>
<td>m_width</td>
<td>packed integer(1或3或4或9个字节)</td>
<td>表中字段数量</td>
</tr>
<tr>
<td>before_image</td>
<td>(m_width + 7)/8字节</td>
<td></td>
</tr>
<tr>
<td>after_bitmap_bits</td>
<td>(m_with +7)/8字节</td>
<td>字段值是否为空标记，一个bit表示一个字段是否为NULL，顺序是：第一个字节的最低位开始向最高位增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>after_column_content</td>
<td>不定</td>
<td>按照顺序每个字段的内容</td>
</tr>
<tr>
<td>check_sum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-1"><a href="#字节解析示例-1" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `int_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` tinyint(1) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<p>插入数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into int_table values(1,11,111,1111,11111,true);</span><br></pre></td></tr></table></figure>
<p>对应Write_rows_log_event使用mysqlbinlog解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># at 340</span><br><span class="line">#180103 10:21:20 server id 330619  end_log_pos 395 CRC32 0x50177e10    Write_rows: table id 100 flags: STMT_END_F</span><br><span class="line">### INSERT INTO `gangshen`.`int_table`</span><br><span class="line">### SET</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=11 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=111 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line"># at 395</span><br></pre></td></tr></table></figure>
<p>解析二进制文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">64 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为100</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">06 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff //before image: (m_width + 7) / 8字节</span><br><span class="line">c0 //after_bitmap_bits :insert插入之后的记录的NULL标记，表中六个字段，插入的值都不为NULL</span><br><span class="line">//after_columns_content：insert插入记录之后的记录值</span><br><span class="line">01 </span><br><span class="line">0b 00 </span><br><span class="line">6f 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00</span><br><span class="line">01 </span><br><span class="line">10 7e 17 50 //checksum</span><br></pre></td></tr></table></figure>
<h2 id="Update-rows-log-event"><a href="#Update-rows-log-event" class="headerlink" title="Update_rows_log_event"></a>Update_rows_log_event</h2><p>在以ROW格式记录的binlog文件中，Update_rows_log_event记录了更新的行记录。</p>
<h3 id="post-header部分-2"><a href="#post-header部分-2" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>table_id</td>
<td>6字节</td>
<td>操作的表的table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2字节</td>
<td>目前版本没有用，都是0，保留给之后的版本使用</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-2"><a href="#event-body部分-2" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>var_header</td>
<td>2字节</td>
<td></td>
</tr>
<tr>
<td>m_width</td>
<td>packed integer(1或3或4或9个字节)</td>
<td>表中字段数量</td>
</tr>
<tr>
<td>before_image</td>
<td>(m_with+7)/8字节</td>
<td></td>
</tr>
<tr>
<td>after_image</td>
<td>(m_with+7)/8字节</td>
<td></td>
</tr>
<tr>
<td>before_bitmap_bits</td>
<td>(m_with+7)/8字节</td>
<td>before_bitmap_bits记录的是update更改之前的记录中，字段值是否为NULL标记，一个bit表示一个字段是否为NULL，顺序是：第一个字节的最低位开始向最高位开始增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>before_column_content</td>
<td>不定</td>
<td>update更新之前的记录值，按照顺序每个字段的内容</td>
</tr>
<tr>
<td>after_bitmap_bits</td>
<td>(m_with+7)/8字节</td>
<td>after_bitmap_bits记录的是update更改之前的记录中，字段值是否为NULL标记，一个bit表示一个字段是否为NULL，顺序是：第一个字节的最低位开始向最高位开始增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>after_column_content</td>
<td>不定</td>
<td>update更新之后的记录值，按照顺序每个字段的内容</td>
</tr>
<tr>
<td>check_sum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-2"><a href="#字节解析示例-2" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `int_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` tinyint(1) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<p>插入数据并更新:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 10:20:49&gt; insert into int_table values(1,11,111,1111,11111,true);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 10:21:20&gt; update int_table set col2=22,col3=222 where col1=1;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 10:21:44&gt; select * from int_table;</span><br><span class="line">+------+------+------+------+-------+------+</span><br><span class="line">| col1 | col2 | col3 | col4 | col5  | col6 |</span><br><span class="line">+------+------+------+------+-------+------+</span><br><span class="line">|    1 |  22 |  222 | 1111 | 11111 |    1 |</span><br><span class="line">+------+------+------+------+-------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>对应Update_rows_log_event使用mysqlbinlog解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># at 644</span><br><span class="line">#180103 10:41:37 server id 9999  end_log_pos 720 CRC32 0x5576b52f    Update_rows: table id 231 flags: STMT_END_F</span><br><span class="line">### UPDATE `gangshen`.`int_table`</span><br><span class="line">### WHERE</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=11 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=111 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">### SET</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=22 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=222 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line"># at 720</span><br></pre></td></tr></table></figure>
<p>解析二进制文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">64 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为100</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">06 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff //before image: (m_width + 7) / 8字节</span><br><span class="line">ff //after image: (m_width + 7) / 8字节</span><br><span class="line">c0 //before_bitmap_bits :update更新之前记录中NULL标记，表中六个字段，值都不为NULL</span><br><span class="line">//before_column_content接下来是update更新之前记录的值</span><br><span class="line">01 </span><br><span class="line">0b 00</span><br><span class="line">6f 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00</span><br><span class="line">01 </span><br><span class="line">c0 //after_bitmap_bits :update更新之后记录中NULL标记，表中六个字段，值都不为NULL</span><br><span class="line">//after_column_content接下来是update更新之前记录的值</span><br><span class="line">01 </span><br><span class="line">16 00 </span><br><span class="line">de 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00 </span><br><span class="line">01 </span><br><span class="line">16 a3 de bb //checksum</span><br></pre></td></tr></table></figure>
<h2 id="Delete-rows-log-event"><a href="#Delete-rows-log-event" class="headerlink" title="Delete_rows_log_event"></a>Delete_rows_log_event</h2><p>在以ROW格式记录的binlog文件中，Delete_rows_log_event记录了删除的行记录。</p>
<h3 id="post-header部分-3"><a href="#post-header部分-3" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>table_id</td>
<td>6字节</td>
<td>操作的表的table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2字节</td>
<td>目前版本没有用，都是0，保留给之后的版本使用</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-3"><a href="#event-body部分-3" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>var_header</td>
<td>2字节</td>
<td></td>
</tr>
<tr>
<td>m_width</td>
<td>packed integer(1或3或4或9个字节)</td>
<td>表中字段数量</td>
</tr>
<tr>
<td>after_image</td>
<td>(m_width + 7)/8字节</td>
<td></td>
</tr>
<tr>
<td>before_bitmap_bits</td>
<td>(m_with+7)/8字节</td>
<td>before_bitmap_bits记录的是update更改之前的记录中，字段值是否为NULL标记，一个bit表示一个字段是否为NULL，顺序是：第一个字节的最低位开始向最高位开始增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>before_column_content</td>
<td>不定</td>
<td>delete删除之前的记录值，按照顺序每个字段的内容</td>
</tr>
<tr>
<td>check_sum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-3"><a href="#字节解析示例-3" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `int_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` tinyint(1) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<p>删除数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from int_table where col1=1;</span><br></pre></td></tr></table></figure>
<p>对应Delete_rows_log_event使用mysqlbinlog解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># at 320</span><br><span class="line">#180103 14:24:54 server id 330619  end_log_pos 375 CRC32 0xce4818b2    Delete_rows: table id 100 flags: STMT_END_F</span><br><span class="line">### DELETE FROM `gangshen`.`int_table`</span><br><span class="line">### WHERE</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=22 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=222 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line"># at 375</span><br></pre></td></tr></table></figure>
<p>解析二进制文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">64 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为100</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">06 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff //after image: (m_width + 7) / 8字节</span><br><span class="line">c0 //before_bitmap_bits :delete删除之前的记录的NULL标记，表中六个字段，值都不为NULL</span><br><span class="line">//before_columns_content：delete删除记录之前的记录值</span><br><span class="line">01 </span><br><span class="line">16 00 </span><br><span class="line">de 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00</span><br><span class="line">01 </span><br><span class="line">10 7e 17 50 //checksum</span><br></pre></td></tr></table></figure>
<h2 id="Xid-event"><a href="#Xid-event" class="headerlink" title="Xid_event"></a>Xid_event</h2><p>表示支持内部XA的存储引擎上的事务提交。正常的事务是通过<code>QUERY_EVENT</code>来发送一个<code>BEGIN</code>语句并且通过<code>QUERY_EVENT</code>来发送一个<code>COMMIT</code>语句（如果事务回滚则发送的是<code>ROLLBACK</code>）实现。</p>
<h3 id="post-header部分-4"><a href="#post-header部分-4" class="headerlink" title="post-header部分"></a>post-header部分</h3><p>无</p>
<h3 id="event-body部分-4"><a href="#event-body部分-4" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>xid</td>
<td>8字节</td>
<td>xid号，小端存储，无符号数</td>
</tr>
<tr>
<td>check_sum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-4"><a href="#字节解析示例-4" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用mysqlbinlog工具解析对应的Xid_event</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 1691</span><br><span class="line">#180103 15:30:45 server id 330619  end_log_pos 1722 CRC32 0x8816181c    Xid = 2698</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 1722</span><br></pre></td></tr></table></figure>
<p>解析二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略...</span><br><span class="line">8a 0a 00 00 00 00 00 00 //xid,因为是小端存储，所以实际为0x 00 00 00 00 00 00 0a 8a，转换为10进制为2698</span><br><span class="line">1c 18 16 88 //check_sum</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(五)——MySQL常见binlog event解析（上）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(五)——MySQL常见binlog event解析（上）/" class="post-title-link" itemprop="url">MySQL Binlog(五)——MySQL常见binlog event解析（上）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:42:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:42:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-五-——MySQL常见binlog-event解析（上）"><a href="#MySQL-Binlog-五-——MySQL常见binlog-event解析（上）" class="headerlink" title="MySQL Binlog(五)——MySQL常见binlog event解析（上）"></a>MySQL Binlog(五)——MySQL常见binlog event解析（上）</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面讲了binlog event的基础知识，从这篇文章开始我们就具体来解析binlog中常见的event，了解其具体代表的意义。本文会介绍Format_description_event、Rotate_event、Query_log_event、Rows_query_log_event几种event。</p>
<h2 id="Format-description-event"><a href="#Format-description-event" class="headerlink" title="Format_description_event"></a>Format_description_event</h2><p>Format_description_event是每个binlog文件开头的一个描述信心的event。</p>
<h3 id="post-header部分"><a href="#post-header部分" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>binlog_version</td>
<td>2字节</td>
<td>binlog结构的版本,v1,v2,v4</td>
</tr>
<tr>
<td>server_version</td>
<td>50字节</td>
<td>MySQL server的数据库版本</td>
</tr>
<tr>
<td>timestamp</td>
<td>4字节</td>
<td>创建该binlog文件的时间,单位为秒</td>
</tr>
<tr>
<td>header_length</td>
<td>1字节</td>
<td>指定公共头部的长度，v4版本中这个值一直为19，说明其他所有的event的extra_header部分都是空,extra_header长度为header_length-19</td>
</tr>
<tr>
<td>event_post_header_length</td>
<td>variable size，跟各个版本支持的event类型总数一致</td>
<td>每个event类型，占用一个字节，表示该event类型post-header部分的长度</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分"><a href="#event-body部分" class="headerlink" title="event-body部分"></a>event-body部分</h3><p>无</p>
<h3 id="字节解析示例"><a href="#字节解析示例" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">04 00 //binlog_version :v4版本</span><br><span class="line">35 2e 36 2e 33 34 2d 6c 6f 67 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00  //mysql server version :16进制转换为ascii之后，值为5.6.34-log</span><br><span class="line">00 00 00 00 //timestamp:</span><br><span class="line">13 //header length :19,说明该版本的event类型公共头部长度都为19，extra_header长度为header_length-19</span><br><span class="line">38 0d 00 08 00 12 00 04 04 04 </span><br><span class="line">04 12 00 00 5c 00 04 1a 08 00 </span><br><span class="line">00 00 08 08 08 02 00 00 00 0a </span><br><span class="line">0a 0a 19 19 00 //event_post_header_len:各个类型event的post-header部分长度</span><br><span class="line">01 2e ef 23 e2</span><br></pre></td></tr></table></figure>
<h2 id="Rotate-event"><a href="#Rotate-event" class="headerlink" title="Rotate_event"></a>Rotate_event</h2><p>当MySQL切换至新的binlog文件的时候，MySQL会在旧的binlog文件中写入一个ROTATE_EVENT，其内容包含新的binlog文件的文件名以及第一个偏移地址。当在数据库中执行<code>FLUSH LOGS</code>语句或者binlog文件的大小超过max_binlog_size参数设定的值就会切换新的binlog文件。</p>
<h3 id="post-header部分-1"><a href="#post-header部分-1" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>next_binlog_po</td>
<td>8字节</td>
<td>下一个binlog文件起始的偏移地址</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-1"><a href="#event-body部分-1" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>next_binlog_filename</td>
<td>variable string</td>
<td>下一个binlog文件的文件名</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-1"><a href="#字节解析示例-1" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">04 00 00 00 00 00 00 00 //next_binlog_pos：下一个binlog的起始偏移地址,小端存储，16进制转换为10进制之后为4</span><br><span class="line">6d 79 73 71 6c 2d 62 69 6e 2e 30 30 30 30 30 32  //next_binlog_filename：下一个binlog的文件名,16进制转换为ascii之后，值为mysql-bin.000002</span><br><span class="line">b3 db 0b 9a checksum</span><br></pre></td></tr></table></figure>
<h2 id="Query-log-event"><a href="#Query-log-event" class="headerlink" title="Query_log_event"></a>Query_log_event</h2><p>记录更新操作的语句。</p>
<h3 id="post-header部分-2"><a href="#post-header部分-2" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>thread_id</td>
<td>4字节</td>
<td>小端存储，执行语句的线程ID号</td>
</tr>
<tr>
<td>exec_time</td>
<td>4字节</td>
<td>小端存储，语句执行的时间</td>
</tr>
<tr>
<td>db_len</td>
<td>1字节</td>
<td>database名的长度</td>
</tr>
<tr>
<td>error_code</td>
<td>2字节</td>
<td>错误号</td>
</tr>
<tr>
<td>status_vars_len</td>
<td>2字节</td>
<td>小端存储，这部分，在v1和v3版本的event中是没有的，指定状态值的长度</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-2"><a href="#event-body部分-2" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>status_vars</td>
<td>status_vars_len字节</td>
<td>记录状态值，具体的解析见下表</td>
</tr>
<tr>
<td>database_name</td>
<td>db_len+1字节</td>
<td>null-terminaled类型的字符串，记录database的名字</td>
</tr>
<tr>
<td>query_statement</td>
<td>不定</td>
<td>执行的语句</td>
</tr>
<tr>
<td>check_sum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<p>status_vars的解析是，一个字节表示状态的类型，在类型之后按照类型不同紧接着不同字节数的状态值，状态的类型一共有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">enum Query_event_status_vars</span><br><span class="line">  &#123;</span><br><span class="line">    Q_FLAGS2_CODE= 0,</span><br><span class="line">    Q_SQL_MODE_CODE,</span><br><span class="line">    Q_CATALOG_CODE,</span><br><span class="line">    Q_AUTO_INCREMENT,</span><br><span class="line">    Q_CHARSET_CODE,</span><br><span class="line">    Q_TIME_ZONE_CODE,</span><br><span class="line">    Q_CATALOG_NZ_CODE,</span><br><span class="line">    Q_LC_TIME_NAMES_CODE,</span><br><span class="line">    Q_CHARSET_DATABASE_CODE,</span><br><span class="line">    Q_TABLE_MAP_FOR_UPDATE_CODE,</span><br><span class="line">    Q_MASTER_DATA_WRITTEN_CODE,</span><br><span class="line">    Q_INVOKER,</span><br><span class="line">    Q_UPDATED_DB_NAMES,</span><br><span class="line">    Q_MICROSECONDS,</span><br><span class="line">    Q_COMMIT_TS,</span><br><span class="line">    Q_COMMIT_TS2,</span><br><span class="line">    Q_EXPLICIT_DEFAULTS_FOR_TIMESTAMP</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>不同状态对应的状态值的字节数 </p>
<table>
<thead>
<tr>
<th>状态</th>
<th>对用的code</th>
<th>状态值占用的字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Q_FLAGS2_CODE</td>
<td>0</td>
<td>4字节</td>
</tr>
<tr>
<td>Q_SQL_MODE_CODE</td>
<td>1</td>
<td>8字节</td>
</tr>
<tr>
<td>Q_CATALOG_CODE</td>
<td>2</td>
<td>第一个字节表示catalog_len，总共catalog_len+2个字节</td>
</tr>
<tr>
<td>Q_AUTO_INCREMENT</td>
<td>3</td>
<td>4字节</td>
</tr>
<tr>
<td>Q_CHARSET_CODE</td>
<td>4</td>
<td>6字节</td>
</tr>
<tr>
<td>Q_TIME_ZONE_CODE</td>
<td>5</td>
<td>第一个字节表示time_zone_len，总共time_zone_len+1字节</td>
</tr>
<tr>
<td>Q_CATALOG_NZ_CODE</td>
<td>6</td>
<td>第一个字节表示catalog_len，总共catalog_len+1个字节</td>
</tr>
<tr>
<td>Q_LC_TIME_NAMES_CODE</td>
<td>7</td>
<td>2字节</td>
</tr>
<tr>
<td>Q_CHARSET_DATABASE_CODE</td>
<td>8</td>
<td>2字节</td>
</tr>
<tr>
<td>Q_TABLE_MAP_FOR_UPDATE_CODE</td>
<td>9</td>
<td>8字节</td>
</tr>
<tr>
<td>Q_MASTER_DATA_WRITTEN_CODE</td>
<td>10</td>
<td>4字节</td>
</tr>
<tr>
<td>Q_INVOKER</td>
<td>11</td>
<td>包含两部分，一部分是user，一部分是host。user部分，一个字节表示user_len，接着user_len个字节表示user。host部分，一个字节表示host_len，接着host_len个字节表示host。</td>
</tr>
<tr>
<td>Q_UPDATED_DB_NAMES</td>
<td>12</td>
<td></td>
</tr>
<tr>
<td>Q_MICROSECONDS</td>
<td>13</td>
<td>3字节</td>
</tr>
<tr>
<td>Q_COMMIT_TS</td>
<td>14</td>
<td></td>
</tr>
<tr>
<td>Q_COMMIT_TS2</td>
<td>15</td>
<td></td>
</tr>
<tr>
<td>Q_EXPLICIT_DEFAULTS_FOR_TIMESTAMP</td>
<td>16</td>
<td>1字节</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-2"><a href="#字节解析示例-2" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>执行语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">insert into test1(`name`) values(&apos;beijing&apos;);</span><br><span class="line"></span><br><span class="line">root@localhost : (none) 06:07:04&gt; show binlog events  in &apos;mysql-bin.000012&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000012 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4                      |</span><br><span class="line">| mysql-bin.000012 | 120 | Query      |    330619 |        212 | BEGIN                                                      |</span><br><span class="line">| mysql-bin.000012 | 212 | Intvar      |    330619 |        244 | INSERT_ID=28                                                |</span><br><span class="line">| mysql-bin.000012 | 244 | Query      |    330619 |        374 | use `gangshen`; insert into test1(`name`) values(&apos;beijing&apos;) |</span><br><span class="line">| mysql-bin.000012 | 374 | Xid        |    330619 |        405 | COMMIT /* xid=2961 */                                      |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-------------------------------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>使用mysqlbinlog工具解析binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># at 244</span><br><span class="line">#180105 15:20:29 server id 330619  end_log_pos 244 CRC32 0xf41b5eaa    Intvar</span><br><span class="line">SET INSERT_ID=28/*!*/;</span><br><span class="line">#180105 15:20:29 server id 330619  end_log_pos 374 CRC32 0x98379221    Query    thread_id=106404    exec_time=0    error_code=0</span><br><span class="line">use `gangshen`/*!*/;</span><br><span class="line">SET TIMESTAMP=1515183629/*!*/;</span><br><span class="line">insert into test1(`name`) values(&apos;beijing&apos;)</span><br><span class="line">/*!*/;</span><br><span class="line"># at 374</span><br></pre></td></tr></table></figure>
<p>解析二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。。</span><br><span class="line">a4 9f 01 00 //thread_id:执行语句的线程号，小端存储，转换为16进制为106404</span><br><span class="line">00 00 00 00 //exec_time:执行语句的时间，小端存储，转化为16进制为0</span><br><span class="line">08 //db_len:database name的长度，转换为10进制为8</span><br><span class="line">00 00 //error_code:错误号，小端存储，转换为10进制为0</span><br><span class="line">2a 00 //status_vars_len:状态值的长度，小端存储，转换为10进制为42，表示后续的42个字节为状态值的内容</span><br><span class="line">//status_vars_len</span><br><span class="line">00 00 00 00 00 </span><br><span class="line">01 00 00 20 40 00 00 00 00</span><br><span class="line">06 03 73 74 64 </span><br><span class="line">03 02 00 02 00</span><br><span class="line">04 21 00 21 00 53 00 </span><br><span class="line">0c 01 67 61 6e 67 73 68 65 6e 00 </span><br><span class="line">67 61 6e 67 73 68 65 6e 00 //database_name:数据库名称，null-terminaled string类型 ，转换为字符串为gangshen</span><br><span class="line">696e7365727420696e746f20746573743128606e616d6560292076616c75657328276265696a696e672729 //query_statement:执行的语句，转换为字符串为:insert into test1(`name`) values(&apos;beijing&apos;)</span><br><span class="line">21 92 37 98//checksum</span><br></pre></td></tr></table></figure>
<h2 id="Rows-query-log-event"><a href="#Rows-query-log-event" class="headerlink" title="Rows_query_log_event"></a>Rows_query_log_event</h2><p>在row格式复制模式下，将query以语句形式记录。在5.6.2版本之后，可以通过设置<code>binlog_rows_query_log_events</code>参数来控制在row格式复制模式下是否需要将query语句记录到binlog文件中。</p>
<h3 id="post-header部分-3"><a href="#post-header部分-3" class="headerlink" title="post-header部分"></a>post-header部分</h3><p>无</p>
<h3 id="event-body部分-3"><a href="#event-body部分-3" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>str_len</td>
<td>1字节</td>
<td>记录语句长度</td>
</tr>
<tr>
<td>statement</td>
<td>str_len字节</td>
<td>对应的语句</td>
</tr>
<tr>
<td>checksum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-3"><a href="#字节解析示例-3" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>执行语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 09:11:56&gt; insert into test1(`name`) values(&apos;rows_query&apos;);</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:12:06&gt; show binlog events in &apos;mysql-bin.000014&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------+</span><br><span class="line">| mysql-bin.000014 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4            |</span><br><span class="line">| mysql-bin.000014 | 120 | Query      |    330619 |        201 | BEGIN                                            |</span><br><span class="line">| mysql-bin.000014 | 201 | Rows_query  |    330619 |        271 | # insert into test1(`name`) values(&apos;rows_query&apos;) |</span><br><span class="line">| mysql-bin.000014 | 271 | Table_map  |    330619 |        326 | table_id: 98 (gangshen.test1)                    |</span><br><span class="line">| mysql-bin.000014 | 326 | Write_rows  |    330619 |        377 | table_id: 98 flags: STMT_END_F                  |</span><br><span class="line">| mysql-bin.000014 | 377 | Xid        |    330619 |        408 | COMMIT /* xid=3032 */                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>使用mysqlbinlog工具解析binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 201</span><br><span class="line">#180108  9:12:06 server id 330619  end_log_pos 271 CRC32 0xdc68af8a    Rows_query</span><br><span class="line"># insert into test1(`name`) values(&apos;rows_query&apos;)</span><br><span class="line"># at 271</span><br></pre></td></tr></table></figure>
<p>解析二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">2e //str_len:执行语句的长度，转换为10进制为46</span><br><span class="line">696e7365727420696e746f20746573743128606e616d6560292076616c7565732827726f77735f71756572792729  //statement:执行的语句，转换为ascii为insert into test1(`name`) values(&apos;rows_query&apos;)</span><br><span class="line">8a af 68 dc //check_sum</span><br></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://dev.mysql.com/doc/internals/en/event-meanings.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/internals/en/event-meanings.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(四)——MySQL binlog event解析——基础知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(四)——MySQL binlog event解析——基础知识/" class="post-title-link" itemprop="url">MySQL Binlog(四)—— MySQL binlog event解析——基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:41:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:41:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-四-——-MySQL-binlog-event解析——基础知识"><a href="#MySQL-Binlog-四-——-MySQL-binlog-event解析——基础知识" class="headerlink" title="MySQL Binlog(四)—— MySQL binlog event解析——基础知识"></a>MySQL Binlog(四)—— MySQL binlog event解析——基础知识</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL复制实质上就是讲binlog同步到从库上进行应用，前面的文章已经讲了如何建立复制连接，从这篇文章开始，我们来讲讲binlog里面的内容，看看主从之间同步具体同步了哪些内容，首先会介绍一些关于binlog event的基础知识，之后的文章中会详细对binlog event进行分析。</p>
<h2 id="event基础知识"><a href="#event基础知识" class="headerlink" title="event基础知识"></a>event基础知识</h2><h3 id="event类型"><a href="#event类型" class="headerlink" title="event类型"></a>event类型</h3><p>5.6.34版本的MySQL的event类型有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">enum Log_event_type</span><br><span class="line">&#123; UNKNOWN_EVENT= 0,</span><br><span class="line">  START_EVENT_V3= 1,</span><br><span class="line">  QUERY_EVENT= 2,</span><br><span class="line">  STOP_EVENT= 3,</span><br><span class="line">  ROTATE_EVENT= 4,</span><br><span class="line">  INTVAR_EVENT= 5,</span><br><span class="line">  LOAD_EVENT= 6,</span><br><span class="line">  SLAVE_EVENT= 7,  </span><br><span class="line">  CREATE_FILE_EVENT= 8,</span><br><span class="line">  APPEND_BLOCK_EVENT= 9,</span><br><span class="line">  EXEC_LOAD_EVENT= 10,</span><br><span class="line">  DELETE_FILE_EVENT= 11,</span><br><span class="line">  NEW_LOAD_EVENT= 12,</span><br><span class="line">  RAND_EVENT= 13,</span><br><span class="line">  USER_VAR_EVENT= 14,</span><br><span class="line">  FORMAT_DESCRIPTION_EVENT= 15,</span><br><span class="line">  XID_EVENT= 16,</span><br><span class="line">  BEGIN_LOAD_QUERY_EVENT= 17,</span><br><span class="line">  EXECUTE_LOAD_QUERY_EVENT= 18,</span><br><span class="line">  TABLE_MAP_EVENT = 19,</span><br><span class="line">  PRE_GA_WRITE_ROWS_EVENT = 20,</span><br><span class="line">  PRE_GA_UPDATE_ROWS_EVENT = 21,</span><br><span class="line">  PRE_GA_DELETE_ROWS_EVENT = 22,</span><br><span class="line">  WRITE_ROWS_EVENT_V1 = 23,</span><br><span class="line">  UPDATE_ROWS_EVENT_V1 = 24,</span><br><span class="line">  DELETE_ROWS_EVENT_V1 = 25,</span><br><span class="line">  INCIDENT_EVENT= 26,</span><br><span class="line">  HEARTBEAT_LOG_EVENT= 27,</span><br><span class="line">  IGNORABLE_LOG_EVENT= 28,</span><br><span class="line">  ROWS_QUERY_LOG_EVENT= 29,</span><br><span class="line">  WRITE_ROWS_EVENT = 30,</span><br><span class="line">  UPDATE_ROWS_EVENT = 31,</span><br><span class="line">  DELETE_ROWS_EVENT = 32,</span><br><span class="line">  GTID_LOG_EVENT= 33,</span><br><span class="line">  ANONYMOUS_GTID_LOG_EVENT= 34,</span><br><span class="line">  PREVIOUS_GTIDS_LOG_EVENT= 35,</span><br><span class="line">  ENUM_END_EVENT /* end marker */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="event类型含义"><a href="#event类型含义" class="headerlink" title="event类型含义"></a>event类型含义</h3><p>这边话介绍几个常见的event类型所对应的含义，对于不常见或者现在基本上已经不用了的event类型，这边不做过多的描述，想了解详细的内容，可以查看链接:<br><a href="https://dev.mysql.com/doc/internals/en/event-meanings.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/internals/en/event-meanings.html</a></p>
<ul>
<li>FORMAT_DESCRIPTION_EVENT</li>
</ul>
<p>FORMAT_DESCRIPTION_EVENT是每个binlog文件开头的一个event。</p>
<ul>
<li>ROTATE_EVENT</li>
</ul>
<p>当MySQL切换至新的binlog文件的时候，MySQL会在旧的binlog文件中写入一个ROTATE_EVENT，表示新的binlog文件的文件名，以及第一个偏移地址。当在数据库中执行<code>FLUSH LOGS</code>语句或者binlog文件的大小超过max_binlog_size就会切换新的binlog文件。 </p>
<ul>
<li>TABLE_MAP_EVENT</li>
</ul>
<p>TABLE_MAP_EVENT只有在binlog文件是以ROW格式记录的时候，才会使用。binlog中记录的每个更改的记录之前都会有一个对应要操作的表的TABLE_MAP_EVENT。TABLE_MAP_EVENT中记录了表的定义（包括database name,table name，字段定义），并且会将这个表的定义对应于一个数字，称为table_id。设计TABLE_MAP_EVENT类型event的目的是为了当主库和从库之间有不同的表定义的时候，复制仍能进行。如果一个事务中操作了多个表，多行记录，在binlog中会将对多行记录的操作event进行分组，每组行记录操作event前面会出现对应表的TABLE_MAP_EVENT。</p>
<ul>
<li>QUERY_EVENT</li>
</ul>
<p>记录更新操作的语句。</p>
<ul>
<li>WRITE_ROWS_EVENT</li>
</ul>
<p>在以ROW格式记录的binlog文件中，WRITE_ROWS_EVENT记录了插入的行记录。</p>
<ul>
<li>UPDATE_ROWS_EVENT</li>
</ul>
<p>在以ROW格式记录的binlog文件中，UPDATE_ROWS_EVENT记录了更新的行记录。</p>
<ul>
<li>DELETE_ROWS_EVENT</li>
</ul>
<p>在以ROW格式记录的binlog文件中，DELETE_ROWS_EVENT记录了删除的行记录。</p>
<h2 id="event字节解析"><a href="#event字节解析" class="headerlink" title="event字节解析"></a>event字节解析</h2><p>在MySQL的发展过程中，一共出现过三个版本的event结构：</p>
<ul>
<li>v1:在MySQL 3.23中使用</li>
<li>v2:在MySQL4.0.2至4.1中使用</li>
<li>v4:在MySQL5.0及以上版本中使用</li>
</ul>
<p>因为目前MySQL数据库版本基本上都是5.0版本以上的，所以本文就只介绍v4版本的event架构。</p>
<h3 id="event组织架构"><a href="#event组织架构" class="headerlink" title="event组织架构"></a>event组织架构</h3><p>v4版本的event主要由event header部分和post-header以及variable part部分组成。</p>
<ul>
<li>event header是每个event都会有的部分，并且每个event header的格式是相同的，固定为19个字节长度，在event header 中记录了event_length、type_code等信息，可以表示event的长度，event的类型，下一个event的偏移位置等信息，都可以再event header中获取到。</li>
<li>extra_headers指定了除公共头部外的内容，但是目前版本的binlog格式中，这一部分不存在的</li>
<li>fixed_part部分在某些文章中也被称做post-header,每个类型的event之间的post-header部分是不相同的，但是同一类型的event占用的post-header</li>
</ul>
<p>字节数是一样的。每个类型的event占用多少字节为post-header，这个定义在了Format_description_event中，下面讲Format_description_event的章节中会介绍。</p>
<ul>
<li>variable part是event真实记录具体信息的部分。</li>
</ul>
<p>event字节结构表示如下图：</p>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20191207183950.png" alt></p>
<p><code>x:y</code>中x表示该部分从多少字节偏移开始，y表示该部分占用多少字节。</p>
<ul>
<li>timestamp记录的是该事务记录的时间</li>
<li>type_code，记录的是该event的类型，具体的event类型，见上面的Log_event_type</li>
<li>server_id，记录的是执行该event的server的server_id号</li>
<li>event_length，该event的长度，共占多少字节</li>
<li>next_position，下一个event在binlog文件中的偏移位置</li>
<li>flag:标记</li>
<li>extra_headers，额外的头部内容，现在是空的，不存在</li>
<li>fixed part有些时候也被称作post-header</li>
<li>variable part有些时候也被称作payload或者body</li>
</ul>
<h3 id="event公共头部"><a href="#event公共头部" class="headerlink" title="event公共头部"></a>event公共头部</h3><p>从上述的event结构中，可以看到，每个event的header部分的内容结构是一致的，所有的event，都会记录这些信息，这是所有的event的公共头部。所以我们把这块内容单独拿出来讲。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>timestamp</td>
<td>4字节</td>
<td>时间戳</td>
</tr>
<tr>
<td>type_code</td>
<td>1字节</td>
<td>记录event类型</td>
</tr>
<tr>
<td>server_id</td>
<td>4 字节</td>
<td>记录event生成的MySQL所对应的server_id</td>
</tr>
<tr>
<td>event_length</td>
<td>4字节</td>
<td>这个event的字节长度，包括event header</td>
</tr>
<tr>
<td>next_position</td>
<td>4字节</td>
<td>下一个event在binlog文件中的偏移位置</td>
</tr>
<tr>
<td>flags</td>
<td>2字节</td>
</tr>
</tbody>
</table>
<p>示例:我们拿一个Write_rows_event的字节内容作为示例，解析event内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b6 1e 1c 5a //timestamp:小端存储，将16进制转换成10进制为1511792310，将时间戳转换为时间为2017-11-27 22:18:30</span><br><span class="line">1e //type_code:event类型，0x1e转换为10进制为30，查看Log_event_type中，看到30的为WRITE_ROWS_EVENT</span><br><span class="line">0f 27 00 00 //server_id :小端存储，将16进制转换为10进制为9999</span><br><span class="line">31 00 00 00 //event_length :小端存储，将16进制转换为10进制为49</span><br><span class="line">b1 03 00 00 //next_position:小端存储，将16进制转换为10进制为945</span><br><span class="line">00 00 //flags:</span><br><span class="line">body部分省略</span><br></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://dev.mysql.com/doc/internals/en/event-structure.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/internals/en/event-structure.html</a></li>
<li><a href="https://dev.mysql.com/doc/internals/en/event-meanings.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/internals/en/event-meanings.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/01/MySQL Binlog(三)——MySQL 复制流程详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/01/MySQL Binlog(三)——MySQL 复制流程详解/" class="post-title-link" itemprop="url">MySQL Binlog(三)——MySQL 复制流程详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-01 16:41:13" itemprop="dateCreated datePublished" datetime="2019-12-01T16:41:13+08:00">2019-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-三-——MySQL-复制流程详解"><a href="#MySQL-Binlog-三-——MySQL-复制流程详解" class="headerlink" title="MySQL Binlog(三)——MySQL 复制流程详解"></a>MySQL Binlog(三)——MySQL 复制流程详解</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇文章讲了MySQL协议的基础内容，在本文中我们通过分析MySQL复制流程看看MySQL协议在复制中的使用。</p>
<h2 id="MySQL复制流程概述"><a href="#MySQL复制流程概述" class="headerlink" title="MySQL复制流程概述"></a>MySQL复制流程概述</h2><p>按照复制原理中描述的，在备库上提交change master to请求主备数据连接以后</p>
<ol>
<li>TCP连接阶段：备库和主库之间会建立TCP链接（TCP/IP的三次握手建立连接过程不在本文讨论范畴，这里不详细描述）</li>
<li>用户认证阶段：主库会对备库的用户名密码进行认证，进行MySQL应用层的三次握手</li>
<li>register_slave注册slave阶段：备库通过register_slave将自己注册到主库上（该步骤可忽略），以便master在show slave host时可以查看到哪些slave连接上来了</li>
<li>request_dump请求binlog阶段：备库通过request_dump，请求从主库指定的二进制日志和文件偏移量开始获取所有的二进制日志。</li>
<li>master发送Binlog Event阶段：Master启动binlog dump线程，从指定的二进制日志的对应文件偏移量开始向备库的IO线程发送二进制日志Event。（该步骤在主库上就是读取文件和网络发送的过程，本文档中不详细描述）</li>
<li>备库接收存储Relaylog阶段：备库的IO线程持续接收Event并将Event存储relay log中。具体Event的存储格式以及各种类型的字段在Binlog Event的存储格式请参考后续文章。</li>
</ol>
<p>接下来的几节将详细对以上2，3，4步的网络协议字节格式、及可能取值等方面进行详细描述</p>
<h2 id="用户认证过程详解"><a href="#用户认证过程详解" class="headerlink" title="用户认证过程详解"></a>用户认证过程详解</h2><h3 id="用户认证时序图"><a href="#用户认证时序图" class="headerlink" title="用户认证时序图"></a>用户认证时序图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Master-&gt;Slave:Server Greeting 开始MySQL握手协议</span><br><span class="line">Slave-&gt;Master:Login Request 进行账号密码验证登陆</span><br><span class="line">Master-&gt;Slave:Response OK 账号密码验证通过</span><br></pre></td></tr></table></figure>
<p>如图所示，</p>
<ol>
<li>master先发送了greeting网络包；</li>
<li>slave接收到该网络包以后提交帐号密码进行验证；</li>
<li>master接收到用户名密码，验证通过后会通过Response OK 返回表示认证通过。</li>
</ol>
<blockquote>
<p>普通的客户端连接MySQL同样需要经历这三次握手协议。</p>
</blockquote>
<h3 id="异常情况"><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h3><ul>
<li>第1步如果slave没有接收到greeting网络包，在超时等待后会报错退出</li>
<li>第2步，如果master没有接收到slave提交的帐号密码，此时，可以在master数据库中看到类似于如下信息：</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20191201164105.png" alt></p>
<p>可以看到当前数据库中会有一个连接连上来，但是在User字段显示是的unauthenticated user，这就是表示连接已经建立，但是用户认证还没有完成。该线程的状态是Receiving from client，表示正在等待client发送用户认证的数据信息。超时等待后，master也会报错并中止对应的线程.</p>
<ul>
<li>第3步，如果master密码认证错误，会直接发送一个错误包，slave和Master都需要中止这个连接。</li>
</ul>
<p>接下来几节将详细描述用户认证时序图中1，2，3三个网络包的具体字节分段含义。</p>
<h3 id="Server-Greeting步骤"><a href="#Server-Greeting步骤" class="headerlink" title="Server Greeting步骤"></a>Server Greeting步骤</h3><h4 id="相关代码位置"><a href="#相关代码位置" class="headerlink" title="相关代码位置"></a>相关代码位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sql/rpl_slave.cc文件中的handle_slave_io() </span><br><span class="line">=&gt; sql/rpl_slave.cc文件中的safe_connect()函数 </span><br><span class="line">=&gt; sql/rpl_slave.cc文件中的connect_to_master()函数</span><br><span class="line">=&gt; sql-common/client.c文件中的CLI_MYSQL_REAL_CONNECT()函数part1</span><br></pre></td></tr></table></figure>
<h4 id="Greeting数据包格式"><a href="#Greeting数据包格式" class="headerlink" title="Greeting数据包格式"></a>Greeting数据包格式</h4><table>
<thead>
<tr>
<th>类型</th>
<th>名字</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>int<3></3></td>
<td>payload_length</td>
<td>数据包中有效信息的长度，不包括数据包头部4个字节的长度</td>
</tr>
<tr>
<td>int<1></1></td>
<td>sequence_id</td>
<td>数据包序列号</td>
</tr>
<tr>
<td>int<1></1></td>
<td>协议版本号</td>
<td>表示当前连接使用的协议版本</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>服务器版本信息</td>
<td>表示当前server端服务器版本</td>
</tr>
<tr>
<td>int<4></4></td>
<td>thread_id</td>
<td>表示当前连接，在server上的线程ID</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>scramble data part1</td>
<td>用于密码校验的随机数部分一</td>
</tr>
<tr>
<td>int<2></2></td>
<td></td>
<td>无意义</td>
</tr>
<tr>
<td>int<1></1></td>
<td>server_charset</td>
<td>服务器的字符集</td>
</tr>
<tr>
<td>int<2></2></td>
<td>server_status</td>
<td>服务器状态</td>
</tr>
<tr>
<td>int<2></2></td>
<td>server_capability</td>
<td>服务器权能标志</td>
</tr>
<tr>
<td>int<1></1></td>
<td>pkt_scramble_length</td>
<td></td>
</tr>
<tr>
<td>string[10]</td>
<td></td>
<td>无意义</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>scramble data part2</td>
<td>用于密码校验的随机数部分二</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>scramble plugin name</td>
<td>用于密码校验的插件名称</td>
</tr>
</tbody>
</table>
<h4 id="数据包解析示例"><a href="#数据包解析示例" class="headerlink" title="数据包解析示例"></a>数据包解析示例</h4><p>数据包示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">4e 00 00 数据包长度 //88</span><br><span class="line">00 数据包序号 //0</span><br><span class="line">0a 协议版本号//10</span><br><span class="line">35 2e 37 2e 31 39 2d 6c 6f 67 00 服务器版本信息 //5.7.19-log</span><br><span class="line">72 00 00 00 线程ID //114</span><br><span class="line">7e 1a 15 11 07 0a 7e 1c 00 scramble data part1</span><br><span class="line">ff f7 </span><br><span class="line">53 服务器字符集 //</span><br><span class="line">02 00 服务器状态</span><br><span class="line">ff 81 服务器权能标志</span><br><span class="line">15 pkt_scramble_length</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 无用</span><br><span class="line">0b 2c 62 79 75 7a 3d 01 61 25 6f 22 00 scramble data part2</span><br><span class="line">6d 79 73 71 6c 5f 6e 61 74 69 76 65 5f 70 61 73 73 77 6f 72 64 00 scramble插件名字 //mysql_native_password</span><br></pre></td></tr></table></figure>
<p>各分段含义解释：</p>
<ul>
<li>数据包长度：MySQL协议中固定格式，前三个字节表示数据包长度，这个长度不包括固定格式的4个字节</li>
<li>数据包序号：MySQL协议中固定格式，用一个字节表示数据包的序号</li>
<li>协议版本号：MySQL协议的版本序号</li>
<li>服务器版本信息：服务器的版本，这边为5.7.19-log</li>
<li>线程ID：表示master分配给该连接的线程的ID号，与show processlist中的thread id对应</li>
<li>scramble data part1:master 生成的随机数，用于加密密码</li>
<li>服务器字符集：表示master使用的字符集编码</li>
<li>服务器状态:表示服务器状态</li>
</ul>
<p>在/include/mysql_com.h定义了服务器的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#define SERVER_STATUS_IN_TRANS     1</span><br><span class="line">#define SERVER_STATUS_AUTOCOMMIT   2	/* Server in auto_commit mode */</span><br><span class="line">#define SERVER_MORE_RESULTS_EXISTS 8    /* Multi query - next query exists */</span><br><span class="line">#define SERVER_QUERY_NO_GOOD_INDEX_USED 16</span><br><span class="line">#define SERVER_QUERY_NO_INDEX_USED      32</span><br><span class="line">#define SERVER_STATUS_CURSOR_EXISTS 64</span><br><span class="line">#define SERVER_STATUS_LAST_ROW_SENT 128</span><br><span class="line">#define SERVER_STATUS_DB_DROPPED        256 /* A database was dropped */</span><br><span class="line">#define SERVER_STATUS_NO_BACKSLASH_ESCAPES 512</span><br><span class="line">#define SERVER_STATUS_METADATA_CHANGED 1024</span><br><span class="line">#define SERVER_QUERY_WAS_SLOW          2048</span><br><span class="line">#define SERVER_PS_OUT_PARAMS            4096</span><br><span class="line">#define SERVER_STATUS_IN_TRANS_READONLY 8192</span><br><span class="line">#define SERVER_SESSION_STATE_CHANGED (1UL &lt;&lt; 14)</span><br></pre></td></tr></table></figure>
<ul>
<li>服务器权能标志：用于与客户端协商协议方式</li>
</ul>
<p>在/include/mysql_com.h定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#define CLIENT_LONG_PASSWORD	1	/* new more secure passwords */</span><br><span class="line">#define CLIENT_FOUND_ROWS	2	/* Found instead of affected rows */</span><br><span class="line">#define CLIENT_LONG_FLAG	4	/* Get all column flags */</span><br><span class="line">#define CLIENT_CONNECT_WITH_DB	8	/* One can specify db on connect */</span><br><span class="line">#define CLIENT_NO_SCHEMA	16	/* Don&apos;t allow database.table.column */</span><br><span class="line">#define CLIENT_COMPRESS	32	/* Can use compression protocol */</span><br><span class="line">#define CLIENT_ODBC	64	/* Odbc client */</span><br><span class="line">#define CLIENT_LOCAL_FILES	128	/* Can use LOAD DATA LOCAL */</span><br><span class="line">#define CLIENT_IGNORE_SPACE	256	/* Ignore spaces before &apos;(&apos; */</span><br><span class="line">#define CLIENT_PROTOCOL_41	512	/* New 4.1 protocol */</span><br><span class="line">#define CLIENT_INTERACTIVE	1024	/* This is an interactive client */</span><br><span class="line">#define CLIENT_SSL              2048	/* Switch to SSL after handshake */</span><br><span class="line">#define CLIENT_IGNORE_SIGPIPE   4096    /* IGNORE sigpipes */</span><br><span class="line">#define CLIENT_TRANSACTIONS	8192	/* Client knows about transactions */</span><br><span class="line">#define CLIENT_RESERVED         16384   /* Old flag for 4.1 protocol  */</span><br><span class="line">#define CLIENT_RESERVED2        32768   /* Old flag for 4.1 authentication */</span><br><span class="line">#define CLIENT_MULTI_STATEMENTS (1UL &lt;&lt; 16) /* Enable/disable multi-stmt support */</span><br><span class="line">#define CLIENT_MULTI_RESULTS    (1UL &lt;&lt; 17) /* Enable/disable multi-results */</span><br><span class="line">#define CLIENT_PS_MULTI_RESULTS (1UL &lt;&lt; 18) /* Multi-results in PS-protocol */</span><br><span class="line">#define CLIENT_PLUGIN_AUTH  (1UL &lt;&lt; 19) /* Client supports plugin authentication */</span><br><span class="line">#define CLIENT_CONNECT_ATTRS (1UL &lt;&lt; 20) /* Client supports connection attributes */</span><br><span class="line">/* Enable authentication response packet to be larger than 255 bytes. */</span><br><span class="line">#define CLIENT_PLUGIN_AUTH_LENENC_CLIENT_DATA (1UL &lt;&lt; 21)</span><br><span class="line">/* Don&apos;t close the connection for a connection with expired password. */</span><br><span class="line">#define CLIENT_CAN_HANDLE_EXPIRED_PASSWORDS (1UL &lt;&lt; 22)</span><br><span class="line">/**</span><br><span class="line">  Capable of handling server state change information. Its a hint to the</span><br><span class="line">  server to include the state change information in Ok packet.</span><br><span class="line">*/</span><br><span class="line">#define CLIENT_SESSION_TRACK (1UL &lt;&lt; 23)</span><br><span class="line">/* Client no longer needs EOF packet */</span><br><span class="line">#define CLIENT_DEPRECATE_EOF (1UL &lt;&lt; 24)</span><br><span class="line">#define CLIENT_SSL_VERIFY_SERVER_CERT (1UL &lt;&lt; 30)</span><br><span class="line">#define CLIENT_REMEMBER_OPTIONS (1UL &lt;&lt; 31)</span><br></pre></td></tr></table></figure>
<ul>
<li>scramble data part2：与scramble data part1组成为随机数，用于加密密码</li>
<li>scramble插件名字：指定用于scramble data加密方式的插件,这边为native_mysql_password</li>
</ul>
<h3 id="Login-Request步骤"><a href="#Login-Request步骤" class="headerlink" title="Login Request步骤"></a>Login Request步骤</h3><p>本节主要描述slave发送的用户认证的数据包(slave-&gt;master)过程</p>
<h4 id="相关代码位置-1"><a href="#相关代码位置-1" class="headerlink" title="相关代码位置"></a>相关代码位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql/rpl_slave.cc文件中的handle_slave_io() </span><br><span class="line">=&gt; sql/rpl_slave.cc文件中的safe_connect()函数 </span><br><span class="line">=&gt; sql/rpl_slave.cc文件中的connect_to_master()函数</span><br><span class="line">=&gt; sql-common/client.c文件中的CLI_MYSQL_REAL_CONNECT()函数</span><br><span class="line">=&gt; sql-common/client.c文件中的run_plugin_auth()函数</span><br><span class="line">=&gt; sql-common/client.c文件中的native_password_auth_client()函数</span><br></pre></td></tr></table></figure>
<h4 id="数据包格式"><a href="#数据包格式" class="headerlink" title="数据包格式"></a>数据包格式</h4><table>
<thead>
<tr>
<th>类型</th>
<th>名字</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>int<3></3></td>
<td>payload_length</td>
<td>数据包中有效信息的长度，不包括数据包头部4个字节的长度</td>
</tr>
<tr>
<td>int<1></1></td>
<td>sequence_id</td>
<td>数据包序列号</td>
</tr>
<tr>
<td>int<4></4></td>
<td>client_flag</td>
<td>client的标记</td>
</tr>
<tr>
<td>int<4></4></td>
<td>max_packet_size</td>
<td>允许发送的最大数据包的大小</td>
</tr>
<tr>
<td>int<1></1></td>
<td>client_charset</td>
<td>client使用的字符集</td>
</tr>
<tr>
<td>string[23]</td>
<td></td>
<td>无用</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>user_name</td>
<td>登陆的用户名</td>
</tr>
<tr>
<td>int<1></1></td>
<td>client_capability</td>
<td></td>
</tr>
<tr>
<td>string[20]</td>
<td>加密后的scramble_data</td>
<td></td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>database_name</td>
<td>要连接的数据库的名称</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>scramble_plugin_name</td>
<td>用于密码校验的插件名称</td>
</tr>
</tbody>
</table>
<h4 id="数据包解析"><a href="#数据包解析" class="headerlink" title="数据包解析"></a>数据包解析</h4><p>数据包示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">58 00 00 数据包长度 //98</span><br><span class="line">01 数据包序号 //1</span><br><span class="line">0d a2 2b 00 client flag</span><br><span class="line">01 00 00 00 max_packet_size</span><br><span class="line">08 client使用的字符集编码 //latin1</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 无用</span><br><span class="line">71 62 65 6e 63 68 00 用户名 //qbench</span><br><span class="line">14 client权能标识</span><br><span class="line">f2 4c b6 e9 4c 0d d7 9d 07 30 c9 21 07 4f 23 51 09 a1 af 47 加密之后的scramble data</span><br><span class="line">6d 79 73 71 6c 00 连接的数据库 //mysql</span><br><span class="line">6d 79 73 71 6c 5f 6e 61 74 69 76 65 5f 70 61 73 73 77 6f 72 64 00 加密的插件名称 //mysql_native_password</span><br></pre></td></tr></table></figure>
<p>各分段数据含义：</p>
<ul>
<li>数据包长度：MySQL协议中固定格式，前三个字节表示数据包长度，这个长度不包括固定格式的4个字节</li>
<li>数据包序号：MySQL协议中固定格式，用一个字节表示数据包的序号</li>
<li>client flag ：指定客户端发送数据的一些规范，</li>
<li>max_packet_size:指定客户端发送数据包的最大值，</li>
<li>client使用的字符集编码：client所使用的字符集编码</li>
<li>用户名：用于用户登陆的用户名</li>
<li>client权能标识：client capability</li>
<li>加密之后的scramble data：将用于登陆的密码加密之后得到的结果</li>
</ul>
<p>参考淘宝内核月报关于native_mysql_password插件加密方式：</p>
<blockquote>
<p>client:<br>hash_stage1 = sha1(password) hash_stage2 = sha1(hash_stage1) reply = sha1(scramble, hash_stage2) ^ hash_stage1<br>server: (逻辑位于sql/password.c:check_scramble_sha1中, 下文亦有提及)<br>// mysql.user表中, 对应user的passwd实际上是hash_stage2 res1 = sha1(scramble, hash_stage2) hash_stage1 = reply ^ res1 hash_stage2_reassured = sha1(hash_stage1) 再根据hash_stage2_reassured == hash_stage2(from mysql.user)是否一致来判定是否合法</p>
</blockquote>
<ul>
<li>数据库名称：指定要连接的schema的名称</li>
<li>加密插件的名称：进行加密的插件的名称，这边为native_mysql_password</li>
</ul>
<h4 id="异常情况-1"><a href="#异常情况-1" class="headerlink" title="异常情况"></a>异常情况</h4><p>在用户认证过程中，master发送给slave一个Greeting包之后，slave发送一个auth包给master，因为我们是模拟IO线程的过程，所以这个auth包的内容是我们自己组织的，在发送将auth包发送给master进行用户认证的过程中，可能会出现一些异常情况，这样会导致master返回一个非OK包，这边列举可能出现的异常情况。</p>
<ul>
<li><p>slave发送的auth包中，用户名和密码错误<br>master会返回一个ERR包，ERR包中会包含‘ACCESS DENIED’的信息 1045号错误。</p>
</li>
<li><p>slave发送的auth包中，数据组织格式有问题<br>master会返回一个EOF包，并中断连接。</p>
</li>
</ul>
<h3 id="response-ok步骤详解"><a href="#response-ok步骤详解" class="headerlink" title="response ok步骤详解"></a>response ok步骤详解</h3><p>认证没有问题master将直接返回一个OK包。</p>
<h2 id="register-slave注册slave过程过程详解"><a href="#register-slave注册slave过程过程详解" class="headerlink" title="register_slave注册slave过程过程详解"></a>register_slave注册slave过程过程详解</h2><h3 id="register-slave-认证时序图"><a href="#register-slave-认证时序图" class="headerlink" title="register slave 认证时序图"></a>register slave 认证时序图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Slave-&gt;Master:Request Query 设置master_binlog_checksum（必须）</span><br><span class="line">Master-&gt;Slave:Response OK 请求执行成功</span><br><span class="line">Slave-&gt;Master:Request Query 设置slave_uuid（非必须）</span><br><span class="line">Master-&gt;Slave:Response OK 请求执行成功</span><br><span class="line">Slave-&gt;Master:Request Register Slave 发送register slave命令（非必须）</span><br><span class="line">Master-&gt;Slave:Response OK 注册slave成功</span><br></pre></td></tr></table></figure>
<p>如图所示，注册slave的过程如下</p>
<ol>
<li>slave客户端直接SET @master_binlog_checksum= @@global.binlog_checksum</li>
<li>设置正确，返回Ok Packet</li>
<li>设置其他相关配置，比如slave_uuid等</li>
<li>设置正确，返回Ok Packet</li>
<li>slave发送register_slave 注册slave请求</li>
<li>设置正确，返回Ok Packet</li>
</ol>
<blockquote>
<p>注册slave步骤主要是为了方便主库能获得slave的IP/Port等信息，第5步可忽略</p>
</blockquote>
<h3 id="异常情况-2"><a href="#异常情况-2" class="headerlink" title="异常情况"></a>异常情况</h3><ul>
<li>第1步，第3步如果设置的命令有误，Master将返回Error Packet。</li>
<li>第5步，如果填充的register_slave Packet包错误，Master同样将返回Error Packet</li>
</ul>
<p>接下来几节将详细描述上述第5步网络包的具体字节分段含义。</p>
<h3 id="Register-Slave-步骤"><a href="#Register-Slave-步骤" class="headerlink" title="Register Slave 步骤"></a>Register Slave 步骤</h3><h4 id="相关代码位置-2"><a href="#相关代码位置-2" class="headerlink" title="相关代码位置"></a>相关代码位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sql/rpl_slave.cc文件中的handle_slave_io()函数</span><br><span class="line">==&gt;sql/rpl_slave.cc文件中的register_slave_on_master()函数</span><br></pre></td></tr></table></figure>
<h4 id="数据包格式-1"><a href="#数据包格式-1" class="headerlink" title="数据包格式"></a>数据包格式</h4><table>
<thead>
<tr>
<th>类型</th>
<th>名字</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>int<3></3></td>
<td>payload_length</td>
<td>数据包中有效信息的长度，不包括数据包头部4个字节的长度</td>
</tr>
<tr>
<td>int<1></1></td>
<td>sequence_id</td>
<td>数据包序列号</td>
</tr>
<tr>
<td>int<1></1></td>
<td>command_type</td>
<td>发送的请求的类型</td>
</tr>
<tr>
<td>int<4></4></td>
<td>server_id</td>
<td>slave的server_id</td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>report_host</td>
<td></td>
</tr>
<tr>
<td>string&lt; null-terminated &gt;</td>
<td>report_user</td>
<td></td>
</tr>
<tr>
<td>string&lt; null-terninated &gt;</td>
<td>report_password</td>
<td></td>
</tr>
<tr>
<td>int<2></2></td>
<td>port</td>
<td>端口号</td>
</tr>
<tr>
<td>string[8]</td>
<td></td>
<td>无用</td>
</tr>
</tbody>
</table>
<h4 id="数据包解析-1"><a href="#数据包解析-1" class="headerlink" title="数据包解析"></a>数据包解析</h4><p>数据包示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">12 00 00 数据包长度</span><br><span class="line">00 数据包序号</span><br><span class="line">15 发送的command类型 0x15表示的是COM_REGISTER_SLAVE类型的命令</span><br><span class="line">0f 27 00 00 slave的server_id</span><br><span class="line">00 report host</span><br><span class="line">00 report user</span><br><span class="line">00 report password</span><br><span class="line">ea 0c 端口号</span><br><span class="line">00 00 00 00 00 00 00 00 无用</span><br></pre></td></tr></table></figure>
<p>各分段数据含义：</p>
<ul>
<li>数据包长度：MySQL协议中固定格式，前三个字节表示数据包长度，这个长度不包括固定格式的4个字节</li>
<li>数据包序号：MySQL协议中固定格式，用一个字节表示数据包的序号</li>
<li>COMMAND类型：表示发送的请求的类型</li>
</ul>
<p>在my_command.h文件中定义了command的类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">enum enum_server_command</span><br><span class="line">&#123;</span><br><span class="line">  COM_SLEEP,COM_QUIT,</span><br><span class="line">  COM_INIT_DB,</span><br><span class="line">  COM_QUERY,</span><br><span class="line">  COM_FIELD_LIST,</span><br><span class="line">  COM_CREATE_DB,</span><br><span class="line">  COM_DROP_DB,</span><br><span class="line">  COM_REFRESH,</span><br><span class="line">  COM_SHUTDOWN,</span><br><span class="line">  COM_STATISTICS,</span><br><span class="line">  COM_PROCESS_INFO,</span><br><span class="line">  COM_CONNECT,</span><br><span class="line">  COM_PROCESS_KILL,</span><br><span class="line">  COM_DEBUG,</span><br><span class="line">  COM_PING,</span><br><span class="line">  COM_TIME,</span><br><span class="line">  COM_DELAYED_INSERT,</span><br><span class="line">  COM_CHANGE_USER,</span><br><span class="line">  COM_BINLOG_DUMP,</span><br><span class="line">  COM_TABLE_DUMP,</span><br><span class="line">  COM_CONNECT_OUT,</span><br><span class="line">  COM_REGISTER_SLAVE,</span><br><span class="line">  COM_STMT_PREPARE,</span><br><span class="line">  COM_STMT_EXECUTE,</span><br><span class="line">  COM_STMT_SEND_LONG_DATA,</span><br><span class="line">  COM_STMT_CLOSE,</span><br><span class="line">  COM_STMT_RESET,</span><br><span class="line">  COM_SET_OPTION,</span><br><span class="line">  COM_STMT_FETCH,</span><br><span class="line">  COM_DAEMON,</span><br><span class="line">  COM_BINLOG_DUMP_GTID,</span><br><span class="line">  COM_RESET_CONNECTION,</span><br><span class="line">  COM_END</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>report host:指定report的IP地址</li>
<li>report user:指定report的user</li>
<li>report password：指定report的账户的密码</li>
<li>端口号：指定连接的端口号，等于change master to语句中的port选项</li>
</ul>
<h4 id="异常情况-3"><a href="#异常情况-3" class="headerlink" title="异常情况"></a>异常情况</h4><p>如果填充的register_slave Packet包错误，Master同样将返回Error Packet</p>
<h2 id="request-dump请求binlog过程详解"><a href="#request-dump请求binlog过程详解" class="headerlink" title="request dump请求binlog过程详解"></a>request dump请求binlog过程详解</h2><h3 id="request-dump-请求时序图"><a href="#request-dump-请求时序图" class="headerlink" title="request dump 请求时序图"></a>request dump 请求时序图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Slave-&gt;Master:Request Send Binlog 请求发送binlog</span><br><span class="line">Master-&gt;Slave:Rotate Event 主库发送一个Rotate Event内容</span><br><span class="line">Master-&gt;Slave:Format Description Event 主库发送一个Format Description Event内容</span><br><span class="line">Master-&gt;Slave:··················Binlog Event</span><br><span class="line">Master-&gt;Slave:··················Binlog Event</span><br><span class="line">Master-&gt;Slave:··················Binlog Event</span><br></pre></td></tr></table></figure>
<p>如图所示，请求binlog的过程如下</p>
<ol>
<li>slave客户端发送request dump请求，请求中包含binlog dump开始发送二进制文件名称和偏移量</li>
<li>master接收到请求，位置正确的话，会先发送Rotate Event表示接下来的二进制日志将从指定的二进制文件和偏移量开始发送</li>
<li>master紧接着会从指定的二进制文件头读取Format Description Event 并发送给slave，用于slave 确认各个event的header长度等信息。</li>
<li>master从二进制文件和偏移量开始读取二进制数据并通过网络发给Slave</li>
</ol>
<p>异常情况下：</p>
<ul>
<li>第1步，如果slave请求的二进制文件或者偏移量不正确，master将返回ERR Packet</li>
</ul>
<h3 id="Request-dump-步骤"><a href="#Request-dump-步骤" class="headerlink" title="Request dump 步骤"></a>Request dump 步骤</h3><h4 id="相关代码位置-3"><a href="#相关代码位置-3" class="headerlink" title="相关代码位置"></a>相关代码位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sql/rpl_slave.cc文件中的handle_slave_io()函数</span><br><span class="line">==&gt;sql/rpl_slave.cc文件中的request_dump()函数</span><br></pre></td></tr></table></figure>
<h4 id="数据包格式-2"><a href="#数据包格式-2" class="headerlink" title="数据包格式"></a>数据包格式</h4><table>
<thead>
<tr>
<th>类型</th>
<th>名字</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>int<3></3></td>
<td>payload_length</td>
<td>数据包中有效信息的长度，不包括数据包头部4个字节的长度</td>
</tr>
<tr>
<td>int<1></1></td>
<td>sequence_id</td>
<td>数据包序列号</td>
</tr>
<tr>
<td>int<1></1></td>
<td>command_type</td>
<td>发送的请求的类型</td>
</tr>
<tr>
<td>int<4></4></td>
<td>binlog_pos</td>
<td>请求的binlog位置点</td>
</tr>
<tr>
<td>int<2></2></td>
<td>binlog_flag</td>
<td></td>
</tr>
<tr>
<td>int<4></4></td>
<td>server_id</td>
<td>slave的server_id</td>
</tr>
<tr>
<td>string&lt; reset-of_packet &gt;</td>
<td>binlog_file_name</td>
<td>请求的binlog文件名</td>
</tr>
</tbody>
</table>
<h4 id="数据包解析-2"><a href="#数据包解析-2" class="headerlink" title="数据包解析"></a>数据包解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1b 00 00 数据包长度</span><br><span class="line">00 数据包序号</span><br><span class="line">12 发送的command类型 0x12表示的是COM_BINLOG_DUMP</span><br><span class="line">9a 00 00 00 binlog位置点</span><br><span class="line">00 00 binlog flag</span><br><span class="line">0f 27 00 00 slave_server_id</span><br><span class="line">6d 79 73 71 6c 2d 62 69 6e 2e 30 30 30 30 30 31binlog文件名</span><br></pre></td></tr></table></figure>
<ul>
<li>数据包长度：MySQL协议中固定格式，前三个字节表示数据包长度，这个长度不包括固定格式的4个字节</li>
<li>数据包序号：MySQL协议中固定格式，用一个字节表示数据包的序号</li>
<li>COMMAND类型：表示发送的请求的类型</li>
<li>binlog位置点：表示请求的binlog位置</li>
<li>binlog flag：</li>
<li>slave_server_id：表示slave的server_id</li>
<li>binlog文件名：表示请求的binlog的文件名</li>
</ul>
<h4 id="异常情况-4"><a href="#异常情况-4" class="headerlink" title="异常情况"></a>异常情况</h4><ul>
<li>binlog 请求的位置点大于对应binlog_file中最大的位置点<br>Master返回一个ERR数据包，Err Packet格式参见“3.3.2 ”</li>
</ul>
<p>示例数据包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4f 00 00 数据包长度</span><br><span class="line">01 数据包序号</span><br><span class="line">ff ERR数据包标识</span><br><span class="line">d4 04 error code</span><br><span class="line">23 48 59 30 30 30 43 6c 69 65 6e 74 20 72 65 71 75 65 73 74 65 64 20 6d 61 73 74 65 72 20 74 6f 20 73 74 61 72 74 20 72 65 70 6c 69 63 61 74 69 6f 6e 20 66 72 6f 6d 20 70 6f 73 69 74 69 6f 6e 20 3e 20 66 69 6c 65 20 73 69 7a 65 错误信息</span><br></pre></td></tr></table></figure>
<p>各分段数据包含义：</p>
<ul>
<li>错误号为：1236</li>
<li>错误信息为：Client requested master to start replication from position&gt;filesize</li>
</ul>
<ul>
<li>binlog 请求的位置点不是event起始位置点</li>
</ul>
<p>Master返回一个ERR数据包，Err Packet格式参见上一篇文章中ERR_Packet部分内容。</p>
<p>数据包示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">e1 00 00 数据包长度</span><br><span class="line">03 数据包序号</span><br><span class="line">ff ERR数据包标识</span><br><span class="line">d4 04 error code</span><br><span class="line">23 48 59 30 30 30 62 6f 67 75 73 20 64 61 74 61 20 69 6e 20 6c 6f 67 20 65 76 65 6e 74 3b 20 74 68 65 20 66 69 72 73 74 20 65 76 65 6e 74 20 27 6d 79 73 71 6c 2d 62 69 6e 2e 30 30 30 30 30 31 27 20 61 74 20 31 36 30 2c 20 74 68 65 20 6c 61 73 74 20 65 76 65 6e 74 20 72 65 61 64 20 66 72 6f 6d 20 27 2f 6f 70 74 2f 6d 79 73 71 6c 2f 64 61 74 61 2f 62 69 6e 6c 6f 67 2f 6d 79 73 71 6c 2d 62 69 6e 2e 30 30 30 30 30 31 27 20 61 74 20 31 32 33 2c 20 74 68 65 20 6c 61 73 74 20 62 79 74 65 20 72 65 61 64 20 66 72 6f 6d 20 27 2f 6f 70 74 2f 6d 79 73 71 6c 2f 64 61 74 61 2f 62 69 6e 6c 6f 67 2f 6d 79 73 71 6c 2d 62 69 6e 2e 30 30 30 30 30 31 27 20 61 74 20 31 37 39 2e 错误信息</span><br></pre></td></tr></table></figure>
<p>各分段含义：</p>
<ul>
<li>错误号为：1236</li>
<li>错误信息为：bogusdatain log event;the first event’mysql-bin.000001’at160,the last event read from’/opt/mysql/data/binlog/mysql-bin.000001’at123,the last byte read from’/opt/mysql/data/binlog/mysql-bin.000001’at179.</li>
</ul>
<ul>
<li>binlog 请求的binlog filename 不存在</li>
</ul>
<p>Master返回一个ERR数据包</p>
<p>数据包示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">44 00 00 数据包长度</span><br><span class="line">01 数据包序号</span><br><span class="line">ff ERR数据包标识</span><br><span class="line">d4 04 error code</span><br><span class="line">23 48 59 30 30 30 43 6f 75 6c 64 20 6e 6f 74 20 66 69 6e 64 20 66 69 72 73 74 20 6c 6f 67 20 66 69 6c 65 20 6e 61 6d 65 20 69 6e 20 62 69 6e 61 72 79 20 6c 6f 67 20 69 6e 64 65 78 20 66 69 6c 65 错误信息</span><br></pre></td></tr></table></figure>
<p>各分段数据含义：</p>
<ul>
<li>错误号为：1236</li>
<li>错误信息为：Could not find first log filename in binary log index file</li>
</ul>
<h2 id="整体流程回顾"><a href="#整体流程回顾" class="headerlink" title="整体流程回顾"></a>整体流程回顾</h2><p>最后我们再整体来看一下MySQL复制链接在建立连接的完整过程</p>
<ul>
<li>Master与Slave建立TCP/IP连接</li>
<li>Master发送第一个MySQL协议的Greeting包给Slave</li>
<li>Slave根据发送的数据包，加密自己的账户及密码等信息，发送给Master</li>
<li>Master根据Slave发送的auth数据包进行认证，认证成功，则发送一个Response OK数据包给Slave，Slave完成用户登录</li>
<li>Slave发送一个Query的请求，设置当前连接的master_binlog_checksum为@@global.binlog_checksum这一步是必须的，这是设置校验码</li>
<li>Master处理完Slave的Query请求之后，发送一个Response OK数据包给Slave</li>
<li>Slave发送一个Query请求，设置当前连接的slave_uuid为从库的uuid，这一步非必须</li>
<li>Master处理完Slave的Query请求之后，发送一个Response OK数据包给Slave</li>
<li>Slave向Master发送一个Register Slave的数据包，进行slave线程的注册</li>
<li>Master将slave线程注册完成之后，返回一个Response OK数据包</li>
<li>Slave在注册成功之后，向Master发送Binlog Dump命令，发送请求的binlog的文件名以及pos点</li>
<li>Master在收到Slave的Binlog Dump命令之后，首先发送一个Rotate Event的内容给Slave，告诉Slave当前发送的binlog的文件名为什么</li>
<li>Master之后再发送一个Format Description Event内容给Slave，包括版本信息，位置点等信息</li>
<li>接着Master按照Slave的Binlog Dump请求中携带的pos点的信息，从该binlog文件偏移位置为pos的地方将Event内容取出来，发送给Slave</li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>MySQL协议官方文档<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PROTOCOL.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PROTOCOL.html</a></li>
<li><a href="http://mysql.taobao.org/monthly/2017/08/05/" target="_blank" rel="noopener">http://mysql.taobao.org/monthly/2017/08/05/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/17/MySQL Binlog(二)——MySQL 协议基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/17/MySQL Binlog(二)——MySQL 协议基础/" class="post-title-link" itemprop="url">MySQL Binlog(二)——MySQL 协议基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-17 10:41:13" itemprop="dateCreated datePublished" datetime="2019-11-17T10:41:13+08:00">2019-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-二-——MySQL-协议基础"><a href="#MySQL-Binlog-二-——MySQL-协议基础" class="headerlink" title="MySQL Binlog(二)——MySQL 协议基础"></a>MySQL Binlog(二)——MySQL 协议基础</h1><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>上篇讲了MySQL的复制原理，这篇文章来讲讲建立复制过程中使用的MySQL通讯协议。MySQL协议是用于MySQL中Server端与Client端进行通讯的协议，MySQL主备复制也遵守Server和Client端通讯协议。</p>
<h2 id="2-基础数据类型"><a href="#2-基础数据类型" class="headerlink" title="2. 基础数据类型"></a>2. 基础数据类型</h2><p>MySQL协议传输中的数据包含两种类型，一种是数值型数据，另一种是字符型数据。</p>
<h3 id="2-1-数值型数据"><a href="#2-1-数值型数据" class="headerlink" title="2.1 数值型数据"></a>2.1 数值型数据</h3><ul>
<li>Protocol::FixedLengthInteger </li>
</ul>
<p>MySQL使用Protocol::FixedLenthInteger 表示固定长度的整数</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>长度</th>
<th>对应函数</th>
<th>实际对应类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>int<1></1></td>
<td>1 byte</td>
<td></td>
<td></td>
</tr>
<tr>
<td>int<2></2></td>
<td>2 byte</td>
<td>int2store()</td>
<td>uint16</td>
</tr>
<tr>
<td>int<3></3></td>
<td>3 byte</td>
<td>int3store()</td>
<td>uint</td>
</tr>
<tr>
<td>int<4></4></td>
<td>4 byte</td>
<td>int4store()</td>
<td>uint32</td>
</tr>
<tr>
<td>int<6></6></td>
<td>6 byte</td>
<td>int6store()</td>
<td>ulonglong</td>
</tr>
<tr>
<td>int<8></8></td>
<td>8 byte</td>
<td>int8store()</td>
<td>ulonglong</td>
</tr>
</tbody>
</table>
<ul>
<li>Protocol::LengthEncodedInteger </li>
</ul>
<p>使用Protocol::LengthEncodedInteger类型表示的整数，会根据表示的整数大小占用不同的字节数（1，3，4或9个字节）</p>
<table>
<thead>
<tr>
<th>整数范围</th>
<th>表示方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>0≤N＜251</td>
<td>1 byte</td>
<td>0x08 表示整数8</td>
</tr>
<tr>
<td>251≤N＜2^16</td>
<td>0xFC + 2 byte</td>
<td>0xFC0008 = 0xFC + 0x0008 表示整数260</td>
</tr>
<tr>
<td>2^16≤N＜2^24</td>
<td>0xFD + 3 byte</td>
<td>0xFD123456 = 0xFD + 0x123456  表示整数1193299</td>
</tr>
<tr>
<td>2^24≤N＜2^64</td>
<td>0xFE + 8 byte</td>
<td>0xFE0000000000000009 = 0xFE + 0x0000000000000009 表示整数263</td>
</tr>
</tbody>
</table>
<h3 id="2-2-字符型数据"><a href="#2-2-字符型数据" class="headerlink" title="2.2 字符型数据"></a>2.2 字符型数据</h3><ul>
<li>Protocol::FixedLengthString 固定长度的字符串</li>
</ul>
<p>字符串用固定长度表示，例如ERR_Packet中的 <code>sql_state</code> 部分就是固定5个字节长度</p>
<ul>
<li>Protocol::NullTerminatedString</li>
<li><p>以0x00结尾的字符串</p>
</li>
<li><p>Protocol::VariableLengthString</p>
</li>
</ul>
<p>在程序运行过程中动态确定长度的字符串</p>
<ul>
<li>Protocol::LengthEncodedString</li>
</ul>
<p>在字符串开始用Protocol::LengthEncodedInteger类型整数表示字符串的长度</p>
<ul>
<li>Protocol::RestOfPacketString</li>
</ul>
<p>字符串是整个数据包的最后一个组成部分，字符串的长度等于整个数据包的长度减去当前位置</p>
<h2 id="3-基本协议数据包格式"><a href="#3-基本协议数据包格式" class="headerlink" title="3. 基本协议数据包格式"></a>3. 基本协议数据包格式</h2><p>MySQL中server端与client端进行数据交换的时候，会将要交换的数据，按照上述的协议数据类型封装成数据包，然后通过MySQL协议进行数据包的传输。</p>
<h3 id="3-1-基础数据包的格式定义"><a href="#3-1-基础数据包的格式定义" class="headerlink" title="3.1 基础数据包的格式定义"></a>3.1 基础数据包的格式定义</h3><p>相关代码位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql/net_serv.cc -&gt; net_write_command()函数</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>名字</th>
<th>基本数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>payload_length</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<3></3></td>
<td>数据包中有效信息的长度，不包括数据包头部4个字节的长度</td>
</tr>
<tr>
<td>sequence_id</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<1></1></td>
<td>数据包序列号</td>
</tr>
<tr>
<td>payload</td>
<td>Protocol::VariableLengthString</td>
<td>string<var></var></td>
<td>数据包的有效信息</td>
</tr>
</tbody>
</table>
<h3 id="3-2-基础数据包的格式解析"><a href="#3-2-基础数据包的格式解析" class="headerlink" title="3.2 基础数据包的格式解析"></a>3.2 基础数据包的格式解析</h3><p>MySQL协议中数据包固定由 <code>payload_length</code> + <code>sequence_id</code> + <code>payload</code> 组成。每个数据包前3个字节固定存储<code>payload_length</code>信息，即数据包中有效信息<code>payload</code>的长度，第4个字节表示该数据包在此次通信中的序号。因为<code>payload_length</code>为int<3>类型，所以能表示的最大<code>payload</code>部分长度为2^24-1个字节，也就是说一个数据包能传输的数据量最大为2^24-1字节（合16MB）。</3></p>
<p>那么对于一次请求中，数据量超过16MB的数据，MySQL是如何处理的呢？</p>
<p>对于<code>payload</code>部分大于等于16MB的，MySQL会将数据进行切分，每16MB为一部分，然后将切分的数据按照数据包的格式封装，进行发送，直到切分的数据部分长度小于16MB。</p>
<h2 id="4-常见数据包示例"><a href="#4-常见数据包示例" class="headerlink" title="4. 常见数据包示例"></a>4. 常见数据包示例</h2><p>上面介绍了MySQL协议中数据包的基础格式，这一节介绍MySQL协议中常见的数据包类型，不同类型的数据包，其格式都是符合上述的基础数据包格式定义的。但是对于不同数据包类型，其<code>payload</code>部分的数据格式是不同的。</p>
<h3 id="4-1-OK-Packet"><a href="#4-1-OK-Packet" class="headerlink" title="4.1 OK_Packet"></a>4.1 OK_Packet</h3><p>对于Client发送的请求，如果执行成功，则Server端会向Client端发送OK_Packet告诉Client端请求执行成功。但是在5.7.5版本之后，OK Packet也可以用于表示EOF信息，原先的 EOF_Packet被废弃了，EOF Packet后面章节会详细描述。</p>
<h4 id="4-1-1-OK-Packet的格式定义"><a href="#4-1-1-OK-Packet的格式定义" class="headerlink" title="4.1.1 OK_Packet的格式定义"></a>4.1.1 OK_Packet的格式定义</h4><p>相关代码位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql/protocol_classic.cc -&gt; net_send_ok()函数</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>名字</th>
<th>基本数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>header</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<1></1></td>
<td>0x00表示该数据包是OK_Packet，0xFE表示该数据包是ERR_Packet</td>
</tr>
<tr>
<td>affect_rows</td>
<td>Protocol::LengthEncodedInteger</td>
<td>int<lenenc></lenenc></td>
<td>请求在Server端执行影响的记录行数</td>
</tr>
<tr>
<td>last_insert_id</td>
<td>Protocol::LengthEncodedInteger</td>
<td>int<lenenc></lenenc></td>
<td>对于INSERT请求，表示最近插入的那行记录的自增字段值</td>
</tr>
<tr>
<td>status_flags</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<2></2></td>
<td>Server端的状态信息，如果Client发送的请求中带有CLIENT_PROTOCOL_41标志,会有这一部分，否则为空</td>
</tr>
<tr>
<td>warnings</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<2></2></td>
<td>警告的数量，如果Client发送的请求中带有CLIENT_PROTOCOL_41标志,会有这一部分，否则为空</td>
</tr>
<tr>
<td>status_flag</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<2></2></td>
<td>如果Client发送的请求中带有CLIENT_TRANSACTIONS标志,会有这一部分，否则为空</td>
</tr>
<tr>
<td>messages</td>
<td>Protocol::LengthEncodedString</td>
<td>string<lenenc></lenenc></td>
<td>当前会话状态改变的信息，如果Client发送的请求中带有CLIENT_SESSION_TRACK标志，会有这一部分，否则为空</td>
</tr>
<tr>
<td>session_state_change_info</td>
<td>Protocol::LengthEncodedString</td>
<td>string<lenenc></lenenc></td>
<td>当前会话状态改变的信息，如果Client发送的请求中带有SERVER_SESSION_STATE_CHANGED标志,会有这一部分，否则为空</td>
</tr>
<tr>
<td>messages</td>
<td>Protocol::RestOfPacketString</td>
<td>string<eof></eof></td>
<td>请求执行结果信息，如果不包含信息，该部分为空</td>
</tr>
</tbody>
</table>
<p>其中<code>int&lt;lenenc&gt;</code>和<code>string&lt;lenenc&gt;</code>中的lenenc表示的是LengthEcode。</p>
<p><code>status_flag</code>字段中记录的是Server端的状态信息，MySQL支持的<code>server_status</code>类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#define SERVER_STATUS_IN_TRANS 1</span><br><span class="line">#define SERVER_STATUS_AUTOCOMMIT 2    /* Server in auto_commit mode */</span><br><span class="line">#define SERVER_MORE_RESULTS_EXISTS 8 /* Multi query - next query exists */</span><br><span class="line">#define SERVER_QUERY_NO_GOOD_INDEX_USED 16</span><br><span class="line">#define SERVER_QUERY_NO_INDEX_USED 32</span><br><span class="line">#define SERVER_STATUS_CURSOR_EXISTS 64</span><br><span class="line">#define SERVER_STATUS_LAST_ROW_SENT 128</span><br><span class="line">#define SERVER_STATUS_DB_DROPPED 256 /* A database was dropped */</span><br><span class="line">#define SERVER_STATUS_NO_BACKSLASH_ESCAPES 512</span><br><span class="line">#define SERVER_STATUS_METADATA_CHANGED 1024</span><br><span class="line">#define SERVER_QUERY_WAS_SLOW 2048</span><br><span class="line">#define SERVER_PS_OUT_PARAMS 4096</span><br><span class="line">#define SERVER_STATUS_IN_TRANS_READONLY 8192</span><br><span class="line">#define SERVER_SESSION_STATE_CHANGED (1UL &lt;&lt; 14)</span><br></pre></td></tr></table></figure>
<p>当表示两个及两个以上状态时，将代表多个状态的值做<code>^</code>运算即可。</p>
<h4 id="4-1-2-OK-Packet的格式解析"><a href="#4-1-2-OK-Packet的格式解析" class="headerlink" title="4.1.2 OK Packet的格式解析"></a>4.1.2 OK Packet的格式解析</h4><p>上面讲到5.7.5版本之后，OK Packet既可以表示OK Packet也可以表示EOF Packet，那么在5.7.5之后如何区分是OK Packet 还是 EOF Packet呢？</p>
<ul>
<li>OK_Packet:头部部分是0x00，并且数据包的长度是大于7</li>
<li>EOF_Packet:头部部分是0xFE，并且数据包的长度是小于9</li>
</ul>
<p>为了保证5.7.5之前版本与之后版本的兼容性，5.7.5之后的MySQL 版本中的client端都会发送<code>CLIENT_DEPRECATE_EOF</code>标志。旧版本client不会发送该标志，所以Server端还是采用专门的EOF_Packet（下面会具体介绍）表示EOF信息，新版本的client在向Server端发送请求时会带上该标志，但是对于旧版本的Server端，无法识别该标志，所以依然是采用专门的EOF_Packet表示EOF信息。</p>
<p>client端发送带<code>CLIENT_PROTOCOL_41</code>标志的数据包示例（内容为16进制格式）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">07 00 00 #数据包长度</span><br><span class="line">02           #数据包序号</span><br><span class="line">00           #头部</span><br><span class="line">00          #影响的记录行数</span><br><span class="line">00          #上一次插入的记录自增值</span><br><span class="line">02 00     #状态标志</span><br><span class="line">00 00     #警告数量</span><br></pre></td></tr></table></figure>
<p>各分段数据含义：</p>
<ul>
<li>数据包长度：MySQL协议中固定格式，示例中<code>07 00 00</code>表示0x000007，代表数据包长度为7个字节</li>
<li>数据包序号：MySQL协议中固定格式，示例中<code>00</code>表示数据包序号为2</li>
<li>头部：示例中<code>ff</code>表示该数据包为OK_Packet</li>
<li>影响的记录行数：示例中<code>00</code>表示0x00，代表本次client请求共影响0行记录</li>
<li>上一次插入的记录自增值：实例中<code>00</code>表示0x00</li>
<li>状态标志：因为是小端存储，所以示例中<code>02 00</code>表示0x0002，代表Server端开启了auto_commit</li>
<li>警告的数量：因为是小端存储，所以示例中<code>00 00</code>表示0x0000，表示告警数量为0</li>
</ul>
<h4 id="4-1-3-Session-State-Information"><a href="#4-1-3-Session-State-Information" class="headerlink" title="4.1.3 Session State Information"></a>4.1.3 Session State Information</h4><p>OK_Packet中也可以记录会话级别的状态改变信息，包括系统变量信息、当前会话使用的schema信息、会话级别状态改变信息、事务特性、事务状态信息。当Client端发送的请求中带有<code>SERVER_SESSION_STATE_CHANGED</code>标志，则在Server端返回的OK_Packet中会带有这些信息。OK_Packet一共支持如下几种会话级别状态信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum enum_session_state_type</span><br><span class="line">&#123;</span><br><span class="line">  SESSION_TRACK_SYSTEM_VARIABLES, /* Session system variables */</span><br><span class="line">  SESSION_TRACK_SCHEMA, /* Current schema */</span><br><span class="line">  SESSION_TRACK_STATE_CHANGE, /* track session state changes */</span><br><span class="line">  SESSION_TRACK_GTIDS,</span><br><span class="line">  SESSION_TRACK_TRANSACTION_CHARACTERISTICS, /* Transaction chistics */</span><br><span class="line">  SESSION_TRACK_TRANSACTION_STATE /* Transaction state */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体可参考官方文档：<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_ok_packet.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_ok_packet.html</a></p>
<h3 id="4-2-ERR-Packet"><a href="#4-2-ERR-Packet" class="headerlink" title="4.2 ERR_Packet"></a>4.2 ERR_Packet</h3><p>该数据包用于返回出现错误信息。<br>相关代码位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql/protocol_classic.cc -&gt; net_send_error_packet()函数</span><br></pre></td></tr></table></figure>
<h4 id="4-2-1-ERR-Packet的格式定义"><a href="#4-2-1-ERR-Packet的格式定义" class="headerlink" title="4.2.1 ERR_Packet的格式定义"></a>4.2.1 ERR_Packet的格式定义</h4><p>在5.7.5之前版本中，ERR_Packet采用单独表示格式，5.7.5之后，ERR_Packet与OK_Packet复用相同格式。以下是针对5.7.5之前版本介绍ERR_Packet格式定义。</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>基本数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>header</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<1></1></td>
<td>用0xFF表示该数据包是一个ERR Packet</td>
</tr>
<tr>
<td>error_no</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<2></2></td>
<td>表示错误的类型，小端存储</td>
</tr>
<tr>
<td>sql_state_marker</td>
<td>Protocol::VariableLengthString</td>
<td>string[1]</td>
<td>如果Client发送的请求中带有CLIENT_PROTOCOL_41标志，会有这一部分，否则为空</td>
</tr>
<tr>
<td>sql_state</td>
<td>Protocol::VariableLengthString</td>
<td>string[5]</td>
<td>如果Client发送的请求中带有CLIENT_PROTOCOL_41标志，会有这一部分，否则为空</td>
</tr>
<tr>
<td>err_message</td>
<td>Protocol::RestOfPacketString</td>
<td>string<eof></eof></td>
<td>可读的错误信息详情</td>
</tr>
</tbody>
</table>
<h4 id="4-2-2-ERR-Packet的格式解析"><a href="#4-2-2-ERR-Packet的格式解析" class="headerlink" title="4.2.2 ERR_Packet的格式解析"></a>4.2.2 ERR_Packet的格式解析</h4><p>数据包示例（内容为16进制格式）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4b 00 00  #数据包长度</span><br><span class="line">02            #数据包序号</span><br><span class="line">ff              #ERR_Packet标识</span><br><span class="line">15 04       #错误号</span><br><span class="line">23 32 38 30 30 30 41 63 63 65 73 73 20 64 65 6e 69 65 64 20 66 6f 72 20 75 73 65 72 20 27 72 65 70 6c 27 40 27 31 32 31 2e 31 32 31 2e 30 2e 36 34 27 20 28 75 73 69 6e 67 20 70 61 73 73 77 6f 72 64 3a 20 59 45 53 29  #错误信息</span><br></pre></td></tr></table></figure>
<p>各分段数据含义：</p>
<ul>
<li>数据包长度：MySQL协议中固定格式，示例中<code>4b 00 00</code>表示0x00004b，代表数据包长度为75个字节</li>
<li>数据包序号：MySQL协议中固定格式，示例中<code>00</code>表示数据包序号为0</li>
<li>头部：示例中<code>ff</code>表示该数据包为ERR_Packet</li>
<li>错误号：因为是小端存储，所以示例中<code>15 04</code>对应16进制0x0415，转换为10进制为1045</li>
<li>错误信息：示例中的内容可以转换为<code>Access denied for user &#39;repl&#39;@&#39;121.121.0.64&#39;(usingpassword:YES)</code></li>
</ul>
<h3 id="4-3-EOF-Packet"><a href="#4-3-EOF-Packet" class="headerlink" title="4.3 EOF_Packet"></a>4.3 EOF_Packet</h3><p>表示当前会话可以结束了，结束连接的信号。<br>相关代码位置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql/protocol_classic.cc -&gt; write_eof_packet()函数</span><br></pre></td></tr></table></figure>
<h4 id="4-3-1-EOF-Packet的格式定义"><a href="#4-3-1-EOF-Packet的格式定义" class="headerlink" title="4.3.1 EOF_Packet的格式定义"></a>4.3.1 EOF_Packet的格式定义</h4><table>
<thead>
<tr>
<th>名字</th>
<th>基本数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>header</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<1></1></td>
<td>用0xFE表示该数据包是一个ERR_Packet</td>
</tr>
<tr>
<td>warnings</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<2></2></td>
<td>警告的数量，如果Client发送的请求中带有CLIENT_PROTOCOL_41标志，会有这一部分，否则为空，小端存储</td>
</tr>
<tr>
<td>server_status</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<2></2></td>
<td>Server端的状态信息，如果Client发送的请求中带有CLIENT_PROTOCOL_41标志,会有这一部分，否则为空，小端存储</td>
</tr>
</tbody>
</table>
<p>其中<code>server_status</code>内容参照OK_Packet中<code>status_flags</code>字段。</p>
<h4 id="4-3-2-EOF-Packet的格式解析"><a href="#4-3-2-EOF-Packet的格式解析" class="headerlink" title="4.3.2 EOF_Packet的格式解析"></a>4.3.2 EOF_Packet的格式解析</h4><p>数据包示例（内容为16进制格式）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">05 00 00  #数据包长度</span><br><span class="line">05            #数据包序号</span><br><span class="line">fe             #头部</span><br><span class="line">00 00       #警告的数量</span><br><span class="line">02 00       #Server端的状态信息</span><br></pre></td></tr></table></figure>
<p>各分段数据含义：</p>
<ul>
<li>数据包长度：MySQL协议中固定格式，示例中<code>05 00 00</code>表示0x000005，代表数据包长度为5个字节</li>
<li>数据包序号：MySQL协议中固定格式，示例中<code>05</code>表示数据包序号为5</li>
<li>头部：标识是否是EOF数据包，0xFE标识该数据包是EOF_Packet</li>
<li>警告的数量：因为是小端存储，所以示例中<code>00 00</code>表示0x0000，表示告警数量为0</li>
<li>Server端的状态信息：因为是小端存储，所以示例中<code>02 00</code>表示0x0002，代表Server端开启了auto_commit</li>
</ul>
<h3 id="4-4-Query-Packet"><a href="#4-4-Query-Packet" class="headerlink" title="4.4 Query_Packet"></a>4.4 Query_Packet</h3><h4 id="4-4-1-Query-Packet的格式定义"><a href="#4-4-1-Query-Packet的格式定义" class="headerlink" title="4.4.1 Query_Packet的格式定义"></a>4.4.1 Query_Packet的格式定义</h4><table>
<thead>
<tr>
<th>名字</th>
<th>基本数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>payload_length</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<3></3></td>
<td>数据包中有效信息的长度，不包括数据包头部4个字节的长度，小端存储</td>
</tr>
<tr>
<td>sequence_id</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<1></1></td>
<td>数据包序列号</td>
</tr>
<tr>
<td>command_type</td>
<td>Protocol::FixedLengthInteger</td>
<td>int<1></1></td>
<td>要发送的请求的类型</td>
</tr>
<tr>
<td>command</td>
<td>Protocol::RestOfPacketString</td>
<td>string<eof></eof></td>
<td>请求内容</td>
</tr>
</tbody>
</table>
<h4 id="4-4-2-Query-Packet的格式解析"><a href="#4-4-2-Query-Packet的格式解析" class="headerlink" title="4.4.2 Query_Packet的格式解析"></a>4.4.2 Query_Packet的格式解析</h4><p>以<code>SET @master_binlog_checksum</code>语句请求为例</p>
<p>数据包示例（内容为16进制格式）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">36 00 00    #数据包长度</span><br><span class="line">00              #数据包序号</span><br><span class="line">03              #发送的command类型 0x03表示的是COM_QUERY类型的命令</span><br><span class="line">53 45 54 20 40 6d 61 73 74 65 72 5f 62 69 6e 6c 6f 67 5f 63 68 65 63 6b 73 75 6d 3d 20 40 40 67 6c 6f 62 61 6c 2e 62 69 6e 6c 6f 67 5f 63 68 65 63 6b 73 75 6d   #要发送的请求语句 //SET @master_binlog_checksum=@@global.binlog_checksum</span><br></pre></td></tr></table></figure>
<p>各分段数据含义： </p>
<ul>
<li>数据包长度：MySQL协议中固定格式，示例中<code>36 00 00</code>表示0x000036，代表数据包长度为36个字节</li>
<li>数据包序号：MySQL协议中固定格式，示例中<code>00</code>表示数据包序号为0</li>
<li>COMMAND类型：表示发送的请求的类型，MySQL支持的命令类型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">enum enum_server_command</span><br><span class="line">&#123;</span><br><span class="line">  COM_SLEEP,COM_QUIT,</span><br><span class="line">  COM_INIT_DB,</span><br><span class="line">  COM_QUERY,</span><br><span class="line">  COM_FIELD_LIST,</span><br><span class="line">  COM_CREATE_DB,</span><br><span class="line">  COM_DROP_DB,</span><br><span class="line">  COM_REFRESH,</span><br><span class="line">  COM_SHUTDOWN,</span><br><span class="line">  COM_STATISTICS,</span><br><span class="line">  COM_PROCESS_INFO,</span><br><span class="line">  COM_CONNECT,</span><br><span class="line">  COM_PROCESS_KILL,</span><br><span class="line">  COM_DEBUG,</span><br><span class="line">  COM_PING,</span><br><span class="line">  COM_TIME,</span><br><span class="line">  COM_DELAYED_INSERT,</span><br><span class="line">  COM_CHANGE_USER,</span><br><span class="line">  COM_BINLOG_DUMP,</span><br><span class="line">  COM_TABLE_DUMP,</span><br><span class="line">  COM_CONNECT_OUT,</span><br><span class="line">  COM_REGISTER_SLAVE,</span><br><span class="line">  COM_STMT_PREPARE,</span><br><span class="line">  COM_STMT_EXECUTE,</span><br><span class="line">  COM_STMT_SEND_LONG_DATA,</span><br><span class="line">  COM_STMT_CLOSE,</span><br><span class="line">  COM_STMT_RESET,</span><br><span class="line">  COM_SET_OPTION,</span><br><span class="line">  COM_STMT_FETCH,</span><br><span class="line">  COM_DAEMON,</span><br><span class="line">  COM_BINLOG_DUMP_GTID,</span><br><span class="line">  COM_RESET_CONNECTION,</span><br><span class="line">  COM_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>要发送的请求语句：将要发送的语句转换为ASCII对应的16进制，示例中的内容可以转换为：<code>SET @master_binlog_checksum=@@global.binlog_checksum</code></li>
</ul>
<h2 id="5-参考链接"><a href="#5-参考链接" class="headerlink" title="5. 参考链接"></a>5. 参考链接</h2><ul>
<li><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_dt_integers.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_dt_integers.html</a></li>
<li><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_dt_strings.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_dt_strings.html</a></li>
<li><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_packets.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_packets.html</a></li>
<li><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_response_packets.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_response_packets.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/17/MySQL Binlog(一)——MySQL复制原理基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/17/MySQL Binlog(一)——MySQL复制原理基础/" class="post-title-link" itemprop="url">MySQL Binlog(一)——MySQL复制原理基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-17 09:35:13" itemprop="dateCreated datePublished" datetime="2019-11-17T09:35:13+08:00">2019-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-一-——MySQL复制原理基础"><a href="#MySQL-Binlog-一-——MySQL复制原理基础" class="headerlink" title="MySQL Binlog(一)——MySQL复制原理基础"></a>MySQL Binlog(一)——MySQL复制原理基础</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>复制作为MySQL DBA必备技能之一，从本章开始，我们将开启一个文章系列，从MySQL复制原理、MySQL协议、MySQL字段存储以及MySQL binlog event存储几个方面展开介绍。本系列文章主要参考官方文档以及官方Internals Manual，部分通过查看5.6.34以及5.7.22版本源码补全。</p>
<p>本文作为此系列文章第一篇，介绍一下MySQL复制原理的基础知识。</p>
<h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h2><p>如下图所示，MySQL主备复制基于二进制日志binlog。任何数据更改都会写入二进制日志。</p>
<p>数据库管理员搭建主备复制时，只需要在备库change master to指定主库的IP、端口、同步开始的二进制文件和文件偏移量（MySQL 5.6以后支持GTID模式，二进制文件和文件偏移量可以用GTID号集合替换）就可以了。</p>
<p>备库通过IO线程连接主库，接收主库推送过来的二进制日志，并记录到本地的中继日志relaylog；同时也会启动SQL线程将中继日志的数据变更应用到备库本地数据库中.</p>
<p>主库接受到备库IO线程的请求，会专门对该slave启用独立的binlog dump线程，从IO线程指定的二进制文件和文件偏移量开始发送二进制日志；并且在主库有任何新的变更后，在记录到自己的二进制日志的同时也会通过网络推送给备库的IO线程。<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20191117093115.png" alt></p>
<h2 id="复制线程"><a href="#复制线程" class="headerlink" title="复制线程"></a>复制线程</h2><h3 id="Master线程"><a href="#Master线程" class="headerlink" title="Master线程"></a>Master线程</h3><ul>
<li>binlog dump线程<br>dump线程的作用是读取主库上二进制日志中的事件。在复制线程处于正常运行状态时，当事务提交的时候，binlog日志sync到磁盘上之后，MySQL会调用signal_update()函数，这个函数的作用是通知binlog dump线程，binlog日志有更新了，dump线程将产生的增量binlog推送到从库的IO线程；在主从之间建议复制连接的时候，从库IO线程将binlog文件名以及位置点（GTID模式下是发送GTID集合）发送给主句dump线程拉取从库所需binlog。<br>对于一主多从的情况，master上会有多个binlog dump线程。</li>
</ul>
<h3 id="Slave线程"><a href="#Slave线程" class="headerlink" title="Slave线程"></a>Slave线程</h3><ul>
<li><p>I/O线程：<br>I/O线程的作用就是拉取主库上的binlog日志，在从库上存贮为relay log日志。方便SQL线程中relay log中重放事务。<br>I/O线程在与主库建立连接的时候，超过slave_net_timeout时间没有建立连接成功，从库就认为这次连接失败，需要重试连接，重试连接的次数由MASTER_RETRY_COUNT决定。<br>I/O线程在与主库成功建立连接之后，针对可能主库很长时间都没有更新数据的情况，I/O线程采用了心跳机制，I/O线程在空闲的时候，每隔MASTER_HEARTBEAT_PERIOD时间间隔，I/O线程就向主库发送一个心跳包，测试与主库的连接是否正常。<br>使用mysqlbinlog工具也可以解析relay log日志。</p>
</li>
<li><p>SQL线程：<br>读取relay log，并且重放relay log中的事务，以达到复制的目的。</p>
</li>
</ul>
<h2 id="复制格式"><a href="#复制格式" class="headerlink" title="复制格式"></a>复制格式</h2><p>binlog的格式可以分为三种，从某种意义上来讲也可以说对应着三种复制模式，使用binlog_format控制binlog的格式，该参数的不同值代表了不同的复制模式，下面以该参数的三个值对复制格式进行简单的阐述：</p>
<ul>
<li>statement：5.1.5之前只支持statement格式（俗称：statement binary replication，缩写：SBR），简单实现了数据同步，但在执行跨裤更新等SQL语句时容易出现主从的数据不一致</li>
<li>row：5.1.5及其之后，新增支持row格式（俗称：row binary replication，缩写：RBR），不再是简单记录SQL执行顺序，而是逐行记录了存储引擎的数据如何变更的，主从之间的数据一致性保障得到大幅度提升</li>
<li>mixed：5.1.8及其之后新增支持mixed格式（俗称：mixed binary replication，缩写：MBR），本质上是让MySQL Server自行根据SQL语句的不同来判断是否需要使用row格式，当出现可能造成主从数据不一致的SQL时（例如：用户自定义函数，跨库SQL等），binlog自动转为row格式记录，否则默认使用statement格式记录<h2 id="MySQL-binlog"><a href="#MySQL-binlog" class="headerlink" title="MySQL binlog"></a>MySQL binlog</h2></li>
</ul>
<h3 id="什么是binlog"><a href="#什么是binlog" class="headerlink" title="什么是binlog"></a>什么是binlog</h3><p>二进制日志（binary log简称binlog）是MySQL中的日志文件，会记录MySQL数据库执行的更改操作。但是只记录更改操作，如SELECT、SHOW等操作，不会被记录到binlog中。binlog对于MySQL而言是很重要的日志文件，它可以有以下功能：</p>
<ul>
<li>搭建复制</li>
</ul>
<p>MySQL的复制完全依赖于binlog搭建，复制的原理本质上就是从库从主库上拉取主库的二进制日志，然后将拉取到的日志在从库上进行重放，实现数据的同步。</p>
<ul>
<li>数据恢复</li>
</ul>
<p>一般的备份方案，都是特定的时刻对数据库进行备份，没有对数据库进行实时的备份。如果数据库在两个备份时间点之间出现故障，那么恢复数据的时候，最多只能恢复到最近一个备份时间点。但是binlog日志可以基于时间点或者位置点进行数据恢复。在上述故障情况的时候，可以拿最近一个时间点的备份+binlog将数据恢复到故障时刻。</p>
<ul>
<li>审计</li>
</ul>
<p>用户可以通过二进制日志中的信息来进行审计，判断是否有对数据局进行注入的攻击。</p>
<h3 id="binlog文件"><a href="#binlog文件" class="headerlink" title="binlog文件"></a>binlog文件</h3><p>binlog文件主要包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql-bin.00000x</span><br><span class="line">mysql-bin.index</span><br></pre></td></tr></table></figure>
<p><code>mysql-bin.index</code>记录了数据库中还未被purge的binlog文件名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@10-10-90-177 binlog]# cat mysql-bin.index</span><br><span class="line">/home/mysql/data/mysqldata1/binlog/mysql-bin.000001</span><br><span class="line">/home/mysql/data/mysqldata1/binlog/mysql-bin.000002</span><br><span class="line">/home/mysql/data/mysqldata1/binlog/mysql-bin.000003</span><br></pre></td></tr></table></figure>
<p><code>mysql-bin.00000x</code>是真正的binlog文件 ，x表示binlog文件的序号，这些二进制文件里面的数据是以二进制的形式保存，可以通过特殊的工具(mysqlbinlog)进行解析，获取人类可读的信息。</p>
<h3 id="binlog文件组成"><a href="#binlog文件组成" class="headerlink" title="binlog文件组成"></a>binlog文件组成</h3><p>binlog文件格式有以下特点：</p>
<ol>
<li>binlog是由event组成，event是binlog的最小组成单元</li>
<li>binlog文件头部固定以4个字节开头，这四个字节称为BINLOG_MAGIC(fe 62 69 6e)</li>
<li>每个binlog文件以一个Format_desc类型的event开始</li>
<li>每个binlog文件以一个Rotate类型的event结束（但也有特殊情况，当数据库出现宕机的情况，重新启动数据库会生成一个新的binlog文件，但是宕机之前的最新binlog文件中，不是以ROTATE_EVENT结束的）</li>
<li>在FORMAT_DESCRIPTION_EVENT和ROTATE_EVENT之间是各种不同event，每个event代表Master上不同的操作。</li>
</ol>
<ul>
<li>BINLOG_MAGIC</li>
</ul>
<p>每个binlog文件以固定的4个字节（fe 62 69 6e）开始，以表示是一个binlog文件，在Linux环境下，我们可以通过<code>hexdump</code>命令查看binlog文件的字节组成。<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20191117093140.png" alt></p>
<ul>
<li>event</li>
</ul>
<p>我们有两种方式可以查看，binlog文件中的event组成方式。一种是在MySQL数据库中通过<code>SHOW BINLOG EVENTS IN &#39;binlog-file-name&#39;</code>的方式查看，还有一种就是通过mysqlbinlog工具查看binlog文件的组成。</p>
<ul>
<li>在数据库中查看</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : (none) 10:50:48&gt; show binlog events in &apos;mysql-bin.000004&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                      |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------+</span><br><span class="line">| mysql-bin.000004 |  4 | Format_desc |  3306114 |        120 | Server ver: 5.6.34-log, Binlog ver: 4                    |</span><br><span class="line">| mysql-bin.000004 | 120 | Query      |  3306114 |        201 | BEGIN                                                    |</span><br><span class="line">| mysql-bin.000004 | 201 | Rows_query  |  3306114 |        265 | # insert into test1(`name`) values(&apos;woqu&apos;)                |</span><br><span class="line">| mysql-bin.000004 | 265 | Table_map  |  3306114 |        320 | table_id: 70 (gangshen.test1)                            |</span><br><span class="line">| mysql-bin.000004 | 320 | Write_rows  |  3306114 |        365 | table_id: 70 flags: STMT_END_F                            |</span><br><span class="line">| mysql-bin.000004 | 365 | Xid        |  3306114 |        396 | COMMIT /* xid=24 */                                      |</span><br><span class="line">| mysql-bin.000004 | 396 | Query      |  3306114 |        477 | BEGIN                                                    |</span><br><span class="line">| mysql-bin.000004 | 477 | Rows_query  |  3306114 |        556 | # update test1 set name=&apos;woqu-change&apos; where name = &apos;woqu&apos; |</span><br><span class="line">| mysql-bin.000004 | 556 | Table_map  |  3306114 |        611 | table_id: 70 (gangshen.test1)                            |</span><br><span class="line">| mysql-bin.000004 | 611 | Update_rows |  3306114 |        674 | table_id: 70 flags: STMT_END_F                            |</span><br><span class="line">| mysql-bin.000004 | 674 | Xid        |  3306114 |        705 | COMMIT /* xid=27 */                                      |</span><br><span class="line">| mysql-bin.000004 | 705 | Query      |  3306114 |        786 | BEGIN                                                    |</span><br><span class="line">| mysql-bin.000004 | 786 | Rows_query  |  3306114 |        854 | # delete from test1 where name = &apos;woqu-change&apos;            |</span><br><span class="line">| mysql-bin.000004 | 854 | Table_map  |  3306114 |        909 | table_id: 70 (gangshen.test1)                            |</span><br><span class="line">| mysql-bin.000004 | 909 | Delete_rows |  3306114 |        961 | table_id: 70 flags: STMT_END_F                            |</span><br><span class="line">| mysql-bin.000004 | 961 | Xid        |  3306114 |        992 | COMMIT /* xid=28 */                                      |</span><br><span class="line">| mysql-bin.000004 | 992 | Rotate      |  3306114 |        1039 | mysql-bin.000005;pos=4                                    |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>可以看到<code>mysql-bin.000004</code>文件中，是以一个Format_desc类型的event开头，以一个Rotate类型的event结尾，中间是各种类型event，这是看binlog文件中event的组成，如果想要查看更详细的event信息，可以通过mysqlbinlog工具来查看</p>
<ul>
<li>mysqlbinlog工具查看</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"># at 4</span><br><span class="line">#171205 10:35:43 server id 3306114  end_log_pos 120 CRC32 0x7d7e496c    Start: binlog v 4, server v 5.6.34-log created 171205 10:35:43</span><br><span class="line"># at 120</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 201 CRC32 0x24d309ef    Query  thread_id=2    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1512442165/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=2/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=1075838976/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=2, @@session.auto_increment_offset=2/*!*/;</span><br><span class="line">/*!\C utf8 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=83/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 201</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 265 CRC32 0xef0e9a3a    Rows_query</span><br><span class="line"># insert into test1(`name`) values(&apos;woqu&apos;)</span><br><span class="line"># at 265</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 320 CRC32 0xf86a076e    Table_map: `gangshen`.`test1` mapped to number 70</span><br><span class="line"># at 320</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 365 CRC32 0x653b8de4    Write_rows: table id 70 flags: STMT_END_F</span><br><span class="line">### INSERT INTO `gangshen`.`test1`</span><br><span class="line">### SET</span><br><span class="line">###  @1=4 /* INT meta=0 nullable=0 is_null=0 */</span><br><span class="line">###  @2=&apos;woqu&apos; /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><br><span class="line"># at 365</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 396 CRC32 0x53ca8e9d    Xid = 24</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line">............</span><br><span class="line"># at 705</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 786 CRC32 0x815b7a14    Query  thread_id=2    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1512442220/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 786</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 854 CRC32 0xc265e50d    Rows_query</span><br><span class="line"># delete from test1 where name = &apos;woqu-change&apos;</span><br><span class="line"># at 854</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 909 CRC32 0x3a62ecaf    Table_map: `gangshen`.`test1` mapped to number 70</span><br><span class="line"># at 909</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 961 CRC32 0x2bf4c689    Delete_rows: table id 70 flags: STMT_END_F</span><br><span class="line">### DELETE FROM `gangshen`.`test1`</span><br><span class="line">### WHERE</span><br><span class="line">###  @1=4 /* INT meta=0 nullable=0 is_null=0 */</span><br><span class="line">###  @2=&apos;woqu-change&apos; /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><br><span class="line"># at 961</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 992 CRC32 0x412de6a3    Xid = 28</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 992</span><br><span class="line">#171205 10:50:23 server id 3306114  end_log_pos 1039 CRC32 0x8372f001  Rotate to mysql-bin.000005  pos: 4</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure>
<p>可以看到第一个event是FORMAT_DESCRIPTION_EVENT,记录了binlog的版本为v4。最后一个event，是ROTATE_EVENT，它记录了下一个binlog文件的文件名以及对应的位置点。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>官方文档复制章节：<a href="https://dev.mysql.com/doc/refman/5.7/en/replication.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/replication.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/12/MySQL日常问题两则/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/12/MySQL日常问题两则/" class="post-title-link" itemprop="url">MySQL日常问题两则</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-12 11:08:13" itemprop="dateCreated datePublished" datetime="2019-08-12T11:08:13+08:00">2019-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>近期在给开发小伙伴解决问题的时候，收集了两个个人觉得比较有意思的问题给大家分享一下。一个是在执行ALTER TABLE ADD COLUMN语句时，报了Duplicate entry的错误；另一个是关于在MySQL中正确存取emoji表情的问题。</p>
<h2 id="2-ALTER-TABLE-ADD-COLUMN报Duplicate-entry错误"><a href="#2-ALTER-TABLE-ADD-COLUMN报Duplicate-entry错误" class="headerlink" title="2. ALTER TABLE ADD COLUMN报Duplicate entry错误"></a>2. ALTER TABLE ADD COLUMN报Duplicate entry错误</h2><h3 id="2-1-问题描述"><a href="#2-1-问题描述" class="headerlink" title="2.1 问题描述"></a>2.1 问题描述</h3><p>某日系统上线，接到开发小伙伴电话说在上线时，执行一个增加字段的DDL语句脚本时，报错了，错误如下:<br><code>ERROR 1062 (23000) at line 1: Duplicate entry &#39;UR000021426347&#39; for key &#39;T_CAP_CUST_MIDDLE_INFO_UNIQ_INDEX&#39;</code><br>根据错误提示的条件去数据库中查询却只能查到一条记录，并没有重复记录。DDL脚本无法执行，影响后续上线步骤了。当时由于不在现场，了解到的信息只有：</p>
<ol>
<li>DDL语句脚本中只有两条DDL语句，且都是添加字段的语句 </li>
<li>脚本正常运行只需要40-70秒，</li>
<li>当时并不是停业窗口。</li>
</ol>
<p>考虑到数据库版本为5.6.34，添加字段并不会阻塞DML操作，让开发小伙伴再运行一次试试，结果这次执行成功了，并没有报冲突的错误。线上问题顺利解决，具体原因得线下分析了。虽说解决问题是主要矛盾，但是搞清楚问题原因有着更深层次的意义。</p>
<h3 id="2-2-原因定位"><a href="#2-2-原因定位" class="headerlink" title="2.2 原因定位"></a>2.2 原因定位</h3><p>下面就是到了寻找问题原因的时候了，为什么同样的DDL语句脚本第一次执行的时候报了Duplicate entry错误，第二次却顺利运行了。其实问题原因很好找，打开Google，输入关键字<code>mysql alter table add column duplicate entry</code>，搜索结果中很多关键字完全匹配的链接，说明很多人遇到过相同问题。搜索结果中一眼就看到一个链接<a href="https://bugs.mysql.com/bug.php?id=76895" target="_blank" rel="noopener">MySQL Bugs:#76895:Adding new column OR Drop column causes duplicate PK error</a>，看到MySQL Bug就莫名兴奋。通过该Bug链接了解到该问题是Online DDL的一个限制问题，官方认为该问题是一种限制，并不是Bug，所以目前为止还没有得到解决。</p>
<blockquote>
<p>When running an online DDL operation, the thread that runs the ALTER TABLE statement applies an online log of DML operations that were run concurrently on the same table from other connection threads. When the DML operations are applied, it is possible to encounter a duplicate key entry error (ERROR 1062 (23000): Duplicate entry), even if the duplicate entry is only temporary and would be reverted by a later entry in the online log. This is similar to the idea of a foreign key constraint check in InnoDB in which constraints must hold during a transaction.</p>
</blockquote>
<p>解释一下就是当执行Oline DDL操作时，MySQL实际上是将DML缓存（该缓存大小由变量 innodb_online_alter_log_max_size控制，默认128M）起来，等DDL执行完成后再将缓存中的DML重新应用到表上。如果有别的线程执行了DML操作，在DDL完成后，应用DML时，可能会出现duplicate entry错误。</p>
<h3 id="2-3-实验验证"><a href="#2-3-实验验证" class="headerlink" title="2.3 实验验证"></a>2.3 实验验证</h3><p>上面通过Google找到了理论上可能能解释问题的原因描述，但是还没有实际验证，所以接下来就是线下复现环节。先去找开发同事问了下线上报错的表只有一种操作<code>insert into ... on duplicate key...</code>，且报Duplicate entry的字段上有唯一索引。如果没有冲突的记录则插入，否则就更新。那么验证测试步骤也比较简单了，找一张测试表，执行ALTER TABLE ADD COLUMN操作，并同时执行insert into…on duplicate key…操作，观察DDL语句是否会有报错。</p>
<h4 id="2-3-1-实验环境"><a href="#2-3-1-实验环境" class="headerlink" title="2.3.1 实验环境"></a>2.3.1 实验环境</h4><ul>
<li>redhat-6.7/redhat-7.4</li>
<li>MySQL-5.6.34/MySQL-5.7.22</li>
</ul>
<h4 id="2-3-2-操作步骤"><a href="#2-3-2-操作步骤" class="headerlink" title="2.3.2 操作步骤"></a>2.3.2 操作步骤</h4><ul>
<li>准备测试环境</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809095927.png" height="50%" width="50%"></p>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809095941.png" height="50%" width="50%"></p>
<p>col1字段的值与id字段的值是一致的，test表中共有1600W+条记录。</p>
<ul>
<li>执行DDL同时执行insert into … on duplicate key…操作</li>
</ul>
<table>
<thead>
<tr>
<th>序号</th>
<th>会话1</th>
<th>会话2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>select * from test limit 10;<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809095447.png" height="600px" width="200px"></td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>-</td>
<td>alter table test add column address varchar(50) default ‘HangZhou’;</td>
</tr>
<tr>
<td>3</td>
<td>insert into test (name,col1) values(‘san.zhang’,7) on duplicate key update col1=29;<br>ERROR 1062 (23000): Duplicate entry ‘29’ for key ‘col1’</td>
<td>-</td>
</tr>
<tr>
<td>4</td>
<td>-</td>
<td>DDL执行报错，检查发现DDL执行失败<br>ERROR 1062 (23000): Duplicate entry ‘7’ for key ‘col1’</td>
</tr>
<tr>
<td>5</td>
<td>查询test表中数据<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809100059.png" height="400px" width="600px"></td>
<td>-</td>
</tr>
</tbody>
</table>
<p>顺利的复现了线上的问题现象，那说明当时线上就是因为DML更新了相同的唯一属性字段键值导致DDL执行失败，报错。测试过程中想到insert into… on duplicate key…不行，那么replace into 会不会也一样导致问题呢，于是就同样对replace into语句进行了测试。</p>
<ul>
<li>执行DDL同时执行replace into操作</li>
</ul>
<table>
<thead>
<tr>
<th>序号</th>
<th>会话1</th>
<th>会话2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>select * from test limit 10;<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809104744.png" height="600px" width="200px"></td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>-</td>
<td>alter table test add column address varchar(50) default ‘HangZhou’;</td>
</tr>
<tr>
<td>3</td>
<td>replace into test(id,name,col1) values(1,’gang.shen’,13);<br>Query OK, 3 rows affected (0.00 sec)</td>
<td>-</td>
</tr>
<tr>
<td>4</td>
<td>-</td>
<td>DDL执行报错，检查发现DDL执行失败<br>ERROR 1062 (23000): Duplicate entry ‘13’ for key ‘col1’</td>
</tr>
<tr>
<td>5</td>
<td>select *  from test where col1=13;<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809104942.png" height="100px" width="600px"></td>
<td>-</td>
</tr>
</tbody>
</table>
<ul>
<li>后续以同样方式测试了UPDATE、INSERT操作，实验证明都会影响DDL操作的正确执行，在5.7.22版本上也是一样的现象。这边出于篇幅考虑就不将测试过程给出了，感兴趣的读者可以自己实验一把，并且可以验证下在8.0版本中是否仍然存在该问题。</li>
</ul>
<h3 id="2-4-小结"><a href="#2-4-小结" class="headerlink" title="2.4 小结"></a>2.4 小结</h3><p>在这对这个问题做几点总结：</p>
<ul>
<li>问题原因：Oline DDL的原理简单一点理解就是将DML操作缓存起来，等到DDL执行完成后重新应用缓存中的DML语句，如果在Oline DDL执行过程中，DML操作产生了Duplicate entry错误，并不会直接影响DDL操作，而是在DDL执行完成最终应用DML时报错，导致DDL执行失败。关于Oline DDL执行步骤可以参考：<a href="https://yq.aliyun.com/articles/282290" target="_blank" rel="noopener">https://yq.aliyun.com/articles/282290</a>。</li>
<li>在MySQL Bug网站上，官方人员回复该现象并不是Bug，而是一种限制。但是个人认为是可以做一些改善的，因为在测试insert into … on duplicate key…以及update和insert语句时，对于执行DML操作的客户端已经直接返回报错了，但是从现象上看MySQL仍然将报错的DML语句放到了Oline DDL的缓存中，如果直接将报错语句从缓存中去除则不会影响DDL的正常执行。这只是个人简单认为，深入的话需要可以通过代码去确认。</li>
<li>Google是位好老师</li>
</ul>
<h2 id="3-MySQL存取emoji的正确姿势"><a href="#3-MySQL存取emoji的正确姿势" class="headerlink" title="3. MySQL存取emoji的正确姿势"></a>3. MySQL存取emoji的正确姿势</h2><h3 id="3-1-问题描述"><a href="#3-1-问题描述" class="headerlink" title="3.1 问题描述"></a>3.1 问题描述</h3><p>开发小伙伴在测试环境测试过程中，需要往MySQL数据库中插入emoji表情，但是发现一套测试环境可以插入成功，另一套测试环境不行，且插入成功的那套环境数据库将数据查询出来是<code>????</code>乱码。经过与开发确认后了解到以下几点信息：</p>
<ul>
<li>表中只有一个字段需要存放emoji表情，开发对该字段单独设置了utf8mb4字符集</li>
<li>可以成功插入成功的测试环境数据库版本为5.6.34，无法插入的测试环境数据库版本为5.7.22</li>
<li>应用连接代码中使用的是utf8字符集</li>
</ul>
<p>那其实需要解决的问题其实是两个问题：1、5.6版本下emoji存取乱码问题 2、5.7版本emoji无法插入的问题</p>
<h3 id="3-2-实验验证"><a href="#3-2-实验验证" class="headerlink" title="3.2 实验验证"></a>3.2 实验验证</h3><h4 id="3-2-1-MySQL-5-6-emoji存取乱码问题"><a href="#3-2-1-MySQL-5-6-emoji存取乱码问题" class="headerlink" title="3.2.1 MySQL-5.6 emoji存取乱码问题"></a>3.2.1 MySQL-5.6 emoji存取乱码问题</h4><p>我们先来看5.6版本下emoji存储乱码的问题，理论上从数据库角度考虑，字段字符集已经设置为utf8mb4，应用使用的是utf8字符集连接，插入emoji需要utf8mb4字符集，多半是连接字符集设置的问题。大胆假设已经完成，接下来就是小心求证的过程。</p>
<blockquote>
<p>实验环境</p>
<ul>
<li>数据库版本：5.6.44</li>
<li>sql_mode=’NO_ENGINE_SUBSTITUTION’</li>
<li>default-character-set=utf8</li>
</ul>
</blockquote>
<ul>
<li>使用utf8字符集连接MySQL，并检查参数设置</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809212132.png" height="50%" width="50%"></p>
<ul>
<li>创建测试表</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809212449.png" height="50%" width="50%"></p>
<ul>
<li>插入emoji表情</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809212941.png" height="50%" width="50%"></p>
<p>表情的确能插入数据库，但是insert时有两条warning记录提示是invalid的字符串，并且select查询出来的数据也是一样<code>????</code>乱码</p>
<ul>
<li>使用utf8mb4字符集插入emoji表情并查询</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809213245.png" height="50%" width="50%"><br>可以看到连接使用utf8mb4字符集插入、查询emoji表情都是正常的，插入时也没有warning提示，那说明emoji乱码的问题就是因为连接字符集设置不合理导致的。</p>
<h4 id="3-2-2-MySQL-5-7-emoji无法插入的问题"><a href="#3-2-2-MySQL-5-7-emoji无法插入的问题" class="headerlink" title="3.2.2 MySQL-5.7 emoji无法插入的问题"></a>3.2.2 MySQL-5.7 emoji无法插入的问题</h4><p>定位了乱码的问题，再来看看emoji无法插入的问题。</p>
<blockquote>
<p>实验环境</p>
<ul>
<li>数据库版本：5.7.22</li>
<li>sql_mode=’ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION’</li>
<li>default-character-set=utf8</li>
</ul>
</blockquote>
<ul>
<li>使用utf8字符集连接MySQL，并检查参数设置</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809214109.png" height="50%" width="50%"></p>
<ul>
<li>创建测试表</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809212449.png" height="50%" width="50%"></p>
<ul>
<li>插入emoji表情</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809214254.png" height="50%" width="50%"></p>
<p>插入的时候直接报错了，同样的字符集，同样的语句，5.6版本下emoji就能插入，5.7就直接报错了。5.6-&gt;5.7数据库版本问题，如果踩坑比较多的话，还是比较容易联想到是不是sql_mode参数的问题，因为5.7中sql_mode参数默认值多了很多项，对语句的限制加强了很多。</p>
<ul>
<li>查看sql_mode参数默认值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%sql_mode%&apos;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Variable_name: sql_mode</span><br><span class="line">        Value: ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>查看官方文档关于各个sql_mode选项的值，找到了怀疑对象STRICT_TRANS_TABLES，表示开启严格模式，严格模式下如果插入的数据不在范围之类会报错中断语句。</p>
<ul>
<li>修改sql_mode参数值，再次插入emoji表情测试</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set session sql_mode=&apos;ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809220506.png" height="50%" width="50%"></p>
<p>可以看到修改sql_mode值后，现象与5.6版本下一致</p>
<ul>
<li>使用utf8mb4字符集插入emoji表情并查询</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190809213245.png" height="50%" width="50%"></p>
<h3 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h3><p>在此对emoji问题做一下小结：</p>
<ul>
<li>MySQL中存储emoji不仅需要将表结构中字段字符集设置为utf8mb4，还需要考虑连接字符集的问题</li>
<li>建议数据库使用5.7.22及以上版本，并且sql_mode开启严格模式，这样当数据出现异常可以及时发现</li>
<li>在sql_mode开启严格模式的情况下，应用端连接数据库也需要调整为utf8mb4字符集才可以正常插入emoji表情</li>
<li>建议将默认字符集设置为utf8mb4，做到库、表、字段字符集都统一，utf8mb4是utf8的超集，能兼容更多的字符，而且在MySQL-8.0中已经将utf8mb4设置为了默认的字符集。</li>
</ul>
<blockquote>
<p>博客地址：<a href="https://win-man.github.io/" target="_blank" rel="noopener">https://win-man.github.io/</a><br>公众号：欢迎关注  </p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2018/8/16/165435ce71d2b88b?w=258&amp;h=258&amp;f=jpeg&amp;s=26568" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/09/MySQL8.0之跳跃范围扫描/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/09/MySQL8.0之跳跃范围扫描/" class="post-title-link" itemprop="url">MySQL8.0之跳跃范围扫描</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-09 21:12:13" itemprop="dateCreated datePublished" datetime="2019-03-09T21:12:13+08:00">2019-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>跳跃范围扫描是MySQL在8.0.13版本新增加的用于提高性能的新特性，跳跃范围扫描可以使以前部分无法使用到联合索引的SQL利用联合索引进行查询，并且可以更高效的利用联合索引，这对于使用MySQL联合索引进行查询的应用意义重大。</p>
<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul>
<li>MySQL版本：8.0.15</li>
<li>操作系统版本：redhat-7.4</li>
</ul>
<h2 id="跳跃范围扫描"><a href="#跳跃范围扫描" class="headerlink" title="跳跃范围扫描"></a>跳跃范围扫描</h2><p>通过一个示例来解释跳跃范围扫描：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t1 (f1 INT NOT NULL, f2 INT NOT NULL, PRIMARY KEY(f1, f2));</span><br><span class="line">INSERT INTO t1 VALUES(1,1), (1,2), (1,3), (1,4), (1,5),(2,1), (2,2), (2,3), (2,4), (2,5);</span><br><span class="line">INSERT INTO t1 SELECT f1, f2 + 5 FROM t1;</span><br><span class="line">INSERT INTO t1 SELECT f1, f2 + 10 FROM t1;</span><br><span class="line">INSERT INTO t1 SELECT f1, f2 + 20 FROM t1;</span><br><span class="line">INSERT INTO t1 SELECT f1, f2 + 40 FROM t1;</span><br><span class="line">ANALYZE TABLE t1;</span><br><span class="line">EXPLAIN SELECT f1, f2 FROM t1 WHERE f2 &gt; 40\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: t1</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 8</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 53</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using index for skip scan</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select version();</span><br><span class="line">+-----------+</span><br><span class="line">| version() |</span><br><span class="line">+-----------+</span><br><span class="line">| 8.0.15 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在这个示例中，<code>SELECT f1,f2 FROM t1 WHERE f2&gt;40</code>在8.0.13版本之前是通过索引全扫描的方式来获取最终的结果集，因为SELECT查询的字段全部都是索引的组成部分。MySQL通过索引全扫描获取所有的行记录，然后通过<code>f2 &gt; 40</code>这个条件过滤，最终筛选出结果集返回给客户端。</p>
<p>众所周知，索引范围扫描的效率肯定是要高于索引全扫描的，在这个示例中，虽然查询条件是<code>f2 &gt; 40</code>，属于范围查询，但是WHERE条件中不包含<code>f1</code>字段的的条件，所以无法使用索引范围扫描的方式过滤数据。在MySQL-8.0.13版本增加的跳跃范围扫描特性，就是针对类似的场景的优化，跳跃范围扫描在这个示例中实际是针对每一个<code>f1</code>字段的值，进行了范围扫描，即进行了多次范围扫描。</p>
<p>针对这个示例，具体的跳跃范围扫描过程如下：</p>
<ol>
<li>获取联合索引中第一个字段<code>f1</code>的第一个值：<code>f1 = 1</code></li>
<li>将获取到的值和WHERE条件中的<code>f2</code>的条件组合：<code>f1 = 1 AND f2 &gt; 40</code></li>
<li>执行这个范围扫描查询</li>
<li>获取联合索引中第一个字段<code>f1</code>的第二个值：<code>f1 = 2</code></li>
<li>将获取到的值和WHERE条件中的<code>f2</code>的条件组合：<code>f1 = 2 AND f2 &gt; 40</code></li>
<li>执行这个范围扫描查询</li>
<li>将两次范围扫描查询的结果合并返回给客户端</li>
</ol>
<p>跳跃范围扫描实际就是将一些全扫描的场景拆分成多个范围扫描，利用范围扫描的效率高于全扫描的效率，最终实现提高SQL效率。</p>
<p>在这个示例中，比较有跳跃范围扫描特性的SQL执行计划以及没有跳跃范围扫描特性的SQL执行计划：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 有跳跃范围扫描特性</span><br><span class="line">mysql&gt; EXPLAIN SELECT f1, f2 FROM t1 WHERE f2 &gt; 40\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: t1</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 8</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 53</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using index for skip scan</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 没有跳跃范围扫描特性</span><br><span class="line">mysql&gt; EXPLAIN SELECT f1, f2 FROM t1 WHERE f2 &gt; 40\G </span><br><span class="line"> *************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: t1</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: index</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 8</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 160</span><br><span class="line">     filtered: 33.33</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>通过执行计划可以看到,有跳跃范围扫描特性的查询扫描的行数更少且过滤性更高。</p>
<h2 id="使用限制以及场景"><a href="#使用限制以及场景" class="headerlink" title="使用限制以及场景"></a>使用限制以及场景</h2><p>下面来说说跳跃范围扫描使用一些限制以及场景：</p>
<ul>
<li>表上至少存在一个联合索引<code>([A_1,A_2...A_k],B_1,B_2...B_m,C,[,D_1,...,D_n])</code>，其中A部分以及D部分可以为空，但是B和C部分不能为空。A_1,A_2..等代表字段值</li>
<li>只针对单表查询</li>
<li>查询中不包含<code>GROUP BY</code>或者<code>DISTINCT</code></li>
<li>SELECT查询的字段全部被包含在索引组成部分，即符合覆盖索引规范</li>
<li>前缀<code>A_1,A_2...A_k</code>部分必须是可以被相等的常量</li>
<li>字段C上必须是一个范围条件，大于或大于等于，小于或小于等于</li>
<li>允许在D字段上有过滤条件，但是必须和C上的范围条件一起使用</li>
</ul>
<p>跳跃范围扫描默认是开启的，有两种方式可以关闭跳跃范围扫描特性：</p>
<ul>
<li>通过修改<code>optimizer_switcher</code>变量值，默认MySQL是将<code>optimizer_switcher</code>中的<code>skip_scan</code>设置为on的，可以通过将<code>skip_scan</code>设置为off关闭跳跃范围扫描</li>
<li>通过Hint的方式关闭跳跃范围扫描特性：<code>SELECT/*+ NO_SKIP_SCAN(t1 PRIMARY) */ f1, f2 FROM t1 WHERE f2 &gt; 40;</code></li>
</ul>
<p>对于使用了跳跃范围扫描特性的SQL，使用EXPLAIN查看其执行计划，可以看到：</p>
<ul>
<li>在执行计划输出的Extra一栏中有：<code>Using index for skip scan</code></li>
<li>在执行计划输出的possible_keys一栏中会显示可以使用到的索引</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>跳跃范围扫描是对使用MySQL联合索引查询的SQL意义重大，能在使SQL查询效率更高，但是并不是使用到跳跃范围扫描就能代表SQL执行效率更高。在MySQL一些开发规范中，一般要求建立联合索引时将重复值少的字段放在联合索引前面，将重复值多的字段放在联合索引后面，方便SQL在使用联合索引时通过前面的字段快速过滤结果。但是在跳跃范围扫描特性中，是遍历前面字段的值，与后续字段的范围查询条件组合，进行范围扫描查询，那对于重复值少的字段会被拆分成多个范围扫描查询，在实际使用过程中并不一定会比索引全扫描效率更高。</p>
<p>所以个人觉得跳跃范围扫描适用于联合索引中前导列distinct值较少，后续字段选择过滤性又比较好的场景，能更好的发挥跳跃范围扫描的作用。</p>
<blockquote>
<p>博客地址：<a href="https://win-man.github.io/" target="_blank" rel="noopener">https://win-man.github.io/</a><br>公众号：欢迎关注  </p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2018/8/16/165435ce71d2b88b?w=258&amp;h=258&amp;f=jpeg&amp;s=26568" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/04/2018总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/04/2018总结/" class="post-title-link" itemprop="url">2018总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-04 21:12:13" itemprop="dateCreated datePublished" datetime="2019-02-04T21:12:13+08:00">2019-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂/" itemprop="url" rel="index"><span itemprop="name">杂</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>写年终总结的第三年，虽然拖延症一年比一年严重，年终总结写的越来越迟，但是该总结的还是要总结的，于是就有了这篇在一片爆竹声中写下的总结。在开始写这篇总结之前看了下2016年和2017年的总结。嗯，每年年初立下的flag，都变成了狠狠的打脸。</p>
<h2 id="过去"><a href="#过去" class="headerlink" title="过去"></a>过去</h2><p>回过头看看2018年，发生了很多事情，很多事情对我打击很大，也让我重新认识了我自己劣质的本性。2018年感谢一个人进入我的生命，带给我很多，但是遗憾的是最终因为我的原因，这个人离开了我的生活。其实觉得很对不起，但是没办法回头了。时间继续走，我继续浑浑噩噩的前行着。</p>
<p>2018这一年，在技术上的成长，让人失望，没有开辟新的技术栈，对于原先的技术栈也没有进一步掌握。立志学Go，学K8S，结果到现在都是半桶水只能往外报名词，一点干货没有。知道要学习新的技术，知道要系统性的进行学习，知道工作之后学习需要自己挤出时间来，但是知行合一难。2018年终于对知行合一有了一个新的认识。之前是在大学中了解王阳明的时候了解到知行合一这个概念的，但是对其没有什么概念。今年突然理解了这个，知行合一最能解释“听过很多道理，但是任然过不好这一生”，个人认知和个人行为的高度统一才能将一件事情做成。2018年我从意识上都清楚的知道，多学习、多锻炼对自己好，但是行为上表现的就是沉迷于娱乐无法自拔。知易行艰。</p>
<p>2018这一年，在工作上承担了很多责任也承担了很多压力，有机会向上前进了一点，虽说得到这个机会的代价有点大。正好可以通过疯狂的投入到工作中去来忘记一些事情。2018年的工作中规中矩，没有特别让自己满意的地方。</p>
<p>2018这一年，减肥、保持健康是失败的。办了健身卡，去健身房的频率平均下来能达到每周一次，没有坚持的效果。体重奔着160去了，能感觉到自己的肚子了，每个看到的人都能说我胖了。知易行艰。</p>
<p>2018这一年，文章没多写，搞了个人公众号，目前苦于没有文章可以发。</p>
<p>2018这一年，自制力下降了，但是最近在使用FOREST这个app，目前觉得效果不错。其实这个app之前限免的时候下载过，当时的自己自制力还算可以，觉得对自己的作用不大，但是对于现在的我，这个app效果太明显了，通过苹果手机的屏幕使用时间统计，每周屏幕使用时间都以60%~80%的趋势往下降。希望能坚持住，能提升自己的自制力。</p>
<p>2018这一年，没有实现任何一个2017年立下的flag（逃</p>
<h2 id="未来"><a href="#未来" class="headerlink" title="未来"></a>未来</h2><p>惯例立flag，带着目的前进：</p>
<ul>
<li>把工作做好，争取升P</li>
<li>Go、k8s、SQL优化技术栈需要补全，MySQL、Linux、分布式技术栈需要加强</li>
<li>20本书</li>
<li>体重减到140斤</li>
<li>多写文章，多总结</li>
<li>想找个女朋友</li>
<li>培养理财意识，学习理财知识</li>
</ul>
<p>最后，但行好事，莫问前程。</p>
<blockquote>
<p>博客地址：<a href="https://win-man.github.io/" target="_blank" rel="noopener">https://win-man.github.io/</a><br>公众号：欢迎关注  </p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2018/8/16/165435ce71d2b88b?w=258&amp;h=258&amp;f=jpeg&amp;s=26568" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/30/MySQL数据恢复新姿势/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/30/MySQL数据恢复新姿势/" class="post-title-link" itemprop="url">MySQL数据恢复新姿势</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-30 21:12:13" itemprop="dateCreated datePublished" datetime="2018-11-30T21:12:13+08:00">2018-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><h3 id="1-1、需求来源"><a href="#1-1、需求来源" class="headerlink" title="1.1、需求来源"></a>1.1、需求来源</h3><blockquote>
<p>需要给客户将生产环境的数据恢复到测试环境，但是线上环境的xtrabackup全备数据量太大，拷贝下来比较麻烦，并且需要恢复的数据只有整库中的两张表的数据，所以客户只是将全备中的对应表的ibd文件以及frm文件拷贝下来了，要求根据ibd文件以及frm文件进行数据恢复。</p>
</blockquote>
<h3 id="1-2、环境介绍"><a href="#1-2、环境介绍" class="headerlink" title="1.2、环境介绍"></a>1.2、环境介绍</h3><ul>
<li>数据库版本：MySQL-5.7.22</li>
<li>数据库要求：innodb_file_per_table=1</li>
</ul>
<h2 id="二、解决方案步骤"><a href="#二、解决方案步骤" class="headerlink" title="二、解决方案步骤"></a>二、解决方案步骤</h2><h3 id="2-1、准备工作"><a href="#2-1、准备工作" class="headerlink" title="2.1、准备工作"></a>2.1、准备工作</h3><ul>
<li>准备好需要进行数据恢复的表ibd文件以及frm文件</li>
<li>安装一个新的MySQL实例<ul>
<li>innodb_file_per_table</li>
<li>安装步骤省略</li>
</ul>
</li>
</ul>
<h3 id="2-2、表结构恢复"><a href="#2-2、表结构恢复" class="headerlink" title="2.2、表结构恢复"></a>2.2、表结构恢复</h3><ul>
<li>在数据库中创建一张表名与被恢复表表名一致的表，表结构不限制</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505160614.png" alt></p>
<ul>
<li>将新建表的ibd文件以及frm文件拷贝到tmp目录下备份</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cp message_index.* /tmp/</span><br></pre></td></tr></table></figure>
<ul>
<li>使用被恢复的frm文件替换新创建的同名表的frm文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cp /data2/message_index.frm ./</span><br><span class="line">cp：是否覆盖&quot;./message_index.frm&quot;？ y</span><br><span class="line"># chown -R mysql:mysql ./*</span><br></pre></td></tr></table></figure>
<ul>
<li>在数据库中执行show create table语句<br>注意需要在show create table 查看表结构之前执行flush tables语句，因为如果message_index表之前被打开过，那么表结构会被缓存在内存中，show create table不会报错，也就无法从错误日志中拿到我们需要的信息。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505160723.png" alt></p>
<ul>
<li>查看error.log，获取被恢复表的字段数<br>错误日志中会打印我们需要恢复的表的字段数，这边可以看到我们需要恢复的表中含有6个字段</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505160758.png" alt></p>
<ul>
<li>删除message_index表，并重新创建message_index表</li>
</ul>
<p>从上面的步骤中我们知道被恢复表中含有6个字段，所以重新创建的message_index表需要含有6个字段，字段名以及字段类型不限制</p>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505160924.png" alt></p>
<ul>
<li>再次使用被恢复的frm文件替换新创建的同名表的frm文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cp /data2/message_index.frm ./</span><br><span class="line">cp：是否覆盖&quot;./message_index.frm&quot;？ y</span><br><span class="line"># chown -R mysql:mysql ./*</span><br></pre></td></tr></table></figure>
<ul>
<li>在MySQL配置文件中添加innodb_force_recovery=6，并重启数据库</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505161041.png" alt></p>
<ul>
<li>通过show create table语句拿到message_index表的表结构</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505161054.png" alt></p>
<p>至此，我们就拿到了我们需要进行恢复的表的表结构。</p>
<h3 id="2-3、表数据恢复"><a href="#2-3、表数据恢复" class="headerlink" title="2.3、表数据恢复"></a>2.3、表数据恢复</h3><p>拿到表结构之后，表数据恢复步骤相对表结构恢复步骤而言会简单一些</p>
<ul>
<li>将innodb_force_recovery=6从配置文件中去掉、使用/tmp目录下的ibd文件以及frm文件覆盖当前的对应文件、重启数据库</li>
<li>在数据库中按照获取到的表结构新建一张message_index表</li>
<li>执行<code>alter table discard tablespace</code>语句</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table message_index discard tablespace;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505161116.png" alt></p>
<ul>
<li><p>将要恢复的表的ibd文件拷贝到当前库下，并更改属主以及属组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown -R mysql:mysql ./*</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行alter table import tablespace语句</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table message_index import tablespace;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20190505161139.png" alt></p>
<p>可以看到数据已经都恢复回来了。</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><ul>
<li>以上我们通过xtrabackup全备中的ibd文件以及frm文件恢复了数据，这样也就代表着xtrabackup就算备份失败，只要有部分ibd文件以及frm文件保证完好，MySQL也是可以进行数据恢复的，在极端情况下也能尽可能的减少损失。但是由于xtrabackup是通过记录redo日志的方式来保存备份过程中产生的增量数据，这一部分增量数据目前还没有办法恢复。</li>
<li>导入表空间的方式，也给MySQL大数据量迁移方案提供了一种思路：直接拷贝ibd文件的方式</li>
</ul>
<blockquote>
<p>博客地址：<a href="https://win-man.github.io/" target="_blank" rel="noopener">https://win-man.github.io/</a><br>公众号：欢迎关注  </p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2018/8/16/165435ce71d2b88b?w=258&amp;h=258&amp;f=jpeg&amp;s=26568" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Win-Man"
      src="/images/pig.jpeg">
  <p class="site-author-name" itemprop="name">Win-Man</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Win-Man" title="GitHub → https://github.com/Win-Man" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gang.shen0423@gmail.com" title="E-Mail → mailto:gang.shen0423@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/2855803080" title="Weibo → https://weibo.com/2855803080" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://blog.csdn.net/win_man" title="http://blog.csdn.net/win_man" rel="noopener" target="_blank">CSDN博客</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Win-Man</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1260159928&web_id=1260159928"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
