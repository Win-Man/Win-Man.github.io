<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Win-Man&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Win-Man&#39;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Win-Man&#39;s Blog">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>Win-Man's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Win-Man's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/049-go-grpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/049-go-grpc/" class="post-title-link" itemprop="url">Go 实现 gRPC 服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-29 16:50:13" itemprop="dateCreated datePublished" datetime="2020-03-29T16:50:13+08:00">2020-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Go-实现-gRPC-服务"><a href="#Go-实现-gRPC-服务" class="headerlink" title="Go 实现 gRPC 服务"></a>Go 实现 gRPC 服务</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>最近学习了一下 gRPC 在 Go 中的实现，做一些记录。</p>
<h3 id="gRPC-是什么"><a href="#gRPC-是什么" class="headerlink" title="gRPC 是什么"></a>gRPC 是什么</h3><p>讲 gRPC 之前，可以先讲一下 RPC(Remote Procedure Call) 远程过程调用，它能让客户端直接类似于调用本地方法一样调用服务端的方法。gRPC 是 Google 开源的一款高性能 RPC 框架。</p>
<p>gRPC 中主要有四种请求/响应模式：</p>
<ul>
<li>普通 RPC</li>
<li>服务端流式 RPC</li>
<li>客户端流式 RPC</li>
<li>服务端/客户端双向流式 RPC</li>
</ul>
<h3 id="gRPC-好处"><a href="#gRPC-好处" class="headerlink" title="gRPC 好处"></a>gRPC 好处</h3><p>RPC 一般是建立在 TCP 或者 HTTP 网络连接之上的，是一个框架，所以对于开发者而言，如果使用 RPC 去实现服务端与客户端的通信，基本可以不考虑网络协议、连接等内容，专注与处理逻辑。</p>
<p>使用 gRPC 的话，可以将我们的服务定义在 .proto 文件中，然后在任何一种支持 gRPC 的语言中实现客户端和服务端，这可以让服务端和客户端运行在不同的环境中，另外使用 gRPC 还有其他的好处：高效序列化与反序列化、简单的 IDL 语言、方便接口更新</p>
<h2 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h2><p>已官方的 helloworld 作为例子进行讲解，<a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld" target="_blank" rel="noopener">示例</a></p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li>Mac 安装 protoc 编译器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install protobuf</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 protoc 编译器插件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>
<h3 id="定义服务"><a href="#定义服务" class="headerlink" title="定义服务"></a>定义服务</h3><p>gRPC 是通过 Protocol Buffers 去定义 gRPC 相关的 service 服务以及请求和响应相关的类型，如果对 Protocol Buffer 不熟悉的，其实也没什么关系，直接看 protoc 文件也是比较容易看懂的。如果对 Protocol Buffer 想深入了解的 ，可以参考这个链接:  <a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="noopener">Protocol Buffers</a></p>
<p>创建 helloworld.proto 文件，并填写以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package protos;</span><br><span class="line"></span><br><span class="line">// The greeting service definition.</span><br><span class="line">service Greeter &#123;</span><br><span class="line">	// Sends a greeting</span><br><span class="line">	rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// The request message containing the user&apos;s name.</span><br><span class="line">message HelloRequest &#123;</span><br><span class="line">	string name = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// The response message containing the greetings</span><br><span class="line">message HelloReply &#123;</span><br><span class="line">	string message = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来解释一下上面的代码：</p>
<ul>
<li>第一行 <code>syntax = &quot;proto3&quot;</code> 表示目前使用的是 proto3 的语法</li>
<li>通过 service 关键字定义了一个 Greeter 服务，且这个服务目前只有 SayHello 一个方法，SayHello 这个方法会接收一个 HelloRequest 类型的消息，并返回一个 HelloReply 类型的消息</li>
<li>通过 message 关键字定义了 HelloRequest 类型消息的结构是什么样的，上述代码中，HelloRequest 消息结构只有一个字段，是 string 类型</li>
<li>通过 message 关键字定义了 HelloReply 类型消息的结构是什么样的，上述代码中，HelloReply 消息结构只有一个字段，是 string 类型</li>
<li>定义消息结构字段的时候，需要指定字段的字段编号，比如 <code>string name = 1</code> 中，1 就是字段编号，这个字段编号是一个唯一的数字，作用是在二进制消息体中表示字段用的</li>
<li>定义消息结构字段时，需要制定更多数据类型的话，可以参考链接：<a href="https://developers.google.com/protocol-buffers/docs/proto3" target="_blank" rel="noopener">Language Guide (proto3)</a></li>
</ul>
<p>在 proto 文件中完成定义 gRPC 的服务方法和消息之后，我们就可以来生成 gRPC 通信中服务端与客户端的接口了，这个时候就需要我们之前安装的 protoc 以及 protoc-gen-go 工具了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ protoc --go_out=plugins=grpc:. helloworld.proto</span><br><span class="line"></span><br><span class="line">--go_out 表示指定最终生成文件的输出路径，. 表示生成在当前路径下</span><br><span class="line"></span><br><span class="line">## 注意这边如果使用 protoc --go_out=grpc:. hellororld.proto 命令生成的结果和指定了 plugins 生成的结果有不同，需要加上 plugins 去生成</span><br></pre></td></tr></table></figure>
<p>命令执行完成之后，会生成 helloworld.pd.go，具体的内容因为篇幅原因，不完全展示了，可以参考：<a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld.pb.go" target="_blank" rel="noopener">helloworld.pd.go</a></p>
<p>会根据 proto 文件中定义的服务方法和消息生成对应的代码，比如：</p>
<ul>
<li>是消息的话会对应生成<ul>
<li>对应的 struct 结构体</li>
<li>Reset()/String()/ProtoMessage()/Descriptor()/XXX_Unmarshal()/XXX_Marshal()/XXX_Merge()/XXX_Merge()/XXX_DiscardUnknown() 方法</li>
<li>消息中定义字段的 get 方法</li>
</ul>
</li>
<li>是服务的话会对应生成<ul>
<li>生成服务对应的 server 以及 client 接口</li>
<li>接口对应的方法</li>
</ul>
</li>
</ul>
<h3 id="编写服务端和客户端代码"><a href="#编写服务端和客户端代码" class="headerlink" title="编写服务端和客户端代码"></a>编写服务端和客户端代码</h3><p>gRPC 服务方法和消息定义完成，对应的服务端和客户端接口也定义完成之后，就需要来写服务端和客户端的具体实现代码了</p>
<h4 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h4><p>这部分代码也是 grpc-go 官方 helloworld example 例子中的代码，借这个简单的代码理解一下服务端代码的编写</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	pb <span class="string">"github.com/Win-Man/sg-server/protos"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	port = <span class="string">":50051"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// server is used to implement helloworld.GreeterServer.</span></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span> &#123;</span><br><span class="line">	pb.UnimplementedGreeterServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SayHello implements helloworld.GreeterServer</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">SayHello</span><span class="params">(ctx context.Context, in *pb.HelloRequest)</span> <span class="params">(*pb.HelloReply, error)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"Received: %v"</span>, in.GetName())</span><br><span class="line">	<span class="keyword">return</span> &amp;pb.HelloReply&#123;Message: <span class="string">"Hello "</span> + in.GetName()&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, port)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to listen: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 创建一个 gRPC 服务端实例</span></span><br><span class="line">	s := grpc.NewServer()</span><br><span class="line">	<span class="comment">// 注册</span></span><br><span class="line">	pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to serve: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释一下上面的代码</p>
<ul>
<li>首先定义了一个 server 的结构体，这个没有指定字段，直接继承了生成的 helloworld.pb.go 中定义的 pb.UnimplementedGreeterServer 结构体</li>
<li>实现了 server 结构体的 SayHello 方法，SayHello 方法接受两个参数（ctx context.Context,in <em>pb.HelloRequest）返回两个参数(</em>pb.HelloReply,error),HelloRequest 和 HelloReply 其实就是 proto 中定义的消息对象，SayHello 方法的具体实现就看具体需求了，在例子中的话，就是获取了发送过来的请求中的 name 字段，将获取到的 name 值拼接上 Hello 以 Message 返回给客户端</li>
<li>在 main 函数中定义了服务端的启动和监听过程</li>
</ul>
<h4 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h4><p>这部分代码也是 grpc-go 官方 helloworld example 例子中的代码，借这个简单的代码理解一下客户端代码的编写</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">	pb <span class="string">"github.com/Win-Man/sg-server/protos"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	address = <span class="string">"localhost:50051"</span></span><br><span class="line">	defaultName = <span class="string">"sg"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 建立连接</span></span><br><span class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"did not connect: %v"</span>, err)</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">	<span class="comment">// 获取命令行中传入的第一个参数作为 name 值，否则name就使用默认值</span></span><br><span class="line">	name := defaultName</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">		name = os.Args[<span class="number">1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置超时时间</span></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	r, err := c.SayHello(ctx, &amp;pb.HelloRequest&#123;Name: name&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"could not greet: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">"Greeting: %s"</span>, r.GetMessage())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释一下上面的代码：</p>
<ul>
<li>所有的逻辑都是在 main 函数中</li>
<li><code>conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())</code> 这个是在建立客户端与服务端之间的 grpc 连接</li>
<li><code>c := pb.NewGreeterClient(conn)</code> 通过连接初始化客户端</li>
<li><code>r, err := c.SayHello(ctx, &amp;pb.HelloRequest{Name: name})</code> 客户端通过调用 gRPC 方法与服务端通信，就收服务端返回的信息</li>
</ul>
<h3 id="运行演示"><a href="#运行演示" class="headerlink" title="运行演示"></a>运行演示</h3><ul>
<li>运行服务端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go run server.go</span><br><span class="line">2020/03/29 00:19:48 Received: sg</span><br><span class="line">2020/03/29 00:22:11 Received: hhhh</span><br></pre></td></tr></table></figure>
<ul>
<li>运行客户端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go run client.go</span><br><span class="line">2020/03/29 00:19:48 Greeting: Hello sg</span><br><span class="line"></span><br><span class="line">$ go run client.go hhhh</span><br><span class="line">2020/03/29 00:22:11 Greeting: Hello hhhh</span><br></pre></td></tr></table></figure>
<p>客户端成功通过 gRPC 调用了服务端。</p>
<h2 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h2><p>简单使用中已经介绍了简单 RPC 的使用方式，在这一节中，会补充讲解 gRPC 其他几种请求/响应模式，标准步骤都是：</p>
<ol>
<li>在 .proto 文件中定义 RPC 服务方法和消息</li>
<li>根据 .proto 文件生成 pb.go 文件</li>
<li>实现服务端代码</li>
<li>实现客户端代码</li>
</ol>
<h3 id="服务端流式-RPC"><a href="#服务端流式-RPC" class="headerlink" title="服务端流式 RPC"></a>服务端流式 RPC</h3><p>服务端流式 RPC 顾名思义就是服务端会按照多次返回响应，直到服务端认为响应发送完毕，会告诉客户端响应应发送完毕</p>
<ul>
<li>首先在 .proto 文件中定义服务端流式 RPC 的服务方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">service Greeter &#123;</span><br><span class="line">......</span><br><span class="line">	rpc TellMeSomething(HelloRequest) returns (stream Something)&#123;&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user's name.</span></span><br><span class="line">message HelloRequest &#123;</span><br><span class="line">	<span class="keyword">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">message Something&#123;</span><br><span class="line">	<span class="keyword">int64</span> lineCode = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">string</span> line = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在原先定义的 Greeter 服务的基础上添加了一个 TellMeSomething 的 RPC 方法，这个 RPC 方法接收的是请求结构是 HelloRequest 类型，返回的结构是 Something 类型，且用了 stream 定义，表示返回结构是一个流，Something 类型包含一个 int64 类型的 lineCode 字段和以一个 string 类型的 line 字段。</p>
<ul>
<li>根据 .proto 文件生成 pb.go 文件，因为是自动生成的，这边就不展示完全的 pb.go 文件内容</li>
<li>编写服务端代码，在服务端实现 TellMeSomething 方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span><span class="title">TellMeSomething</span><span class="params">(in *pb.HelloRequest, stream pb.Greeter_TellMeSomethingServer)</span> <span class="title">error</span></span>&#123;</span><br><span class="line">	log.Printf(<span class="string">"Received ServerStream request from: %v"</span>, in.GetName())</span><br><span class="line">	<span class="comment">// 获取客户端发送的请求内容</span></span><br><span class="line">	hellostr := fmt.Sprintf(<span class="string">"Hello,%s"</span>,in.GetName())</span><br><span class="line">	something := []<span class="keyword">string</span>&#123;hellostr,<span class="string">"ServerLine1"</span>,<span class="string">"ServerLine2"</span>,<span class="string">"ServerLine3"</span>&#125;</span><br><span class="line">	<span class="keyword">for</span> i,v := <span class="keyword">range</span>(something)&#123;</span><br><span class="line">		<span class="keyword">if</span> err := stream.Send(&amp;pb.Something&#123;LineCode:<span class="keyword">int64</span>(i),Line:v&#125;);err != <span class="literal">nil</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TellMeSomething 方法接受两个参数，一个是 *pb.HelloRequest 类型的参数，表示客户端发送的请求，另一个是 pb.Greeter_TellMeSomethingServer 类型的参数，这个参数其实就是服务端返回给客户端的流对象接口，生成的 .pb.go 文件中已经帮我们定义好了这个接口，包含一个 Send() 方法，用于发送响应给客户端，还有就是继承成 grpc.ServerStream 的流对象</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Greeter_TellMeSomethingServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Send(*Something) error</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在服务端通过  pb.Greeter_TellMeSomethingServer 对象的 Send() 方法给客户端发送响应，如果发送所有响应结束，则通过 return nil 的方式通知客户端响应发送结束，客户端会接收到 io.EOF 信号知道服务端已经发送完毕。如果发送中间过程有错误，则通过 return err 的方式将对应的错误通知给客户端</p>
<ul>
<li>编写客户端代码，在客户端调用 TellMeSomethinng 方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set up a connection to the server.</span></span><br><span class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"did not connect: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">	name := defaultName</span><br><span class="line">	clientFunc := <span class="string">"Default"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) == <span class="number">3</span> &#123;</span><br><span class="line">		name = os.Args[<span class="number">1</span>]</span><br><span class="line">		clientFunc = os.Args[<span class="number">2</span>]</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		log.Fatal(<span class="string">"Please input 2 arguments"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	<span class="keyword">switch</span> clientFunc &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"ServerStream"</span>:</span><br><span class="line">		stream,err := c.TellMeSomething(ctx,&amp;pb.HelloRequest&#123;Name:name&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">			log.Fatalf(<span class="string">"TellMeSomething error: %v "</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			something,err := stream.Recv()</span><br><span class="line">			<span class="comment">// 服务端信息发送完成，退出</span></span><br><span class="line">			<span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">			log.Fatalf(<span class="string">"TellMeSomething stream error:%v"</span>,err)</span><br><span class="line">			&#125;</span><br><span class="line">		log.Printf(<span class="string">"Recevie from server:&#123;LineCode:%v Line:%s&#125;\n"</span>,something.GetLineCode(),something.GetLine())</span><br><span class="line">		&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端调用 TellMeSomething 方法，发送了一个 HelloRequest 类型的请求，获得一个 stream 返回对象，通过调用 Recv() 方法客户端接收服务端发送的一次次响应内容</p>
<h3 id="客户端流式-RPC"><a href="#客户端流式-RPC" class="headerlink" title="客户端流式 RPC"></a>客户端流式 RPC</h3><p>客户端流式 RPC 就是客户端不断发送请求，直到发送完毕之后通知服务端请求发送完毕</p>
<ul>
<li>首先在 .proto 文件中定义服务端流式 RPC 的服务方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">service Greeter &#123;</span><br><span class="line">......</span><br><span class="line">	rpc TellYouSomething(stream Something) returns(HelloReply)&#123;&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line">message HelloReply &#123;</span><br><span class="line">	<span class="keyword">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Something&#123;</span><br><span class="line">	<span class="keyword">int64</span> lineCode = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">string</span> line = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在原先定义的 Greeter 服务的基础上添加了一个TellYouSomething 的 RPC 方法，这个 RPC 方法接收的是请求结构是 Something 类型，且用了 stream 定义，表示接受的请求是一个流，Something 类型包含一个 int64 类型的 lineCode 字段和以一个 string 类型的 line 字段，服务端返回给客户端一个 HelloReply 类型的响应</p>
<ul>
<li>根据 .proto 文件生成 pb.go 文件，因为是自动生成的，这边就不展示完全的 pb.go 文件内容</li>
<li>编写服务端代码，在服务端实现 TellYouSomething 方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span><span class="title">TellYouSomething</span><span class="params">(stream pb.Greeter_TellYouSomethingServer)</span> <span class="title">error</span></span>&#123;</span><br><span class="line">	log.Printf(<span class="string">"Recevied ClientStream request"</span>)</span><br><span class="line">	messgeCount := <span class="number">0</span></span><br><span class="line">	length := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		something,err := stream.Recv()</span><br><span class="line">		<span class="comment">// 接收到客户端所有请求，返回响应结果</span></span><br><span class="line">		<span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">			<span class="keyword">return</span> stream.SendAndClose(&amp;pb.HelloReply&#123;Message:fmt.Sprintf(<span class="string">"It's over.\nReceived %v times. Length:%v"</span>,messgeCount,length)&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		messgeCount ++</span><br><span class="line">		length += <span class="built_in">len</span>(something.GetLine())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个与服务端流式 RPC 中客户端的代码比较类似，服务端通过调用 stream 的 Recv() 方法获取客户端发送的请求，直到接受到 io.EOF 信号表示已经接收到全部客户端的请求，可以返回响应了，如果中间接收请求出错，则将错误直接返回给客户端</p>
<ul>
<li>编写客户端代码，在客户端调用 TellYouSomething 方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set up a connection to the server.</span></span><br><span class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"did not connect: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">	name := defaultName</span><br><span class="line">	clientFunc := <span class="string">"Default"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) == <span class="number">3</span> &#123;</span><br><span class="line">		name = os.Args[<span class="number">1</span>]</span><br><span class="line">		clientFunc = os.Args[<span class="number">2</span>]</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		log.Fatal(<span class="string">"Please input 2 arguments"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	<span class="keyword">switch</span> clientFunc &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"ClientStream"</span>:</span><br><span class="line">		stream,err := c.TellYouSomething(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">			log.Fatalf(<span class="string">"TellYouSomething err :%v"</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">		clientStr := []<span class="keyword">string</span>&#123;<span class="string">"ClientLine1"</span>,<span class="string">"ClientLine2"</span>&#125;</span><br><span class="line">		<span class="keyword">for</span> i,v := <span class="keyword">range</span>(clientStr)&#123;</span><br><span class="line">			<span class="keyword">if</span> err := stream.Send(&amp;pb.Something&#123;LineCode:<span class="keyword">int64</span>(i),Line:v&#125;);err != <span class="literal">nil</span>&#123;</span><br><span class="line">				log.Fatalf(<span class="string">"TellYouSomething stream error:%v"</span>,err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		rep,err := stream.CloseAndRecv()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">			log.Fatalf(<span class="string">"CloseAndRecd error:%v"</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">"Recive from server:%s"</span>,rep.GetMessage())</span><br><span class="line">	......	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与服务端流式 RPC 中服务端的代码类似，通过调用 stream 的 Send() 方法给客户端发送请求，等所有请求发送完毕通过调用 CloseAndRevc() 方法通知服务端请求发送完毕，并接收服务端的响应。</p>
<h3 id="服务端-客户端双向流式-RPC"><a href="#服务端-客户端双向流式-RPC" class="headerlink" title="服务端/客户端双向流式 RPC"></a>服务端/客户端双向流式 RPC</h3><p>服务端/客户端双向流式 RPC 即客户端和服务端都是流式方式发送请求的</p>
<ul>
<li>首先在 .proto 文件中定义服务端流式 RPC 的服务方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">service Greeter &#123;</span><br><span class="line">......</span><br><span class="line">	rpc TalkWithMe(stream Something) returns(stream Something)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">message Something&#123;</span><br><span class="line">	<span class="keyword">int64</span> lineCode = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">string</span> line = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在原先定义的 Greeter 服务的基础上添加了一个TalkWithMe的 RPC 方法，这个 RPC 方法接收的是请求结构是 Something 类型，且用了 stream 定义，表示接受的请求是一个流，Something 类型包含一个 int64 类型的 lineCode 字段和以一个 string 类型的 line 字段，服务端返回给客户端的也是 Something 类型的 stream 流。</p>
<ul>
<li>根据 .proto 文件生成 pb.go 文件，因为是自动生成的，这边就不展示完全的 pb.go 文件内容</li>
<li>编写服务端代码，在服务端实现 TalkWithMe 方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span><span class="title">TalkWithMe</span><span class="params">(stream pb.Greeter_TalkWithMeServer)</span> <span class="title">error</span></span>&#123;</span><br><span class="line">	log.Printf(<span class="string">"Recevied Stream request"</span>)</span><br><span class="line">	messageCount := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		something ,err := stream.Recv()</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		messageCount ++</span><br><span class="line">		length := <span class="built_in">len</span>(something.GetLine())</span><br><span class="line">		line := fmt.Sprintf(<span class="string">"Got %s,Length:%v"</span>,something.GetLine(),length)</span><br><span class="line">		<span class="keyword">if</span> err := stream.Send(&amp;pb.Something&#123;LineCode: <span class="keyword">int64</span>(messageCount),Line:line&#125;);err != <span class="literal">nil</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端代码与客户端流式 RPC 中服务端代码几乎是一样的，所以就不作解释</p>
<ul>
<li>编写客户端代码，调用 TalkWithMe 方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set up a connection to the server.</span></span><br><span class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"did not connect: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">	name := defaultName</span><br><span class="line">	clientFunc := <span class="string">"Default"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) == <span class="number">3</span> &#123;</span><br><span class="line">		name = os.Args[<span class="number">1</span>]</span><br><span class="line">		clientFunc = os.Args[<span class="number">2</span>]</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		log.Fatal(<span class="string">"Please input 2 arguments"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	<span class="keyword">switch</span> clientFunc &#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"Stream"</span>:</span><br><span class="line">		stream,err := c.TalkWithMe(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">			log.Fatalf(<span class="string">"TalkWithMe err:%v"</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">		waitc := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				something,err := stream.Recv()</span><br><span class="line">				<span class="comment">// 服务端信息发送完成，退出</span></span><br><span class="line">				<span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">					log.Fatalf(<span class="string">"TalkWithMe stream error:%v"</span>,err)</span><br><span class="line">				&#125;</span><br><span class="line">				log.Printf(<span class="string">"Got %v:%s\n"</span>,something.GetLineCode(),something.GetLine())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;() </span><br><span class="line">		clientStr := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</span><br><span class="line">		<span class="keyword">for</span> i,v := <span class="keyword">range</span>(clientStr)&#123;</span><br><span class="line">			<span class="keyword">if</span> err := stream.Send(&amp;pb.Something&#123;LineCode:<span class="keyword">int64</span>(i),Line:v&#125;);err != <span class="literal">nil</span>&#123;</span><br><span class="line">				log.Fatalf(<span class="string">"TalkWithMe Send error:%v"</span>,err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		stream.CloseSend()</span><br><span class="line">		&lt;- waitc</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		log.Fatal(<span class="string">"Please input second args in Default/ServerStream/ClientStream/Stream"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端发送请求还是通过调用 stream 的 Send() 方法发送请求，但是通知服务端请求发送完毕是通过调用 CloseSend() 方法，不过因为服务端发送的请求不是一次性发送的，所以这边用 goroutine 新开了一个线程用于接收服务端返回的响应。</p>
<h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><ul>
<li>服务端流式 RPC</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 终端 1</span><br><span class="line">$ go run server.go</span><br><span class="line">2020/03/29 19:50:47 Received ServerStream request from: Aob</span><br><span class="line"></span><br><span class="line">## 终端 2</span><br><span class="line">$ go run client.go Aob ServerStream</span><br><span class="line">2020/03/29 19:50:47 Recevie from server:&#123;LineCode:0 Line:Hello,Aob&#125;</span><br><span class="line">2020/03/29 19:50:47 Recevie from server:&#123;LineCode:1 Line:ServerLine1&#125;</span><br><span class="line">2020/03/29 19:50:47 Recevie from server:&#123;LineCode:2 Line:ServerLine2&#125;</span><br><span class="line">2020/03/29 19:50:47 Recevie from server:&#123;LineCode:3 Line:ServerLine3&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端流式 RPC</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## 终端 1 </span><br><span class="line">$ go run server.go</span><br><span class="line">2020/03/29 19:51:47 Recevied ClientStream request</span><br><span class="line"></span><br><span class="line">## 终端 2</span><br><span class="line">$ go run client.go Aob ClientStream</span><br><span class="line">2020/03/29 19:51:47 Recive from server:It&apos;s over.</span><br><span class="line">Received 2 times. Length:22</span><br></pre></td></tr></table></figure>
<ul>
<li>服务端/客户端流式 RPC</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## 终端 1 </span><br><span class="line">$ go run server.go</span><br><span class="line">2020/03/29 19:52:46 Recevied Stream request</span><br><span class="line"></span><br><span class="line">## 终端 2</span><br><span class="line">$ go run client.go Aob Stream      </span><br><span class="line">2020/03/29 19:52:46 Got 1:Got one,Length:3</span><br><span class="line">2020/03/29 19:52:46 Got 2:Got two,Length:3</span><br><span class="line">2020/03/29 19:52:46 Got 3:Got three,Length:5</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是通过 Go 学习 gRPC 的一些记录，只是简单跑通了服务端与客户端之间的请求。<a href="https://github.com/Win-Man/NormalAccumulation/tree/master/learn-for-go/grpc-example" target="_blank" rel="noopener">完整代码地址</a></p>
<p>一开始刚开始看 gRPC 的时候其实有点晕，因为又是 gRPC 又是 protocol 又是流式 RPC 的，但是实际学习下来发现定义简单的 gRPC 服务还是比较简单的，按照步骤走就可以：</p>
<ol>
<li>在 .proto 文件中定义 RPC 服务方法和消息</li>
<li>根据 .proto 文件生成 pb.go 文件</li>
<li>实现服务端代码</li>
<li>实现客户端代码</li>
</ol>
<p>下一步准备学习一下 gRPC 与 TLS 安全加密相关的内容</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/03/docker-compost-network-mode-mysql-connect/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/03/docker-compost-network-mode-mysql-connect/" class="post-title-link" itemprop="url">docker-compose 中 network_mode 设置导致无法从容器外部访问 MySQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-03 21:35:13" itemprop="dateCreated datePublished" datetime="2020-02-03T21:35:13+08:00">2020-02-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="docker-compose-中-network-mode-设置导致无法从容器外部访问-MySQL"><a href="#docker-compose-中-network-mode-设置导致无法从容器外部访问-MySQL" class="headerlink" title="docker-compose 中 network_mode 设置导致无法从容器外部访问 MySQL"></a>docker-compose 中 network_mode 设置导致无法从容器外部访问 MySQL</h1><h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>通过 docker-compose 在自己电脑上部署 MySQL，启动之后，查看容器状态正常，进入容器内部访问 MySQL 正常，但是在宿主机上连接 MySQL 失败。</p>
<ul>
<li>docker-compose.yml 配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cat docker-compose.yml</span><br><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">    mysql:</span><br><span class="line">        network_mode: &quot;host&quot;</span><br><span class="line">        environment:</span><br><span class="line">            MYSQL_ROOT_PASSWORD: &quot;xxxx&quot;</span><br><span class="line">            MYSQL_USER: &quot;qbench&quot;</span><br><span class="line">            MYSQL_PASS: &quot;xxxx&quot;</span><br><span class="line">        image: &quot;docker.io/mysql:5.7.22&quot;</span><br><span class="line">        ports:</span><br><span class="line">            - &quot;3306:3306&quot;</span><br><span class="line">        restart: always</span><br><span class="line">        volumes:</span><br><span class="line">            - &quot;./db:/var/lib/mysql&quot;</span><br><span class="line">            - &quot;./conf/my.cnf:/etc/my,cnf&quot;</span><br><span class="line">            - &quot;./init:/docker-entrypoint-initdb.d/&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>拉取镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -f docker-compose.yml pull</span><br></pre></td></tr></table></figure>
<ul>
<li>启动</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compost -f docker-compose.yml up -d</span><br></pre></td></tr></table></figure>
<ul>
<li>从宿主机上连接 MySQL 报错</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[20-02-03 19:46:34]  shengang@abcs-MacBook-Pro  ~/Documents/002-workspace/docker-workspace/mysql-5.7.22</span><br><span class="line">$ docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">4865e2c56f67        mysql:5.7.22        &quot;docker-entrypoint.s…&quot;   6 seconds ago       Up 5 seconds                            mysql-5722_mysql_1</span><br><span class="line">[20-02-03 19:46:39]  shengang@abcs-MacBook-Pro  ~/Documents/002-workspace/docker-workspace/mysql-5.7.22</span><br><span class="line">$ mysql -uroot -P3306 -h127.0.0.1 -p</span><br><span class="line">Enter password:</span><br><span class="line">ERROR 2003 (HY000): Can&apos;t connect to MySQL server on &apos;127.0.0.1&apos; (61)</span><br></pre></td></tr></table></figure>
<ul>
<li>但是进入容器内部连接 MySQL 正常</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[20-02-03 19:46:56]  shengang@abcs-MacBook-Pro  ~/Documents/002-workspace/docker-workspace/mysql-5.7.22</span><br><span class="line">$ docker exec -it 4865e2c56f67 bash</span><br><span class="line">root@linuxkit-025000000001:/# mysql -uroot -P3306 -h127.0.0.1 -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.22 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>排查过程其实比较简单，因为从容器内部连接正常，从宿主机连接失败，这个基本上就是网络或者端口或者防火墙的问题了。首先看 <code>docker container ls</code> 的结果输出中 <code>PORTS</code> 列的内容是空的，说明端口没有映射出来。但是在 docker-compose.yml 配置文件中我们明明设置了 ports 配置。仔细看了下 docker-compose.yml 配置文件，发现一个 <code>network_mode: &quot;host&quot;</code> 的配置项，这个我之前没怎么了解过，只是抄的网上的配置文件。大概率就是这个配置引起的问题。于是尝试了一下将 <code>network_mode: &quot;host&quot;</code> 这一行删除掉了。然后通过 <code>docker-compose -f docker-compose.yml down</code> ,<code>docker-compose -f docker-compose.yml up -d</code> 重新部署容器，连接就正常了。</p>
<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>虽然问题解决了，但是最终还是需要了解一下是为什么会导致问题的出现，得好好理解一下 network_mode 这个配置的含义。</p>
<p>docker-compose.yml 配置文件中的 netwokr_mode 是用于设置网络模式的，与 docker run 中的 –network 选项参数一样，加上了 <code>service:[service name]</code> 形式的配置，默认是 bridge 桥接模式</p>
<ul>
<li>network_mode: “bridge”</li>
</ul>
<p>默认的网络模式。如果没有指定网络驱动，默认会创建一个 bridge 类型的网络。桥接模式一般是用在应用是独立的情况，容器之间不需要互相通信。</p>
<ul>
<li>network_mode: “host”</li>
</ul>
<p>host 网络模式，针对的也是应用是独立的情况，在 host 网络模式下，移除了宿主机与容器之间的网络隔离，荣容器直接使用宿主机的网络，这样就能在容器中访问宿主机网络。host 网络模式只对 Docker 17.06 以及更高版本的 swarm 服务可用。</p>
<ul>
<li>network_mode: “none”</li>
</ul>
<p>none 表示对于这个 container ，禁用所有的网络。</p>
<ul>
<li><p>network_mode: “service:[service name]”</p>
</li>
<li><p>network_mode: “container:[container name/id]”</p>
</li>
</ul>
<p>当在 swarm 服务中，network_mode 选项会被忽略。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/27/using-gomail-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/27/using-gomail-example/" class="post-title-link" itemprop="url">使用 gomail 发送邮件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-27 21:11:21" itemprop="dateCreated datePublished" datetime="2020-01-27T21:11:21+08:00">2020-01-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用-gomail-发送邮件"><a href="#使用-gomail-发送邮件" class="headerlink" title="使用 gomail 发送邮件"></a>使用 gomail 发送邮件</h1><p>使用 gomail 的一些记录笔记。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>准备 SMTP/IMAP 服务用于代发邮件（这部分内容不赘述，网上可以搜索关键字：QQ/163/gamil SMTP即可）</li>
<li>写邮件需要填写哪些信息<ul>
<li>From/发件人（必须）</li>
<li>To/收件人（必须）</li>
<li>Cc/抄送（可选）</li>
<li>Subject/标题（必须）</li>
<li>Body/邮件正文内容（必须）</li>
<li>Attach/附件（可选）</li>
</ul>
</li>
</ul>
<h2 id="使用-gomail"><a href="#使用-gomail" class="headerlink" title="使用 gomail"></a>使用 gomail</h2><ul>
<li>下载 gomail 包</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get gopkg.in/gomail.v2</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个要发送邮件的对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m ：= gomail.NewMessage()</span><br></pre></td></tr></table></figure>
<p>gomail 中使用 NewMessage 方法创建一个新的消息对象，默认是使用 UTF-8 字符集的，在这个创建的消息对象上设置发件人、收件人等邮件的信息，所以下面填写邮件信息的操作都是基于 NewMessage 方法创建的对象基础上的。</p>
<ul>
<li>填写 From/发件人</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m.SetHeader(<span class="string">"From"</span>,<span class="string">"from@xx.com"</span>)</span><br></pre></td></tr></table></figure>
<p>gomail 中通过 <code>func (m *Message) SetHeader(field string, value ...string)</code> 方法设置收件人、发件人、标题等信息，SetHeader 方法第一个参数表示设定要设置的内容，From 表示发件人，To 表示收件人，Subject 表示标题，后面可以跟多个 String 类型的参数，可以表示多个收件人</p>
<ul>
<li>填写 To/收件人</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m.SetHeader(<span class="string">"To"</span>,<span class="string">"to@xx.com"</span>,<span class="string">"to_1@xx.com"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>填写 Cc/抄送人</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m.SetAddressHeader(<span class="string">"Cc"</span>,<span class="string">"cc@xx.com"</span>,<span class="string">"cc"</span>)</span><br></pre></td></tr></table></figure>
<p>gomail 中通过 <code>func (m *Message) SetAddressHeader(field, address, name string)</code> 方法设置抄送人，SetAddressHeader 方法第一个参数表示设定要设置的内容，第二个参数表示抄送人的邮箱地址，第三个参数表示抄送人名称</p>
<ul>
<li>填写 Subject/标题</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m.SetHeader(<span class="string">"Subject"</span>,<span class="string">"This is mail title"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>填写 Body/邮件正文内容</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m.SetBody(<span class="string">"text/html"</span>,<span class="string">"Mr.Li&lt;br&gt;Thanks For your help."</span>)</span><br></pre></td></tr></table></figure>
<p>gomail 中通过 <code>func (m *Message) SetBody(contentType, body string, settings ...PartSetting)</code> 方法设置邮件正文内容， SetBody 方法第一个参数表示设置文本内容类型，可以是 text/plain 也可以是 text/html，第二个参数表示正文内容字符串，第三个参数表示一些额外的设置（大部分情况可以不设置），如果有字符 encode 的需要可以设置</p>
<ul>
<li>添加附件 </li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m.Attach(<span class="string">"../../go.mod"</span>)</span><br></pre></td></tr></table></figure>
<p>gomail 中通过 <code>func (m *Message) Attach(filename string, settings ...FileSetting)</code> 方法添加邮件附件，Attach 方法第一个参数表示附件文件路径，第二个参数表示表示一些额外的设置，比如附件文件名称修改等（可以不设置）</p>
<ul>
<li>设置 SMTP/IMAP 服务器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d := gomail.NewDialer(<span class="string">"smtp.qq.com"</span>,<span class="number">465</span>, <span class="string">"1234567890@qq.com"</span>, <span class="string">"xxxxxxxx"</span>)</span><br></pre></td></tr></table></figure>
<p>gomail 中通过 <code>func NewDialer(host string, port int, username, password string) *Dialer</code> 方法创建一个 SMTP Dialer 用于发送邮件</p>
<ul>
<li>发送邮件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err := d.DialAndSend(m)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gomail 中通过 <code>func (d *Dialer) DialAndSend(m ...*Message) error</code> 方法连接到 SMTP 服务器并发送邮件，最终关闭连接。</p>
<ul>
<li>使用 SetHeaders 方法一起设置邮件内容</li>
</ul>
<p>前面介绍设置邮件发件人、收件人、标题等信息都是通过 SetHeader 方法，调用 SetHeader 方法只能设置一项内容，如果想要同时设置多项，那可以考虑使用 SetHeaders 方法，传入一个 <code>map[string][]string</code> 类型的参数即可</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mailHeader := <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"From"</span>:    &#123;<span class="string">"from@qq.com"</span>&#125;,</span><br><span class="line">		<span class="string">"To"</span>:      &#123;<span class="string">"to_user1@qq.com"</span>, <span class="string">"to_user2@gmail.com"</span>&#125;,</span><br><span class="line">		<span class="string">"Subject"</span>: &#123;<span class="string">"标题"</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">m.SetHeaders(mailHeader)</span><br></pre></td></tr></table></figure>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"gopkg.in/gomail.v2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BaseSend</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mailHeader := <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"From"</span>:    &#123;<span class="string">"from@qq.com"</span>&#125;,</span><br><span class="line">		<span class="string">"To"</span>:      &#123;<span class="string">"to_user1@qq.com"</span>, <span class="string">"to_user2@gmail.com"</span>&#125;,</span><br><span class="line">		<span class="string">"Subject"</span>: &#123;<span class="string">"标题"</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m := gomail.NewMessage()</span><br><span class="line">	m.SetHeaders(mailHeader)</span><br><span class="line">	m.SetAddressHeader(<span class="string">"Cc"</span>, <span class="string">"shengang@pingcap.com"</span>, <span class="string">"shengang"</span>)</span><br><span class="line">	m.SetBody(<span class="string">"text/html"</span>, <span class="string">"尊敬的客户"</span>)</span><br><span class="line">	m.Attach(<span class="string">"../../go.mod"</span>)</span><br><span class="line"></span><br><span class="line">	d := gomail.NewDialer(<span class="string">"smtp.qq.com"</span>, <span class="number">465</span>, <span class="string">"1234567890@qq.com"</span>, <span class="string">"xxxxxxxx"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := d.DialAndSend(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>gomail Github:<a href="https://github.com/go-gomail/gomail" target="_blank" rel="noopener">https://github.com/go-gomail/gomail</a></li>
<li>gomail example:<a href="https://godoc.org/gopkg.in/gomail.v2" target="_blank" rel="noopener">https://godoc.org/gopkg.in/gomail.v2</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/22/2019 年终总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/22/2019 年终总结/" class="post-title-link" itemprop="url">2019总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-22 22:09:21" itemprop="dateCreated datePublished" datetime="2020-01-22T22:09:21+08:00">2020-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂/" itemprop="url" rel="index"><span itemprop="name">杂</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2019-年终总结"><a href="#2019-年终总结" class="headerlink" title="2019 年终总结"></a>2019 年终总结</h1><p>又是一年年底，经历了一年的起起落落，现在能在这个时候安安心心地坐下来，回顾我这一年的内容。今年是来到这个世界的第24个年头，也是经历的第 2 个本命年，上一个本命年，还小，没有多少映象，这一个本命年，由于年龄的原因，经历了很多，这一年虽然中间坎坎坷坷，经历了很多压力、迷茫、误解、从头开始、认清现实，有很多的不如意，但最终还是过来了。总结来说，这一年大坎没有，小坎不断，人生不如意之事十之八九。脑中突然就想到一句“雄关漫道真如铁，而今迈步从头越”。</p>
<p>一年时间好像很短，但是确实可以发生很多事情，好些画面我感觉已经过去了很久，但是仔细想想也都还是 2019 年发生过的事情。</p>
<h2 id="记事"><a href="#记事" class="headerlink" title="记事"></a>记事</h2><p>2019 年对于个人来讲最大的变动，就是换了工作。从 16 年开始在沃趣实习，毕业之后也一直在沃趣待着。刚进沃趣的时候对于 MySQL DBA 这个职业一无所知，没有人能知道未来会发生什么。想想我当时面试沃趣的时候，明明投递的是 Python 开发的岗位，最终面试的时候确是面试的我 MySQL DBA，问我想不想做 MySQL DBA 。神奇的是，我思考了一下最终接受了这个 offer。从此就走上了一条 DBA 的不归路。人生真的很奇妙。幸运的是在沃趣遇到了一帮很好的同事，带着我学 MySQL，慢慢也发现自己对 DBA 这个职业也是比较喜欢。</p>
<p>对于毕业之后的第一份工作，还是有一些感情，但是由于一些个人原因以及工作压力、身体状况变差等一些方面的因素，最终还是选择了离职。来到了现在的公司 PingCAP。一家做开源分布式数据库 TiDB 的公司，职业依旧是 DBA。新的工作，新的环境，新的同事，新的挑战，一切都很新，目前需要做的就是沉下心好好做事就好，新的开始。</p>
<p>2019 签了自己人生第一个写书合同，之前在大学的时候，曾想过，我这一辈子一定要写本书，有点东西可以留下来，可以说。没想到这个梦想这么快就能有实现的可能，多亏大佬带。目前内容写的差不多了，准备提交初稿。</p>
<p>离开了杭州，回想之前的二十几年，出了出去玩和出差，没有离开过杭州，2019 年由于换工作的原因，到上海工作了，虽然上海离杭州不远，但是这一步让我有种发现新世界大门的感觉。</p>
<p>最后要记录一下，作为一个打工仔，在年中的时候跳槽，年终奖拿的的确是比较难受，下次还是慎重考虑。</p>
<h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>去翻了翻 2018 年立下的 flag，惊奇的发现完成度还算是能令自己满意的：</p>
<ol>
<li>把工作做好，争取升P：换了工作，算是变相升 P 加钱？</li>
<li>Go、k8s、SQL优化技术栈需要补全，MySQL、Linux、分布式技术栈需要加强：Go 和 k8 的技术有了一定的基础，分布式技术栈也因为 TiDB 有所了解</li>
<li>20 本书：本以为是最难完成的 flag，但是由于一些机缘，2019 年让自己保持一点的时间静下心来读读书，有统计的非技术类数据，2019年已经超过 20 本了</li>
<li>体重减到 140：体重没有达标，但是身材能让自己满意了，体重控制住了，肚子也算是减了</li>
<li>多写文章多总结：差强人意</li>
<li>想找个女朋友：的确是停留在了“想”的阶段</li>
<li>培养理财意识，学习理财知识：尝试攒钱、基金定投、记账以及分配资产，目前看来效果还是可以的，继续保持</li>
</ol>
<p>总体看来，完成度 75%。之前年年立 flag，年年打脸，今年没想到打脸没那么重。</p>
<h2 id="立-flag"><a href="#立-flag" class="headerlink" title="立 flag"></a>立 flag</h2><p>20 世纪 20 年代的第一年：</p>
<ol>
<li>25 本书</li>
<li>坚持锻炼，体重减到 140</li>
<li>找个女朋友，从“想”变成实际行动</li>
<li>做一个开源项目或者成为 TiDB Contributer</li>
<li>多赚钱</li>
<li>发展一项爱好</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/TiDB Alertmanager 告警配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/TiDB Alertmanager 告警配置/" class="post-title-link" itemprop="url">TiDB Alertmanager 告警配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 19:26:13" itemprop="dateCreated datePublished" datetime="2019-12-07T19:26:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TiDB/" itemprop="url" rel="index"><span itemprop="name">TiDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TiDB-Alertmanager-告警配置"><a href="#TiDB-Alertmanager-告警配置" class="headerlink" title="TiDB Alertmanager 告警配置"></a>TiDB Alertmanager 告警配置</h1><h2 id="TiDB-中告警相关"><a href="#TiDB-中告警相关" class="headerlink" title="TiDB 中告警相关"></a>TiDB 中告警相关</h2><h3 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h3><p>告警规则文件位于 monitoring 服务器 {deploy_dir}/conf/xxx.rules.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[tidb@test1 tidb-ansible_v3.0.5]$ cd /data2/gangshen/deploy/</span><br><span class="line">[tidb@test1 deploy]$ ll conf/ | grep rules</span><br><span class="line">-rw-r--r-- 1 tidb tidb  3612 Dec  4 14:32 binlog.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb  4684 Dec  4 14:32 blacker.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb    37 Nov 22 11:24 bypass.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb  2044 Dec  4 14:32 kafka.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb   471 Nov 22 11:24 lightning.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb  5358 Dec  4 14:32 node.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb  6898 Dec  4 14:32 pd.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb  5013 Dec  4 14:32 tidb.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb 16122 Nov 22 11:24 tikv-push.rules.yml</span><br><span class="line">-rw-r--r-- 1 tidb tidb 15547 Dec  4 14:32 tikv.rules.yml</span><br></pre></td></tr></table></figure>
<h3 id="加载告警规则"><a href="#加载告警规则" class="headerlink" title="加载告警规则"></a>加载告警规则</h3><p>prometheus 服务器通过配置文件中的 rule_files 字段加载告警规则文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # By default, scrape targets every 15 seconds.</span><br><span class="line">  evaluation_interval: 15s # By default, scrape targets every 15 seconds.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line">  external_labels:</span><br><span class="line">    cluster: &apos;gangshen-cluster&apos;</span><br><span class="line">    monitor: &quot;prometheus&quot;</span><br><span class="line"></span><br><span class="line"># Load and evaluate rules in this file every &apos;evaluation_interval&apos; seconds.</span><br><span class="line">rule_files:</span><br><span class="line">  - &apos;node.rules.yml&apos;</span><br><span class="line">  - &apos;blacker.rules.yml&apos;</span><br><span class="line">  - &apos;bypass.rules.yml&apos;</span><br><span class="line">  - &apos;pd.rules.yml&apos;</span><br><span class="line">  - &apos;tidb.rules.yml&apos;</span><br><span class="line">  - &apos;tikv.rules.yml&apos;</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line"> alertmanagers:</span><br><span class="line"> - static_configs:</span><br><span class="line">   - targets:</span><br><span class="line">     - &apos;172.16.5.83:10093&apos;</span><br><span class="line"></span><br><span class="line">······</span><br></pre></td></tr></table></figure>
<h3 id="重新加载规则"><a href="#重新加载规则" class="headerlink" title="重新加载规则"></a>重新加载规则</h3><ul>
<li>方法1：重启 prometheus/alertmanager 服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart prometheus-&#123;prometheus_port&#125;.service</span><br><span class="line">systemctl restart alertmanager-&#123;alertmanager_port&#125;.service</span><br></pre></td></tr></table></figure>
<ul>
<li>方法2：通过 API 接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://&#123;prometheus_server&#125;:&#123;prometheus_port&#125;/-/reload</span><br><span class="line">curl -XPOST http://&#123;alertmanager_server&#125;:&#123;alertmanager_port&#125;/-/reload</span><br></pre></td></tr></table></figure>
<h2 id="部署-Alertmanager"><a href="#部署-Alertmanager" class="headerlink" title="部署 Alertmanager"></a>部署 Alertmanager</h2><ul>
<li>修改 inventory.ini 配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[alertmanager_servers]</span><br><span class="line">alert-1 ansible_host=172.16.5.83 alertmanager_port=10093 alertmanager_cluster_port=10094</span><br></pre></td></tr></table></figure>
<p>如果需要配置自定义端口，需要配置 alertmanager_port 和 alertmanager_cluster_port 端口</p>
<blockquote>
<p>小技巧，对于一些自定义变量或者端口可以在 tidb-ansible/role/{xxx}/template/{xx}.sh.j2</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  tidb-ansible git:(master) cat roles/alertmanager/templates/run_alertmanager_binary.sh.j2</span><br><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">set -e</span><br><span class="line">ulimit -n 1000000</span><br><span class="line"></span><br><span class="line">DEPLOY_DIR=&#123;&#123; deploy_dir &#125;&#125;</span><br><span class="line">cd "$&#123;DEPLOY_DIR&#125;" || exit 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> WARNING: This file was auto-generated. Do not edit!</span><br><span class="line"><span class="meta">#</span>          All your edit might be overwritten!</span><br><span class="line">exec &gt; &gt;(tee -i -a "&#123;&#123; alertmanager_log_dir &#125;&#125;/&#123;&#123; alertmanager_log_filename &#125;&#125;")</span><br><span class="line">exec 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">exec bin/alertmanager \</span><br><span class="line">    --config.file="conf/alertmanager.yml" \</span><br><span class="line">    --storage.path="&#123;&#123; alertmanager_data_dir &#125;&#125;" \</span><br><span class="line">    --data.retention=120h \</span><br><span class="line">    --log.level="&#123;&#123; alertmanager_log_level &#125;&#125;" \</span><br><span class="line">    --web.listen-address=":&#123;&#123; alertmanager_port &#125;&#125;" \</span><br><span class="line">    --cluster.listen-address=":&#123;&#123; alertmanager_cluster_port &#125;&#125;"</span><br></pre></td></tr></table></figure>
<ul>
<li>deploy</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook deploy.yml -l alert-1</span><br></pre></td></tr></table></figure>
<ul>
<li>start</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook start.yml -l alert-1</span><br><span class="line">ansible-playbook rolling_update_monitor.yml --tags=prometheus</span><br></pre></td></tr></table></figure>
<h2 id="邮件告警配置"><a href="#邮件告警配置" class="headerlink" title="邮件告警配置"></a>邮件告警配置</h2><ul>
<li>修改 {deploy_dir}/conf/alertmanager.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  # The smarthost and SMTP sender used for mail notifications.</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:465&apos;</span><br><span class="line">  smtp_from: &apos;xxxxx@qq.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;xxxxx@qq.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;第三方授权码&apos;</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line"></span><br><span class="line">  # The Slack webhook URL.</span><br><span class="line">  # slack_api_url: &apos;&apos;</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  # A default receiver</span><br><span class="line">  receiver: &quot;db-alert-email&quot;</span><br><span class="line"></span><br><span class="line">  # The labels by which incoming alerts are grouped together. For example,</span><br><span class="line">  # multiple alerts coming in for cluster=A and alertname=LatencyHigh would</span><br><span class="line">  # be batched into a single group.</span><br><span class="line">  group_by: [&apos;env&apos;,&apos;instance&apos;,&apos;alertname&apos;,&apos;type&apos;,&apos;group&apos;,&apos;job&apos;]</span><br><span class="line"></span><br><span class="line">  # When a new group of alerts is created by an incoming alert, wait at</span><br><span class="line">  # least &apos;group_wait&apos; to send the initial notification.</span><br><span class="line">  # This way ensures that you get multiple alerts for the same group that start</span><br><span class="line">  # firing shortly after another are batched together on the first</span><br><span class="line">  # notification.</span><br><span class="line">  group_wait:      30s</span><br><span class="line"></span><br><span class="line">  # When the first notification was sent, wait &apos;group_interval&apos; to send a batch</span><br><span class="line">  # of new alerts that started firing for that group.</span><br><span class="line">  group_interval:  3m</span><br><span class="line"></span><br><span class="line">  # If an alert has successfully been sent, wait &apos;repeat_interval&apos; to</span><br><span class="line">  # resend them.</span><br><span class="line">  repeat_interval: 3m</span><br><span class="line"></span><br><span class="line">  routes:</span><br><span class="line">  # - match:</span><br><span class="line">  #   receiver: webhook-kafka-adapter</span><br><span class="line">  #   continue: true</span><br><span class="line">  # - match:</span><br><span class="line">  #     env: test-cluster</span><br><span class="line">  #   receiver: db-alert-slack</span><br><span class="line">  # - match:</span><br><span class="line">  #     env: test-cluster</span><br><span class="line">  #   receiver: db-alert-email</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line"># - name: &apos;webhook-kafka-adapter&apos;</span><br><span class="line">#   webhook_configs:</span><br><span class="line">#   - send_resolved: true</span><br><span class="line">#     url: &apos;http://10.0.3.6:28082/v1/alertmanager&apos;</span><br><span class="line"></span><br><span class="line">#- name: &apos;db-alert-slack&apos;</span><br><span class="line">#  slack_configs:</span><br><span class="line">#  - channel: &apos;#alerts&apos;</span><br><span class="line">#    username: &apos;db-alert&apos;</span><br><span class="line">#    icon_emoji: &apos;:bell:&apos;</span><br><span class="line">#    title:   &apos;&#123;&#123; .CommonLabels.alertname &#125;&#125;&apos;</span><br><span class="line">#    text:    &apos;&#123;&#123; .CommonAnnotations.summary &#125;&#125;  &#123;&#123; .CommonAnnotations.description &#125;&#125;  expr: &#123;&#123; .CommonLabels.expr &#125;&#125;  http://172.0.0.1:9093/#/alerts&apos;</span><br><span class="line"></span><br><span class="line">- name: &apos;db-alert-email&apos;</span><br><span class="line">  email_configs:</span><br><span class="line">  - send_resolved: true</span><br><span class="line">    to: &apos;shengang@pingcap.com&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改配置文件之后重启 alertmanager 服务或者重新加载配置文件</li>
<li>触发告警之后，可以在 prometheus 中看到告警<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20191207192735.png" alt></li>
<li>在 alertmanager 页面也可以看到告警<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20191207192751.png" alt></li>
<li>并且可以在邮箱收到邮件</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(十一)——MySQL binlog event解析实例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(十一)——MySQL binlog event解析实例/" class="post-title-link" itemprop="url">MySQL Binlog(十一)——MySQL binlog event解析实例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:58:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:58:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-十一-——MySQL-binlog-event解析实例"><a href="#MySQL-Binlog-十一-——MySQL-binlog-event解析实例" class="headerlink" title="MySQL Binlog(十一)——MySQL binlog event解析实例"></a>MySQL Binlog(十一)——MySQL binlog event解析实例</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最后一篇文章是基于前面的知识，进行实际binlog的解析，看看常见的insert、update、delete语句在binlog中存储的形式。</p>
<h2 id="示例：INSERT语句在binlog中event表现形式"><a href="#示例：INSERT语句在binlog中event表现形式" class="headerlink" title="示例：INSERT语句在binlog中event表现形式"></a>示例：INSERT语句在binlog中event表现形式</h2><p>下面，我们就看一下一条INSERT语句在会产生哪些类型的event，这些event在数据库中查看是怎么样的，在binlog文件中查看是怎么样的。</p>
<h3 id="ROW格式下表现形式"><a href="#ROW格式下表现形式" class="headerlink" title="ROW格式下表现形式"></a>ROW格式下表现形式</h3><p>以下显示内容是在MySQL-5.6.34版本上，且binlog日志记录格式为ROW模式的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 09:34:02&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:34:22&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:34:32&gt; insert into test1(`name`) values(&apos;woqutech&apos;);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:36:01&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4          |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |    330619 |        201 | BEGIN                                          |</span><br><span class="line">| mysql-bin.000001 | 201 | Rows_query  |    330619 |        269 | # insert into test1(`name`) values(&apos;woqutech&apos;) |</span><br><span class="line">| mysql-bin.000001 | 269 | Table_map  |    330619 |        324 | table_id: 70 (gangshen.test1)                  |</span><br><span class="line">| mysql-bin.000001 | 324 | Write_rows  |    330619 |        373 | table_id: 70 flags: STMT_END_F                |</span><br><span class="line">| mysql-bin.000001 | 373 | Xid        |    330619 |        404 | COMMIT /* xid=13 */                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从数据库中，我们可以看到<code>insert into test1(</code>name<code>) values(&#39;woqutech&#39;);</code>语句，在binlog日志文件中转换成了5个event存储，分别为Query,Rows_query,Table_map,Write_rows,Xid类型的event，这些event中，Query event表示一个更新语句的开始，Rows_query event记录了更新语句的语句内容，Table_map event中记录了insert语句操作的表的信息，Write_rows event记录了真实更新的记录的内容，最后一个Xid event中表示COMMIT操作。</p>
<p>在数据库中查看binlog文件内容可以很直观的看到，event的类型以及主要内容，那我们接着来看看，在binlog文件中，通过mysqlbinlog工具可以看到的具体内容是什么样的。</p>
<p>可以看到通过mysqlbinlog工具查看binlog文件，可以看到每个event中更加详细的内容。</p>
<h3 id="STATEMENT格式下表现形式"><a href="#STATEMENT格式下表现形式" class="headerlink" title="STATEMENT格式下表现形式"></a>STATEMENT格式下表现形式</h3><p>以下显示内容是在MySQL-5.6.34版本上，且binlog日志记录格式为STATEMENT模式的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 04:31:35&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      143 |</span><br><span class="line">| mysql-bin.000002 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 04:31:48&gt; show binlog events in &apos;mysql-bin.000002&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql-bin.000002 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 04:32:02&gt; insert into test1(`name`) values(&apos;woqu112233&apos;);</span><br><span class="line">Query OK, 1 row affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 04:32:29&gt; show binlog events in &apos;mysql-bin.000002&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000002 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4                          |</span><br><span class="line">| mysql-bin.000002 | 120 | Query      |    330619 |        212 | BEGIN                                                          |</span><br><span class="line">| mysql-bin.000002 | 212 | Intvar      |    330619 |        244 | INSERT_ID=8                                                    |</span><br><span class="line">| mysql-bin.000002 | 244 | Query      |    330619 |        377 | use `gangshen`; insert into test1(`name`) values(&apos;woqu112233&apos;) |</span><br><span class="line">| mysql-bin.000002 | 377 | Xid        |    330619 |        408 | COMMIT /* xid=17 */                                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从数据库中我们可以看到<code>insert into test1(</code>name<code>) values(&#39;woqu112233&#39;);</code>这个insert语句转换成了4个event，分别是Query,Intvar,Quert,Xid4个event。第一个Query的event表示语句开始执行，第二个Intvar的event，是因为表结构中的id字段定义的是auto_increment，这个Intvar event是对自增的主键生成主键值的，接着的Query的event就是真实执行的语句了，最后一个Xid表示语句的提交。<br>在数据库中查看binlog文件内容可以很直观的看到，event的类型以及主要内容，那我们接着来看看，在binlog文件中，通过mysqlbinlog工具可以看到的具体内容是什么样的。</p>
<h2 id="示例：UPDATE语句在binlog中event表现形式"><a href="#示例：UPDATE语句在binlog中event表现形式" class="headerlink" title="示例：UPDATE语句在binlog中event表现形式"></a>示例：UPDATE语句在binlog中event表现形式</h2><p>下面，我们就看一下一条UPDATE语句在会产生哪些类型的event，这些event在数据库中查看是怎么样的，在binlog文件中查看是怎么样的。</p>
<h3 id="ROW格式下表现形式-1"><a href="#ROW格式下表现形式-1" class="headerlink" title="ROW格式下表现形式"></a>ROW格式下表现形式</h3><p>以下显示内容是在MySQL-5.6.34版本上，且binlog日志记录格式为ROW模式的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test1 set name=&apos;woqutech_new&apos; where name=&apos;woqutech&apos;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4                  |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        196 | BEGIN                                                        |</span><br><span class="line">| mysql-bin.000001 | 196 | Rows_query  |      9999 |        278 | # update test1 set name=&apos;woqutech_new&apos; where name=&apos;woqutech&apos; |</span><br><span class="line">| mysql-bin.000001 | 278 | Table_map  |      9999 |        333 | table_id: 70 (gangshen.test1)                                |</span><br><span class="line">| mysql-bin.000001 | 333 | Update_rows |      9999 |        401 | table_id: 70 flags: STMT_END_F                              |</span><br><span class="line">| mysql-bin.000001 | 401 | Xid        |      9999 |        432 | COMMIT /* xid=16 */                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从数据库中，我们可以看到<code>update test1 set name=&#39;woqutech_new&#39; where name=&#39;woqutech&#39;;</code>语句，在binlog日志文件中转换成了5个event存储，分别为Query,Rows_query,Table_map,Update_rows,Xid类型的event，这些event中，Query event表示一个更新语句的开始，Rows_query event记录了更新语句的语句内容，Table_map event中记录了insert语句操作的表的信息，Update_rows event记录了真实更新的记录的内容，最后一个Xid event中表示COMMIT操作。</p>
<p>在数据库中查看binlog文件内容可以很直观的看到，event的类型以及主要内容，那我们接着来看看，在binlog文件中，通过mysqlbinlog工具可以看到的具体内容是什么样的。</p>
<p>可以看到通过mysqlbinlog工具查看binlog文件，可以看到每个event中更加详细的内容。</p>
<h3 id="STATEMENT格式下表现形式-1"><a href="#STATEMENT格式下表现形式-1" class="headerlink" title="STATEMENT格式下表现形式"></a>STATEMENT格式下表现形式</h3><p>以下显示内容是在MySQL-5.6.34版本上，且binlog日志记录格式为STATEMENT模式的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test1 set name=&apos;woqutech_new&apos; where name=&apos;woqutech&apos;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                                      |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4                                |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        207 | BEGIN                                                                      |</span><br><span class="line">| mysql-bin.000001 | 207 | Query      |      9999 |        347 | use `gangshen`; update test1 set name=&apos;woqutech_new&apos; where name=&apos;woqutech&apos; |</span><br><span class="line">| mysql-bin.000001 | 347 | Xid        |      9999 |        378 | COMMIT /* xid=46 */                                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从数据库中我们可以看到<code>update test1 set name=&#39;woqutech_new&#39; where name=&#39;woqutech&#39;;</code>这个insert语句转换成了3个event，分别是Query,Quert,Xid4个event。第一个Query的event表示语句开始执行，接着的Query的event就是真实执行的语句了，最后一个Xid表示语句的提交。<br>在数据库中查看binlog文件内容可以很直观的看到，event的类型以及主要内容，那我们接着来看看，在binlog文件中，通过mysqlbinlog工具可以看到的具体内容是什么样的。</p>
<h2 id="示例：DELETE语句在binlog中event表现形式"><a href="#示例：DELETE语句在binlog中event表现形式" class="headerlink" title="示例：DELETE语句在binlog中event表现形式"></a>示例：DELETE语句在binlog中event表现形式</h2><p>下面，我们就看一下一条DELETE语句在会产生哪些类型的event，这些event在数据库中查看是怎么样的，在binlog文件中查看是怎么样的。</p>
<h3 id="ROW格式下表现形式-2"><a href="#ROW格式下表现形式-2" class="headerlink" title="ROW格式下表现形式"></a>ROW格式下表现形式</h3><p>以下显示内容是在MySQL-5.6.34版本上，且binlog日志记录格式为ROW模式的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 09:34:02&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:34:22&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from test1 where id = 1;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        196 | BEGIN                                      |</span><br><span class="line">| mysql-bin.000001 | 196 | Rows_query  |      9999 |        250 | # delete from test1 where id = 1            |</span><br><span class="line">| mysql-bin.000001 | 250 | Table_map  |      9999 |        305 | table_id: 70 (gangshen.test1)              |</span><br><span class="line">| mysql-bin.000001 | 305 | Delete_rows |      9999 |        358 | table_id: 70 flags: STMT_END_F              |</span><br><span class="line">| mysql-bin.000001 | 358 | Xid        |      9999 |        389 | COMMIT /* xid=27 */                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从数据库中，我们可以看到<code>delete from test1 where id = 1;</code>语句，在binlog日志文件中转换成了5个event存储，分别为Query,Rows_query,Table_map,Delete_rows,Xid类型的event，这些event中，Query event表示一个更新语句的开始，Rows_query event记录了更新语句的语句内容，Table_map event中记录了insert语句操作的表的信息，Delete_rows event记录了真实更新的记录的内容，最后一个Xid event中表示COMMIT操作。</p>
<p>在数据库中查看binlog文件内容可以很直观的看到，event的类型以及主要内容，那我们接着来看看，在binlog文件中，通过mysqlbinlog工具可以看到的具体内容是什么样的。</p>
<p>可以看到通过mysqlbinlog工具查看binlog文件，可以看到每个event中更加详细的内容。</p>
<h3 id="STATEMENT格式下表现形式-2"><a href="#STATEMENT格式下表现形式-2" class="headerlink" title="STATEMENT格式下表现形式"></a>STATEMENT格式下表现形式</h3><p>以下显示内容是在MySQL-5.6.34版本上，且binlog日志记录格式为STATEMENT模式的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from test1 where name = &apos;woqutech_new&apos;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4                  |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        207 | BEGIN                                                        |</span><br><span class="line">| mysql-bin.000001 | 207 | Query      |      9999 |        334 | use `gangshen`; delete from test1 where name = &apos;woqutech_new&apos; |</span><br><span class="line">| mysql-bin.000001 | 334 | Xid        |      9999 |        365 | COMMIT /* xid=58 */                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从数据库中我们可以看到<code>delete from test1 where name = &#39;woqutech_new&#39;;</code>这个insert语句转换成了3个event，分别是Query,Quert,Xid4个event。第一个Query的event表示语句开始执行，接着的Query的event就是真实执行的语句了，最后一个Xid表示语句的提交。<br>在数据库中查看binlog文件内容可以很直观的看到，event的类型以及主要内容，那我们接着来看看，在binlog文件中，通过mysqlbinlog工具可以看到的具体内容是什么样的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(十)——MySQL字段存储格式——字符型字段类型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(十)——MySQL字段存储格式——字符型字段类型/" class="post-title-link" itemprop="url">MySQL Binlog(十)——MySQL字段存储格式——字符型字段类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:55:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:55:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-十-——MySQL字段存储格式——字符型字段类型"><a href="#MySQL-Binlog-十-——MySQL字段存储格式——字符型字段类型" class="headerlink" title="MySQL Binlog(十)——MySQL字段存储格式——字符型字段类型"></a>MySQL Binlog(十)——MySQL字段存储格式——字符型字段类型</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文继续介绍binlog中字符类型字段的存储格式。</p>
<h2 id="字符型字段类型"><a href="#字符型字段类型" class="headerlink" title="字符型字段类型"></a>字符型字段类型</h2><p>中文等字符存储以该字段的字符集规定存储二进制数据。</p>
<h3 id="CHAR和VARCHAR类型"><a href="#CHAR和VARCHAR类型" class="headerlink" title="CHAR和VARCHAR类型"></a>CHAR和VARCHAR类型</h3><ul>
<li>[NATIONAL] CHAR[( M )] [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>定长字符串存储时总是使用空格填充右侧达到指定长度。M表示字符串列的长度。M的范围是0到255。省略的花，长度为1。</p>
<p>CHAR是CHARACTER的简写。NATIONAL CHAR（或简写NCHAR）是标准的定义CHAR列应该使用默认字符集的SQL方法。MySQL4.1及更高版本使用utf8作为默认字符集。</p>
<p>CHAR BYTE是BINARY的别名。这是为了保证兼容性。</p>
<p>MySQL允许定义创建一个CHAR(0)的列。这主要用于必须有一个列，而实际上并不使用值，用以与旧版本的应用程序相兼容。当需要只有两个值的列时CHAR(0)也很不错：定义了CHAR(0)NULL的列只占用一位，可只取值NULL和’’（空字符串）</p>
<ul>
<li>[NATIONAL] VARCHAR(M) [CHARACTER SET charset_name] [COLLATE collation_name]</li>
</ul>
<p>变长字符串。M表示最大列长度。M的范围是0到65535。VARCAHR的最大长度由最长行的大小（所有列的共享65535字节）和字符集决定。例如，utf8字符需要多达每个字符三个字节，所以VARCHAR列最多指定21844个字符。</p>
<p>MySQL存储VARCHAR时使用一个或两个字节的前缀+数据。长度前缀表示内容占用的字节数。当列长度不超过255个字节长度前缀占一个字节，当列长度超过255个字节长度前缀占两个字节。</p>
<p>VARCHAR是CHARACTER VARYING的简写。</p>
<h3 id="BINARY和VARBINARY类型"><a href="#BINARY和VARBINARY类型" class="headerlink" title="BINARY和VARBINARY类型"></a>BINARY和VARBINARY类型</h3><ul>
<li>BINARY(M)</li>
</ul>
<p>BINARY类型与CHAR类型相似，不过存储的是二进制字节字符串而不是非二进制字符串。M表示列的长度（以字节为单位）</p>
<ul>
<li>VARBINARY(M)</li>
</ul>
<p>VARBINARY类型与VARCHAR类型相似，不过存储的是二进制字节字符串而不是非二进制字符串。M表示最大列长度（以字节为单位）</p>
<h3 id="BLOB和TEXT类型"><a href="#BLOB和TEXT类型" class="headerlink" title="BLOB和TEXT类型"></a>BLOB和TEXT类型</h3><ul>
<li>TINYBLOB</li>
</ul>
<p>这种BLOB列的最大长度是65535(2^8-1)个字节。存储每个TINYBLOB列时使用一个字节的前缀长度记录内容占用的字节数。</p>
<ul>
<li>BLOB[(M)]</li>
</ul>
<p>BLOB列的最大长度是65535（2^16-1）个字节。存储每个BLOB列时使用两个字节的前缀长度记录内容占用的字节数。</p>
<ul>
<li>MEDIUMBLOB</li>
</ul>
<p>这种BLOB列的最大长度是16777215（2^24-1）个字节。存储每个MEDIUMBLOB列时使用三个字节的前缀长度记录内容占用的字节数。</p>
<ul>
<li>LONGBLOB</li>
</ul>
<p>这种BLOB列的最大长度是4294967295或者（2^32-1）个字节。LONGBLOB列的最大有效长度取决于客户端/服务器协议配置的最大包大小和可用内存。存储每个LONGBLOB列时使用四个字节的前缀长度记录内容占用的字节数。</p>
<ul>
<li>TINYTEXT [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>这种TEXT列的最大长度是255（2^8-1）个字节。如果内容包含多字节字符，那么最大有效长度将减少。存储每个TINYTEXT时使用一个字节的前缀长度记录内容占用的字节数。</p>
<ul>
<li>TEXT[( M )] [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>TEXT列的最大长度是65535（2^16-1）个字节。如果内容包含多字节字符，那么最大有效长度将减少。存储每个TEXT列时使用两个字节的前缀长度记录内容占用的字节。</p>
<p>可以给出该类型的可选长度M。如果指定了，那么MySQL会创建一个最小的，但可以容纳M字节长度的TEXT列。</p>
<ul>
<li>MEDIUMTEXT [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>这种TEXT列的最大长度是16,777,215（224-1）个字节。如果内容包含多字节字符，那么最大有效长度将减少。存储每个MEDIUMTEXT列时使用三个字节的前缀长度记录内容占用的字节数。</p>
<ul>
<li>LONGTEXT [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>这种TEXT列的最大长度是4,294,967,295或者4GB（232-1）个字节。如果内容包含多字节字符，那么最大有效长度将减少。LONGTEXT列的最大有效长度取决于客户端/服务器协议中配置的最大包大小和可用内存。存储每个LONGTEXT列时使用四个字节的前缀长度记录内容占用的字节数。</p>
<h3 id="ENUM类型"><a href="#ENUM类型" class="headerlink" title="ENUM类型"></a>ENUM类型</h3><ul>
<li>ENUM( ‘ value1 ‘,’ value2 ‘,…) [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>枚举类型。属于字符串对象，允许从’ value1 ‘,’ value2 ‘,…,NULL或特殊的’’错误值 列表中选取一个值。ENUM值内部用整数表示。</p>
<p>ENUM列最多可以有65,535个不同的元素（实际的限制小于3000个元素）。一张表可以不超过255个唯一的元素，列表定义中ENUM和SET列视为一组。</p>
<h3 id="SET类型"><a href="#SET类型" class="headerlink" title="SET类型"></a>SET类型</h3><ul>
<li>SET(‘ value1 ‘,’ value2 ‘,…) [CHARACTER SET charset_name ] [COLLATE collation_name ]</li>
</ul>
<p>设置类型。属于字符串对象，可以有零个或多个值，必须从’ value1 ‘,’ value2 ‘,…中选取值，SET值内部用整数表示。</p>
<p>SET列最多可以有64个不同的元素。一张表可以不超过255个唯一的元素，列表定义中ENUM和SET列视为一组。</p>
<h2 id="字符型数据存储格式"><a href="#字符型数据存储格式" class="headerlink" title="字符型数据存储格式"></a>字符型数据存储格式</h2><h3 id="解析环境描述"><a href="#解析环境描述" class="headerlink" title="解析环境描述"></a>解析环境描述</h3><h4 id="表结构定义"><a href="#表结构定义" class="headerlink" title="表结构定义"></a>表结构定义</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `string_table` (</span><br><span class="line">  `col1` varchar(500) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `col2` char(60) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `col3` blob,</span><br><span class="line">  `col4` set(&apos;a&apos;,&apos;b&apos;,&apos;c&apos;) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `col5` enum(&apos;one&apos;,&apos;two&apos;,&apos;three&apos;) COLLATE utf8_bin DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<h4 id="表数据展示"><a href="#表数据展示" class="headerlink" title="表数据展示"></a>表数据展示</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 07:37:31&gt; insert into string_table values(&apos;abcdefg&apos;,&apos;abc&apos;,&apos;abcdefghijklmnopqrstuvwxyz&apos;,&apos;c&apos;,&apos;two&apos;);</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 07:40:27&gt; select * from string_table;</span><br><span class="line">+---------+------+----------------------------+------+------+</span><br><span class="line">| col1    | col2 | col3                      | col4 | col5 |</span><br><span class="line">+---------+------+----------------------------+------+------+</span><br><span class="line">| abcdefg | abc  | abcdefghijklmnopqrstuvwxyz | c    | two  |</span><br><span class="line">+---------+------+----------------------------+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>然后从binlog文件中拿到，对应的Table_map_event和Writes_rows_event对应的字节内容，开始解析</p>
<h3 id="元数据解析"><a href="#元数据解析" class="headerlink" title="元数据解析"></a>元数据解析</h3><h4 id="Table-map-event字节解析"><a href="#Table-map-event字节解析" class="headerlink" title="Table_map_event字节解析"></a>Table_map_event字节解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">61 00 00 00 00 00 //table_id：小端存储，16进制转换成10进制为97</span><br><span class="line">01 00 //flag</span><br><span class="line">08 67 61 6e 67 73 68 65 6e 00 //database_name:1个字节是字符串长度，后接一个null-terminated string 第一个字节表示字符串长度为8，后面内容将16进制转换为ascii字符为gangshen</span><br><span class="line">0c 73 74 72 69 6e 67 5f 74 61 62 6c 65 00//table_name: 1个字节是字符串长度，后接一个null-terminated string第一个字节表示字符串长度为5，后面内容将16进制转换为ascii字符为string_table</span><br><span class="line">05 //columns count :packet integer类型，转换之后，数值为5 表示表中有5个字段</span><br><span class="line">0f fe fc fe fe //column type :</span><br><span class="line">09 //metadata length : packet integer类型,转换之后，数值为9，表示记录表中的metadata内容占用9个字节</span><br><span class="line">dc 05 //col1</span><br><span class="line">fe b4 //col2</span><br><span class="line">02 //col3</span><br><span class="line">f8 01 //col4</span><br><span class="line">f7 01 //col5</span><br><span class="line">1f //null_bits :int((column_count + 7) / 8)个字节 一个bit表示一个字段是否可以为null</span><br><span class="line">22 6b 17 48 //checksum</span><br></pre></td></tr></table></figure>
<p>从Table_map_event中可以按照上面的讲述，解析出表中所有的字段类型以及对应的元数据，按照顺序分别是：</p>
<p>第一个字段：0x0f=MYSQL_TYPE_VARCHAR 元数据0xdc05表示字段最多占用的字节数，因为是小端存储，所以该字段最多占用0x05dc=1500字节。这个占用的字节数取决于表的字符集，因为表的字符集为utf8，所以每个字符最多占用3个字节，所以该字段最多占用500*3个字节。</p>
<p>第二个字段：0xfe=MYSQL_TYPE_STRING，因为是MYSQL_TYPE_STRING类型，所以其真实的字段类型应该是元数据第一个字节（0xfe）和0x30做与运算之后的结果， 第二个字节表示该字段最多占用的字节数，所以该字段最多占用0xb4=180个字节</p>
<p>第三个字段：0x12=MYSQL_TYPE_BLOB 元数据0x02表示该字段类型为BLOB/TEXT类型</p>
<p>第四个字段：0x11=MYSQL_TYPE_STRING,所以其真实的字段类型应该是元数据的第一个字节（0xf8）和0x30做与运算之后的结果，即其真实类型是MYSQLTYPE_SET第二个字节表示该字段最多占用的字节数，所以该字段最多占用0x01个字节的内容。</p>
<p>第五个字段：0x11=MYSQL_TYPE_STRING，所以其真实的字段类型应该是元数据的第一个字节（0xf8）和0x30做与运算之后的结果，即其真实类型是MYSQLTYPE_SET第二个字节表示该字段最多占用的字节数，所以该字段最多占用0x01个字节的内容。</p>
<h3 id="字符型数据“值”解析"><a href="#字符型数据“值”解析" class="headerlink" title="字符型数据“值”解析"></a>字符型数据“值”解析</h3><h4 id="Write-rows-log-event字节解析"><a href="#Write-rows-log-event字节解析" class="headerlink" title="Write_rows_log_event字节解析"></a>Write_rows_log_event字节解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">61 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为97</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">05 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff //before image: (m_width + 7) / 8字节</span><br><span class="line">e0 //bitmap_bits :表中两个字段，插入的值都不为NULL</span><br><span class="line">07 00 61 62 63 64 65 66 67 //col1</span><br><span class="line">03 61 62 63 //col2</span><br><span class="line">1a 00 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f 70 71 72 73 74 75 76 77 78 79 7a //col3</span><br><span class="line">04 //col4</span><br><span class="line">02 //col5</span><br><span class="line">46 1d 2a 69 //checksum</span><br></pre></td></tr></table></figure>
<h4 id="MYSQL-TYPE-VARCHAR字段解析"><a href="#MYSQL-TYPE-VARCHAR字段解析" class="headerlink" title="MYSQL_TYPE_VARCHAR字段解析"></a>MYSQL_TYPE_VARCHAR字段解析</h4><p>MYSQL_TYPE_VARCHAR类型字段由长度和字符串内容两部分组成，长度由由字段的元数据决定，字段的元数据表示该字段最大占用字节数。如果元数据小于255，则MYSQL_TYPE_VARCHAR类型使用一个字节表示字符串长度，长度后面紧接着就是字符串的内容；如果元数据大于等于255，则MYSQL_TYPE_VARCHAR类型使用两个字节表示字符串长度（小端存储），长度后面紧接这就是字符串的内容。</p>
<p>在上面的例子中，col1的字段类型为MYSQL_TYPE_VARCHAR类型，且元数据为0x05dc=2500大于255，所以使用两个字节表示字符串长度，所以字符串长度为0x0700，因为是小端存储，所以实际为0x0007，即字符串长度为7个字节。紧接着读取7个字节的内容0x61626364656667转换为ascii为abcdefg，所以col1的字段值为abcdefg</p>
<h4 id="MYSQL-TYPE-STRING字段解析"><a href="#MYSQL-TYPE-STRING字段解析" class="headerlink" title="MYSQL_TYPE_STRING字段解析"></a>MYSQL_TYPE_STRING字段解析</h4><p>MYSQL_TYPE_STRING类型字段由长度和字符串内容两部分组成，长度由由字段的元数据决定，字段的元数据表示该字段最大占用字节数。如果元数据小于255，则MYSQL_TYPE_STRING类型使用一个字节表示字符串长度，长度后面紧接着就是字符串的内容；如果元数据大于等于255，则MYSQL_TYPE_STRING类型使用两个字节表示字符串长度（小端存储），长度后面紧接这就是字符串的内容。</p>
<p>在上面的例子中，col2的字段类型是MYSQL_TYPE_STRING类型，且元数据中最大占用字节数为0xb4=180小于255，所以使用一个字节表示字符串长度，所以字符串长度为0x03=3个字节。紧接着读取3个字节的内容0x616263专户为ascii为abc，所以col2的字段值为abc</p>
<h4 id="MYSQL-TYPE-BLOB字段解析"><a href="#MYSQL-TYPE-BLOB字段解析" class="headerlink" title="MYSQL_TYPE_BLOB字段解析"></a>MYSQL_TYPE_BLOB字段解析</h4><p>MYSQL_TYPE_BLOB类型字段由长度和字符串内容两部分组成，长度由字段的元数据决定，字段的元数据表示BLOB的类型。如果元数据是1，表示是TINYBLOB/TINYTEXT类型，则MYSQL_TYPE_BLOB类型使用一个字节表示字符串长度，长度后面紧接着就是字符串的内容；如果元数据是2，表示是BLOB/TEXT类型，则MYSQL_TYPE_BLOB类型使用两个字节表示字符串长度（小端存储），长度后面紧接着就是字符串内容；如果元数据是3，表示是MEDIUMBLOB/MEDIUMTEXT类型，则MYSQL_TYPE_BLOB类型使用三个字节表示字符串长度（小端存储），长度后面紧接着就是字符串内容；如果元数据是4，表示是LONGBLOB/LONGTEXT类型，则MYSQL_TYPE_BLOB类型使用四个字节表示字符串长度（小端存储），长度后面紧接着就是字符串内容。</p>
<p>在上面的例子中，col3字段的类型是MYSQL_TYPE_BLOB类型，且元数据为0x02，表示类型为BLOB/TEXT类型，说明该字段使用两个字节表示字符串的长度。所以字符串长度为0x1a00，因为是小端存储，所以字符串长度为0x001a=26，紧接着读取26个字节的内容0x6162636465666768696a6b6c6d6e6f707172737475767778797a转换为ascii为abcdefghijklmnopqrstuvwxyz，所以col3的字段值为abcdefghijklmnopqrstuvwxyz。</p>
<h4 id="MYSQL-TYPE-SET字段解析"><a href="#MYSQL-TYPE-SET字段解析" class="headerlink" title="MYSQL_TYPE_SET字段解析"></a>MYSQL_TYPE_SET字段解析</h4><p>MYSQL_TYPE_SET类型字段内容取决于字段定义SET的数量，表示字段值所需字节数量可以从字段元数据的第二个字节获取到，第二个字节表示内容长度。MYSQL_TYPE_SET类型字段内容采用压缩的表示方法，对应比特位置1则表示值是该位，但是从binlog中无法解析出SET类型内容的具体类型，只能解析出对应的比特位表示方式。</p>
<p>在上面的例子中，col4字段的类型是MYSQL_TYPE_SET，且元数据中表示该字段使用0x01个字节表示字段值，所以col4在Write_rows_log_event占用1个字节的内容，为0x04，转换为二进制为b’100’，从右往左第3位比特位上是1，表示值为set定义中第三个。从Write_rows_log_event中，无法解析出set定义的每个项，查看建表语句，得知set定义中第三个为c，即col4字段的值为c</p>
<h4 id="MYSQL-TYPE-ENUM字段解析"><a href="#MYSQL-TYPE-ENUM字段解析" class="headerlink" title="MYSQL_TYPE_ENUM字段解析"></a>MYSQL_TYPE_ENUM字段解析</h4><p>MYSQL_TYPE_ENUM类型字段内容取决于字段定义ENUM数量，表示字段值所需字节数量可以从字段元数据的第二个字节获取到，第二个字节表示内容长度。</p>
<p>当元数据第二个字节等于1的时候，MYSQL_TYPE_ENUM字段值使用一个字节表示，当元数据第二个字节等于2的时候，MYSQL_TYPE_ENUM字段值使用两个字节表示。</p>
<p>在上面的例子中，col5字段的类型是MYSQL_TYPE_ENUM，且元数据中表示该字段使用0x01个字节表示字段值，所以col5在Write_rows_log_event中占用1个字节的内容，为0x02，转换为10进制为2，即表示值为enum定义中的第2个。在Write_rows_log_event中，无法解析出enum定义的每个项，查看建表语句，得知enum定义中第二个值为two，即col5字段的值为two。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(九)——MySQL字段存储格式——日期类型字段类型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(九)——MySQL字段存储格式——日期类型字段类型/" class="post-title-link" itemprop="url">MySQL Binlog(九)——MySQL字段存储格式——日期类型字段类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:50:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:50:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-九-——MySQL字段存储格式——日期类型字段类型"><a href="#MySQL-Binlog-九-——MySQL字段存储格式——日期类型字段类型" class="headerlink" title="MySQL Binlog(九)——MySQL字段存储格式——日期类型字段类型"></a>MySQL Binlog(九)——MySQL字段存储格式——日期类型字段类型</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文继续介绍binlog中日期类型字段的存储格式。</p>
<h2 id="日期型字段类型"><a href="#日期型字段类型" class="headerlink" title="日期型字段类型"></a>日期型字段类型</h2><h3 id="DATE-DATETIME-TMIESTAMP类型"><a href="#DATE-DATETIME-TMIESTAMP类型" class="headerlink" title="DATE,DATETIME,TMIESTAMP类型"></a>DATE,DATETIME,TMIESTAMP类型</h3><ul>
<li>DATE</li>
</ul>
<p>日期。支持的范围是‘1000-01-01’到‘9999-12-31’。MySQL使用’YYYY-MM-DD’格式显示DATE值。但允许使用字符串或数字给DATE列赋值。</p>
<ul>
<li>DATETIME[(fsp)]</li>
</ul>
<p>日期和时间的组合。支持的范围是‘1000-01-01 00:00:00.000000’到’9999-12-31 23:59:59.999999’。MySQL使用’YYYY-MM-DD HH:MM:SS[.fraction]’格式显示DATETIME值，但允许使用字符串或数字给DATETIME列赋值。</p>
<p>从MySQL5.6.4开始，一个可选的范围从0到6的fsp值可以指定秒数的精度。值为0表示没有小数部分。如果省略的话，默认精度为0.</p>
<p>从MySQL5.6.5开始，自动化初始和更新到当前日期时间，可以使用DATETIME列的DEFAULT和ON UPDATE定义项。</p>
<ul>
<li>TIMESTAMP[(fsp)]</li>
</ul>
<p>时间戳。范围从’1970-01-01 00:00:01.000000’UTC到’2038-01-19 03:14:07.999999’UTC。TIMESTAMP存储从纪元(‘1970-01-01 00:00:00’UTC)至今的总秒数。 </p>
<h3 id="TIME类型"><a href="#TIME类型" class="headerlink" title="TIME类型"></a>TIME类型</h3><ul>
<li>TIME[(fsp)]</li>
</ul>
<p>时间。范围从’-838:59:59.000000’到’838:59:59.000000’。MySQL使用’HH:MM:SS[.fraction]’格式显示TIME值。但允许使用字符串或数字给TIME列赋值。</p>
<p>从MySQL5.6.4开始，一个可选的范围从0到6的fsp值可以指定秒数的精度。值为0表示没有小数部分。如果省略的话，默认精度为0。</p>
<h3 id="YEAR类型"><a href="#YEAR类型" class="headerlink" title="YEAR类型"></a>YEAR类型</h3><ul>
<li>YEAR[(2|4)]</li>
</ul>
<p>两位或四位格式的年。默认是四位格式，虽然显示上YEAR(2)或YEAR(4)的格式不同，但他们具有相同的范围的值。四位格式显示为1901至2155，和0000。两位格式显示为70至69，表示1970至2069。MySQL以为YYYY或YY格式显示YEAR值，但允许使用字符串或数字赋值。</p>
<h2 id="日期型数据存储格式"><a href="#日期型数据存储格式" class="headerlink" title="日期型数据存储格式"></a>日期型数据存储格式</h2><h3 id="解析环境描述"><a href="#解析环境描述" class="headerlink" title="解析环境描述"></a>解析环境描述</h3><h4 id="表结构定义"><a href="#表结构定义" class="headerlink" title="表结构定义"></a>表结构定义</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `time_table` (</span><br><span class="line">  `col1` date DEFAULT NULL,</span><br><span class="line">  `col2` datetime DEFAULT NULL,</span><br><span class="line">  `col3` datetime(3) DEFAULT NULL,</span><br><span class="line">  `col4` timestamp NULL DEFAULT NULL,</span><br><span class="line">  `col5` timestamp(4) NULL DEFAULT NULL,</span><br><span class="line">  `col6` time DEFAULT NULL,</span><br><span class="line">  `col7` time(5) DEFAULT NULL,</span><br><span class="line">  `col8` year(4) DEFAULT NULL,</span><br><span class="line">  `col9` year(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<h4 id="表数据展示"><a href="#表数据展示" class="headerlink" title="表数据展示"></a>表数据展示</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 07:04:33&gt; insert into time_table values(&apos;2017-12-14&apos;,&apos;2017-12-14 09:54:00&apos;,&apos;2017-12-14 09:54:00.112&apos;,&apos;2017-12-14 09:54:00&apos;,&apos;2017-12-14 09:54:00.1113&apos;,&apos;09:54:00&apos;,&apos;09:54:00.00000&apos;,&apos;2017&apos;,&apos;2017&apos;);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 07:04:47&gt; select * from time_table;                                                                                                          +------------+---------------------+-------------------------+---------------------+--------------------------+----------+----------------+------+------+</span><br><span class="line">| col1      | col2                | col3                    | col4                | col5                    | col6    | col7          | col8 | col9 |</span><br><span class="line">+------------+---------------------+-------------------------+---------------------+--------------------------+----------+----------------+------+------+</span><br><span class="line">| 2017-12-14 | 2017-12-14 09:54:00 | 2017-12-14 09:54:00.112 | 2017-12-14 09:54:00 | 2017-12-14 09:54:00.1113 | 09:54:00 | 09:54:00.00000 | 2017 | 2017 |</span><br><span class="line">+------------+---------------------+-------------------------+---------------------+--------------------------+----------+----------------+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>然后从binlog文件中拿到，对应的Table_map_event和Writes_rows_event对应的字节内容，开始解析</p>
<h3 id="元数据解析"><a href="#元数据解析" class="headerlink" title="元数据解析"></a>元数据解析</h3><h4 id="Table-map-event字节数据解析"><a href="#Table-map-event字节数据解析" class="headerlink" title="Table_map_event字节数据解析"></a>Table_map_event字节数据解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略：</span><br><span class="line">4e 00 00 00 00 00 //table_id :小端存储，16进制转换为10进制为78</span><br><span class="line">01 00 //flag :</span><br><span class="line">08 67 61 6e 67 73 68 65 6e 00 //database_name :1个字节是字符串长度，后接一个null-terminated string 第一个字节表示字符串长度为8，后面内容将16进制转换为ascii字符为gangshen</span><br><span class="line">0a 74 69 6d 65 5f 74 61 62 6c 65 00 //table_name: 1个字节是字符串长度，后接一个null-terminated string第一个字节表示字符串长度为5，后面内容将16进制转换为ascii字符为time_table</span><br><span class="line">09 //columns count :packet integer类型，转换之后，数值为9 表示表中有9个字段</span><br><span class="line">0a 12 12 11 11 13 13 0d 0d //column type</span><br><span class="line">06 //metadata_length: packet integer类型,转换之后，数值为9，表示记录表中的metadata内容占用9个字节</span><br><span class="line">00 //col2</span><br><span class="line">03 //col3</span><br><span class="line">00 //col4</span><br><span class="line">04 //col5</span><br><span class="line">00 //col6</span><br><span class="line">05 //col7</span><br><span class="line">ff 01 //null_bits :int((column_count + 7) / 8)个字节 一个bit表示一个字段是否可以为null</span><br><span class="line">38 9b 0a 26 //checksum</span><br></pre></td></tr></table></figure>
<p>从Table_map_event中可以按照上面的讲述，解析出表中所有的字段类型以及对应的元数据，按照顺序分别是：</p>
<p>第一个字段：0x0a=MYSQL_TYPE_DATE 无元数据</p>
<p>第二个字段：0x12=MYSQL_TYPE_DATETIME2 元数据0x00表示该字段的时间精度为0</p>
<p>第三个字段：0x12=MYSQL_TYPE_DATETIME2 元数据0x03表示该字段的时间精度为3</p>
<p>第四个字段：0x11=MYSQL_TYPE_TIMESTAMP2 元数据0x00表示该字段的时间精度为0</p>
<p>第五个字段：0x11=MYSQL_TYPE_TIMESTAMP2 元数据0x04表示该字段的时间精度为4</p>
<p>第六个字段：0x13=MYSQL_TYPE_TIME2 元数据0x00表示该字段的时间精度为0</p>
<p>第七个字段：0x13=MYSQL_TYPE_TIME2 元数据0x05表示该字段的时间精度为5</p>
<p>第八个字段：0x0d=MYSQL_TYPE_YEAR 无元数据</p>
<p>第九个字段：0x0d=MYSQL_TYPE_YEAR 无元数据</p>
<h3 id="日期型数据“值”解析"><a href="#日期型数据“值”解析" class="headerlink" title="日期型数据“值”解析"></a>日期型数据“值”解析</h3><h4 id="Write-rows-log-event字节数据解析"><a href="#Write-rows-log-event字节数据解析" class="headerlink" title="Write_rows_log_event字节数据解析"></a>Write_rows_log_event字节数据解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">4e 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为78</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">09 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff ff //before image: (m_width + 7) / 8字节</span><br><span class="line">00 fe //bitmap_bits :表中两个字段，插入的值都不为NULL</span><br><span class="line">8e c3 0f //col1</span><br><span class="line">99 9e 5c 9d 80 //col2</span><br><span class="line">99 9e 5c 9d 80 04 60 //col3</span><br><span class="line">5a 31 d9 b8 //col4</span><br><span class="line">5a 31 d9 b8 04 59 //col5</span><br><span class="line">80 9d 80 //col6</span><br><span class="line">80 9d 80 00 00 00 //col7</span><br><span class="line">75 //col8</span><br><span class="line">75 //col9</span><br><span class="line">7e da 55 ce //checksum</span><br></pre></td></tr></table></figure>
<h4 id="MYSQL-TYPE-DATE字段解析"><a href="#MYSQL-TYPE-DATE字段解析" class="headerlink" title="MYSQL_TYPE_DATE字段解析"></a>MYSQL_TYPE_DATE字段解析</h4><p>MYSQL_TYPE_DATE类型使用3个字节存储，小端存储。3个字节一共24个比特位，其中从低到高（从右到左）前5位，表示日期，接着的从低到高4位表示月份，剩余的位数表示年份。</p>
<p>在上面的例子中，col1的类型就是MYSQL_TYPE_DATE，所以在Write_rows_log_event中占用3个字节的内容，为0x8ec30f，因为是小端存储，所以实际顺序为0x0fc38e,3个字节一共24个比特位，从右往左，5位表示日期，4位表示月份，15位表示年份。将0x0fc38e转换成二进制是b’0000 1111 1100 0011 1000 1110’，所以day=b’01110’=14，month=b‘1100’=12，year=’0000 1111 1100 001’=2017，所以对应的字段的值是‘2017-12-14’</p>
<h4 id="MYSQL-TYPE-DATETIME2字段解析"><a href="#MYSQL-TYPE-DATETIME2字段解析" class="headerlink" title="MYSQL_TYPE_DATETIME2字段解析"></a>MYSQL_TYPE_DATETIME2字段解析</h4><p>MYSQL_TYPE_DATETIME2类型使用5个字节存储，并且根据时间精度的不同，额外需要不同的字节存储数据,时间精度部分为大端存储。</p>
<p>年月日时分秒的内容存储在基础的5个字节中，5个字节一共40位，从左往右前18位表示年月（年份 * 13 + 月份），其中最高位表示符号，最高位为1表示是正的，为0表示是负的，接着的5位表示日期，剩余的17位中，按照顺序，5位表示时，6位表示分，6位表示秒。因为时间精度最多为6位，一个字节表示两位，所以时间精度为1或者2的时候，使用一个额外的字节表示时间精度，时间精度为3或者4的时候，使用两个额外的字节表示时间精度，时间精度为5或者6的时候，使用三个额外的字节表示时间精度。</p>
<table>
<thead>
<tr>
<th>时间精度</th>
<th>所需字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>在上面的例子中，col2和col3的类型就是MYSQL_TYPE_DATETIME2，因为col2的时间精度为0，所以col2在Write_rows_log_event中占用5个字节的内容，为0x999e5c9d80，因为col3的时间精度为3，所以col3在Write_rows_log_event中占用（5+2）个字节的内容，为0x999e5c9d800460。</p>
<p>我们先解析col2字段的值，从上面的描述中，5个字节（40位）内容，前18位表示年月（年份 * 13+月份），5位表示日期，5位表示时，6位表示分，6位表示秒。0x999e5c9d80转换为二进制是b‘1001 1001 1001 1110 0101 1100 1001 1101 1000 0000’，年月=b’1001 1001 1001 1110 01’ ，日期=b’01110’，时=b’01001’，</p>
<p>分=b’110110’，秒=b’000000’。年月中最高位符号位（正数最高位为1，负数最高位为0），所以在计算数值的时候，要排除最高位的影响（将基础的5个字节减去0x8000000000），即年月值的实际二进制为b’0001 1001 1001 1110 01’，转换为10进制为26233。年=26233/13，月=26233%13,日=b’01110’=14,时=b’01001’=9,分=b’110110’=54,秒=b’000000’=0。所以col2字段的值为2017-12-14 09:54:00</p>
<p>接着解析col3字段值，因为col2和col3字段的基础5个字节的内容一致，所以直接跳过，解析额外的时间精度部分，时间精度部分为0x0460,因为是大端存储，所以转换为10进制结果为1120，即时间精度部分为1120。所以col3字段的值为2017-12-14 09:54:00.1120</p>
<h4 id="MYSQL-TYPE-TIMESTAMP2字段解析"><a href="#MYSQL-TYPE-TIMESTAMP2字段解析" class="headerlink" title="MYSQL_TYPE_TIMESTAMP2字段解析"></a>MYSQL_TYPE_TIMESTAMP2字段解析</h4><p>MYSQL_TYPE_TIMESTAMP2类型使用4个字节存储,大端存储，并且根据时间精度的不同，额外需要不同的字存储数据，时间精度部分也使用大端存储；如果时间精度为1或者2，则4个字节之外还需要1个字节存储数据；如果时间精度为3或者4，则4个字节之外还需要2个字节存储数据；如果时间精度为5或者6，则4个字节之外还需要3个字节存储数据。</p>
<table>
<thead>
<tr>
<th>时间精度</th>
<th>所需字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>在上面的例子中，col4和col5的类型就是MYSQL_TYPE_TIMESTAMP2，因为col4的时间精度为0，所以col4在Write_rows_log_event中占用4个字节的内容，为0x5a31d9b8，因为col5的时间精度为4，所以col5在Write_rows_log_event中占用（4+2）=6个字节，为0x5a31d9b80459。</p>
<p>我们先解析col4字段的值，4个字节，大端存储，所以0x5a31d9b8转换为10进制数为1513216440，即col4的时间戳为1513216440（时间戳是指格林威治时间1970年01月01日00时00分00秒(北京时间1970年01月01日08时00分00秒)起至现在的总秒数），转换为时间为2017-12-14 09:54:00</p>
<p>接着解析col5字段的值，因为col4和col5字段前4个字节内容相同，故不重新解析，直接解析时间精度部分，时间精度为0x0459，因为是大端存储，所以转换为10进制为1113，即时间精度部分为1113。所以col5字段的值为2017-12-14 09:54:00.1113</p>
<h4 id="MYSQL-TYPE-TIME2字段解析"><a href="#MYSQL-TYPE-TIME2字段解析" class="headerlink" title="MYSQL_TYPE_TIME2字段解析"></a>MYSQL_TYPE_TIME2字段解析</h4><p>MYSQL_TYPE_TIME2类型使用3个字节存储,大端存储，并且根据时间精度的不同，额外需要不同的字节存储数据,时间精度部分使用大端存储。</p>
<p>时分秒的内容存储在基础的3个字节中，3个字节一共24位，从左往右，前12位表示时，中间6位表示分，最后6位表示秒，额外的字节存储秒的时间精度部分。因为时间精度最多为6位，一个字节表示两位，所以时间精度为1或者2的时候，使用一个额外的字节表示时间精度，时间精度为3或者4的时候，使用两个额外的字节表示时间精度，时间精度为5或者6的时候，使用三个额外的字节表示时间精度。</p>
<table>
<thead>
<tr>
<th>时间精度</th>
<th>所需字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>MYSQL_TYPE_TIME2类型字段值可以为负数。那么MYSQL_TYPE_TIME2类型是如何存储正负值的呢。</p>
<ul>
<li>没有时间精度</li>
</ul>
<p>在没有时间精度的情况下，MYSQL_TYPE_TIME2类型使用3个字节存储时分秒内容(大端存储)。MySQL使用0x800000作为时间原点（00:00:00），比0x800000大的为正的时间值，比0x800000小的为负的时间值。即时分秒的内容是与0x800000做减法之后的绝对值。</p>
<ul>
<li>时间精度为1或者2</li>
</ul>
<p>在时间精度为1或者2的情况下，MYSQL_TYPE_TIME2类型使用3个基础字节存储时分秒内容(大端存储)，使用一个额外的字节存储时间精度。MySQL使用0x80000000作为时间原点（00:00:00.00），比0x80000000大的为正的时间值，比0x80000000小的为负的时间值，即时分秒的即时间精度的内筒是与0x80000000做减法之后的绝对值。</p>
<ul>
<li>时间精度为3或者4</li>
</ul>
<p>在时间精度为1或者2的情况下，MYSQL_TYPE_TIME2类型使用3个基础字节存储时分秒内容(大端存储)，使用两个额外的字节存储时间精度。MySQL使用0x8000000000作为时间原点（00:00:00.0000），比0x8000000000大的为正的时间值，比0x8000000000小的为负的时间值，即时分秒的即时间精度的内筒是与0x8000000000做减法之后的绝对值。</p>
<ul>
<li>时间精度为5或者6</li>
</ul>
<p>在时间精度为1或者2的情况下，MYSQL_TYPE_TIME2类型使用3个基础字节存储时分秒内容(大端存储)，使用三个额外的字节存储时间精度。MySQL使用0x800000000000作为时间原点（00:00:00.000000），比0x800000000000大的为正的时间值，比0x800000000000小的为负的时间值，即时分秒的时间精度是与0x800000000000做减法之后的绝对值。</p>
<p>在上面的例子中，col6和col7的类型就是MYSQL_TYPE_TIME2，因为col6的时间精度为0，所以col6在Write_rows_log_event中占用3个字节的内容，为0x809d80，因为col7的时间精度为5，所以col7在Write_rows_log_event中占用（3+3）=6个字节的内容，为0x809d80000000。</p>
<p>我们先解析col6的值，按照上面的描述，col6字段类型为MYSQL_TYPE_TIME2，时间精度为0，所以使用3个字节存储内容，在Write_rows_log_event中占用3个字节的内容，为0x809d80。因为时间精度为0的情况下，MySQL是以0x800000为时间原点，具体的时分秒为0x809d80与0x800000差值的绝对值=0x009d80。且0x809d80比0x800000大，所以字段值符号为正。时分秒=0x009d80=b‘0000 0000 1001 1101 1000 0000’，时=前12位=b’0000 0000 1001’=9，分=中间6位=b’1101 10’=54，秒=最后6位=b’00 0000’=0，即col6字段的值为09:54:00</p>
<p>接着解析col7的值，按照上面的描述，col7字段类型为MYSQL_TYPE_TIME2，时间精度为5，所以使用3+3=6个字节存储内容，在Write_rows_log_event中占用6个字节的内容，为0x809d80000000，因为时间精度为5的情况下，MySQL是以0x800000000000为时间原点，具体的时分秒以及时间精度存储为0x809d80000000与0x800000000000差值的绝对值=0x009d80000000。且0x809d80000000比0x800000000000大，所以字段值符号为正。时分秒=0x009d80=b‘0000 0000 1001 1101 1000 0000’，时=前12位=b’0000 0000 1001’=9，分=中间6位=b’1101 10’=54，秒=最后6位=b’00 0000’=0，时间精度=0x000000=0，即col7字段的值为09:54:00.00000</p>
<h4 id="MYSQL-TYPE-YEAR字段解析"><a href="#MYSQL-TYPE-YEAR字段解析" class="headerlink" title="MYSQL_TYPE_YEAR字段解析"></a>MYSQL_TYPE_YEAR字段解析</h4><p>MYSQL_TYPE_DATA类型使用1个字节存储。表示的值是（要表示的年份-1900）</p>
<p>在上面的例子中，col8和col9的类型就是MYSQL_TYPE_YEAR，col8和col9都在Write_rows_log_event中占用1个字节的内容，分别为0x75和0x75，转换为10进制为117，将结果加上1900，则最终col8和col9字段的值为2017。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(八)——MySQL字段存储格式——数值类型字段类型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(八)——MySQL字段存储格式——数值类型字段类型/" class="post-title-link" itemprop="url">MySQL Binlog(八)——MySQL字段存储格式——数值类型字段类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:45:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:45:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-八-——MySQL字段存储格式——数值类型字段类型"><a href="#MySQL-Binlog-八-——MySQL字段存储格式——数值类型字段类型" class="headerlink" title="MySQL Binlog(八)——MySQL字段存储格式——数值类型字段类型"></a>MySQL Binlog(八)——MySQL字段存储格式——数值类型字段类型</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从本文开始，我会开始介绍MySQL中常见类型字段具体的存储格式，了解这部分内容之后，我们可以用于解析前面讲到的Write_rows_log_event、Update_rows_event、Delete_rows_event中具体关于数据的部分了，可以解析出某个字段具体记录了哪些值，具体的值是什么。</p>
<p>我们首先从数值型字段类型开始，数值型字段类型又可以分为整数类型、定点数数据类型、浮点数数据类型、比特数据类型。</p>
<h2 id="数值型字段类型介绍"><a href="#数值型字段类型介绍" class="headerlink" title="数值型字段类型介绍"></a>数值型字段类型介绍</h2><h3 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h3><ul>
<li>TINYINT[(M)] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>整数，用一个字节表示。分为有符号类型和无符号类型，有符号类型的TINYINT范围是-128到127，无符号类型的TINYINT范围是0到255。</p>
<ul>
<li>SMALLINT[(M)] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>整数，用两个字节表示。分为有符号类型和无符号类型，有符号类型的SMALLINT范围是-32768到32767，无符号类型的SMALLINT范围是0到65535</p>
<ul>
<li>MEDIUMINT[(M)] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>整数，用三个字节表示。分为有符号类型和无符号类型，有符号类型的MEDIUMINT范围是-8388608到8388607，无符号类型的MEDIUMINT范围是0到16777215</p>
<ul>
<li>INT[M] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>整数，用四个字节表示。分为有符号类型和无符号类型，有符号类型的INT范围是-2147483648到2147483647，无符号类型的INT范围是0到4294967295</p>
<ul>
<li>BIGINT[M] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>整数，用八个字节表示。分为有符号类型和无符号类型，有符号类型的BIGINT范围是-9223372036854775808到9223372036854775807，无符号类型的BIGINT范围是0到18446744073709551615</p>
<p><code>SERIAL</code>是<code>BIGINT UNSIGNED NOT NULL AUTO_INCREMENT UNIQUE</code>的别名</p>
<ul>
<li>BOOL,BOOLEAN</li>
</ul>
<p>TINYINT(1)的别名。</p>
<ul>
<li>INTEGER[(M)] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>INT的别名</p>
<h3 id="定点数数据类型-DECIMAL-NUMERIC"><a href="#定点数数据类型-DECIMAL-NUMERIC" class="headerlink" title="定点数数据类型 DECIMAL,NUMERIC"></a>定点数数据类型 DECIMAL,NUMERIC</h3><ul>
<li>DECIMAL[(M|,D)] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>小数，M表示数据的精度，表示数据的总长度，小数点和符号不占长度；D表示数据的标度，指小数点后面数字的位数。</p>
<p>M的范围是0到65，默认为10；D的范围是0到30，默认为0。</p>
<ul>
<li>DEC[(M[,D])] [UNSIGNED] [ZEROFILL], NUMERIC[(M[,D])] [UNSIGNED] [ZEROFILL], FIXED[(M[,D])] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>DECIMAL的别名</p>
<h3 id="浮点数数据类型-FLOAT-DOUBLE"><a href="#浮点数数据类型-FLOAT-DOUBLE" class="headerlink" title="浮点数数据类型 FLOAT,DOUBLE"></a>浮点数数据类型 FLOAT,DOUBLE</h3><ul>
<li>FLOAT[M,D] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>单精度浮点数，用四个字节表示。允许的值是-3.402823466E+38 到-1.175494351E-38, 0,  1.175494351E-38 到 3.402823466E+38。但是这只是理论的数值范围，实际的范围区间取决于硬件平台。</p>
<p>M表示数据的精度，表示数据的总长度，小数点和符号不占长度；D表示数据的标度，指小数点后面数字的位数。M和D的默认值取决于硬件平台。单精度的浮点数大约是7个小数点。</p>
<ul>
<li>DOUBLE[(M,D)] [UNSIGNED] [ZEROFILL]</li>
</ul>
<p>双精度浮点数，用八个字节表示。允许的值是-1.7976931348623157E+308 到 -2.2250738585072014E-308, 0, 和 2.2250738585072014E-308 到 1.7976931348623157E+308</p>
<p>。但是这只是理论的数值范围，实际的范围区间取决于硬件平台。</p>
<p>M表示数据的精度，表示数据的总长度，小数点和符号不占长度；D表示数据的标度，指小数点后面数字的位数。M和D的默认值取决于硬件平台。双精度的浮点数大约是15个小数点。</p>
<ul>
<li>DOUBLE PRECISION[(M,D)] [UNSIGNED] [ZEROFILL], REAL[(M,D)] [UNSIGNED] [ZEROFILL</li>
</ul>
<p>DOUBLE的别名</p>
<h3 id="比特数据类型-BIT"><a href="#比特数据类型-BIT" class="headerlink" title="比特数据类型 BIT"></a>比特数据类型 BIT</h3><ul>
<li>BIT[(M)]</li>
</ul>
<p>比特数据类型。M表示每个值占用的bit位数，M的范围是1到64。如果M没有指定，则默认值为1。</p>
<h2 id="数值型数据解析"><a href="#数值型数据解析" class="headerlink" title="数值型数据解析"></a>数值型数据解析</h2><h3 id="解析环境描述"><a href="#解析环境描述" class="headerlink" title="解析环境描述"></a>解析环境描述</h3><h4 id="表结构定义"><a href="#表结构定义" class="headerlink" title="表结构定义"></a>表结构定义</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `number_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` decimal(25,10) DEFAULT NULL,</span><br><span class="line">  `col7` float DEFAULT NULL,</span><br><span class="line">  `col8` double DEFAULT NULL,</span><br><span class="line">  `col9` bit(5) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>
<h4 id="表数据展示"><a href="#表数据展示" class="headerlink" title="表数据展示"></a>表数据展示</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 02:59:24&gt; insert into number_table values(2,-22,222,-2222,22222,123123123123.112233,123.1,123.2,b&apos;00110&apos;);</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 03:03:39&gt; select * from number_table;</span><br><span class="line">+------+------+------+-------+-------+-------------------------+-------+-------+------+</span><br><span class="line">| col1 | col2 | col3 | col4  | col5  | col6                    | col7  | col8  | col9 |</span><br><span class="line">+------+------+------+-------+-------+-------------------------+-------+-------+------+</span><br><span class="line">|    2 |  -22 |  222 | -2222 | 22222 | 123123123123.1122330000 | 123.1 | 123.2 |    |</span><br><span class="line">+------+------+------+-------+-------+-------------------------+-------+-------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>然后从binlog文件中拿到对应的Table_map_event和Writes_rows_event对应的字节内容，开始解析</p>
<h3 id="元数据存储格式"><a href="#元数据存储格式" class="headerlink" title="元数据存储格式"></a>元数据存储格式</h3><h4 id="Table-map-event字节数据解析"><a href="#Table-map-event字节数据解析" class="headerlink" title="Table_map_event字节数据解析"></a>Table_map_event字节数据解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">5d 00 00 00 00 00 //table_id</span><br><span class="line">01 00 //flag</span><br><span class="line">08 67 61 6e 67 73 68 65 6e 00 //database_name :1个字节是字符串长度，后接一个null-terminated string 第一个字节表示字符串长度为8，后面内容将16进制转换为ascii字符为gangshen</span><br><span class="line">0c 6e 75 6d 62 65 72 5f 74 61 62 6c 65 00 //table_name: 1个字节是字符串长度，后接一个null-terminated string第一个字节表示字符串长度为12，后面内容将16进制转换为ascii字符为number_table</span><br><span class="line">09 //columns count :packet integer类型，转换之后，数值为9 表示表中有9个字段</span><br><span class="line">01 02 09 03 08 f6 04 05 10 //column types</span><br><span class="line">06 //metadata_length</span><br><span class="line">19 0a //col6 metadata</span><br><span class="line">04 //col7 metadata</span><br><span class="line">08 //col8 metadata</span><br><span class="line">05 00 //col9 metadata</span><br><span class="line">ff 01 //null_bits :int((column_count + 7) / 8)个字节 一个bit表示一个字段是否可以为null</span><br><span class="line">e2 06 a7 b1 //checksum</span><br></pre></td></tr></table></figure>
<p>从Table_map_event中可以参照上节描述，解析出表中所有的字段类型以及对应的元数据，按照顺序分别是：</p>
<p>第一个字段：0x01=MYSQL_TYPE_TINY 无元数据</p>
<p>第二个字段：0x02=MYSQL_TYPE_SHORT 无元数据</p>
<p>第三个字段：0x09=MYSQL_TYPE_INT24 无元数据</p>
<p>第四个字段：0x03=MYSQL_TYPE_LONG 无元数据</p>
<p>第五个字段：0x08=MYSQL_TYPE_LONGLONG 无元数据</p>
<p>第六个字段：0xf6=MYSQL_TYPE_NEWDECIMAL 元数据表示精度为25(0x19)，标度为10(0x0a)</p>
<p>第七个字段：0x04=MYSQL_TYPE_FLOAT 元数据表示该字段需要使用4(0x04)个字节表示</p>
<p>第八个字段：0x05=MYSQL_TYPE_DOUBLE 元数据表示该字段需要使用8(0x08)个字节表示</p>
<p>第九个字段：0x10=MYSQL_TYPE_BIT 元数据表示该字段中一共有5(0x0500)个比特位</p>
<h3 id="数值型数据“值”解析"><a href="#数值型数据“值”解析" class="headerlink" title="数值型数据“值”解析"></a>数值型数据“值”解析</h3><h4 id="Write-rows-log-event-字节数据解析"><a href="#Write-rows-log-event-字节数据解析" class="headerlink" title="Write_rows_log_event 字节数据解析"></a>Write_rows_log_event 字节数据解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">5d 00 00 00 00 00 //table_id:</span><br><span class="line">01 00 //flag</span><br><span class="line">02 00 //var header length</span><br><span class="line">09 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff ff //before image: (m_width + 7) / 8字节</span><br><span class="line">00 fe //bitmap_bits :表中两个字段，插入的值都不为NULL</span><br><span class="line">02 //col1</span><br><span class="line">ea ff //col2</span><br><span class="line">de 00 00 //col3</span><br><span class="line">52 f7 ff ff //col4</span><br><span class="line">ce 56 00 00 00 00 00 00 //col5</span><br><span class="line">80 00 7b 07 56 b5 b3 06 b0 8a 28 00 //col6</span><br><span class="line">33 33 f6 42 //col7</span><br><span class="line">cd cc cc cc cc cc 5e 40 //col8</span><br><span class="line">06 //col9</span><br><span class="line">5e 6d 11 fa //checksum</span><br></pre></td></tr></table></figure>
<p>接下来，对应write_row_event中各个字段的二进制，我们按照顺序解析各个字段的值</p>
<h4 id="MYSQL-TYPE-TINY字段解析"><a href="#MYSQL-TYPE-TINY字段解析" class="headerlink" title="MYSQL_TYPE_TINY字段解析"></a>MYSQL_TYPE_TINY字段解析</h4><p>MYSQL_TYPE_TINY需要使用1个字节表示，小端存储。<br>上面的例子中，col1的类型是MYSQL_TYPE_TINY，在所以在Write_rows_log_event中字段值的内容占用1个字节，为0x02，转换成10进制就是2</p>
<h4 id="MYSQL-TYPE-SHORT字段解析"><a href="#MYSQL-TYPE-SHORT字段解析" class="headerlink" title="MYSQL_TYPE_SHORT字段解析"></a>MYSQL_TYPE_SHORT字段解析</h4><p>MYSQL_TYPE_SHORT需要使用2个字节表示，小端存储。</p>
<p>上面的例子中，col2的类型是MYSQL_TYPE_SHORT，所以在Write_rows_log_event中字段值的内容占用2个字节，为0xEAFF，因为是小端存储，所以实际的顺序为0xFFEA，数据采用补码的方式表示有符号数，所以转换成10进制数值为-22</p>
<h4 id="MYSQL-TYPE-INT24字段解析"><a href="#MYSQL-TYPE-INT24字段解析" class="headerlink" title="MYSQL_TYPE_INT24字段解析"></a>MYSQL_TYPE_INT24字段解析</h4><p>MYSQL_TYPE_INT24需要使用3个字节表示，小端存储。</p>
<p>上面的例子中，col3的类型是MYSQL_TYPE_INT24，所以在Write_rows_log_event中字段值的内容占用3个字节，为0xDE0000，因为是小端存储，所以实际的顺序为0x0000DE，数据采用补码的方式表示有符号数，所以转换成10进制数值为222</p>
<h4 id="MYSQL-TYPE-LONG字段解析"><a href="#MYSQL-TYPE-LONG字段解析" class="headerlink" title="MYSQL_TYPE_LONG字段解析"></a>MYSQL_TYPE_LONG字段解析</h4><p>MYSQL_TYPE_LONG需要使用4个字节表示，小端存储。</p>
<p>上面的例子中，col4的类型是MYSQL_TYPE_LONG，所以在Write_rows_log_event中字段值的内容占用4个字节，为0x52F7FFFF，因为是小端存储，所以实际的顺序为0xFFFFF752，数据采用补码的方式表示有符号数，所以转换成10进制数值为-2222</p>
<h4 id="MYSQL-TYPE-LONGLONG-字段解析"><a href="#MYSQL-TYPE-LONGLONG-字段解析" class="headerlink" title="MYSQL_TYPE_LONGLONG 字段解析"></a>MYSQL_TYPE_LONGLONG 字段解析</h4><p>MYSQL_TYPE_LONGLONG需要使用8个字节表示，小端存储。</p>
<p>上面的例子中，col5的类型是MYSQL_TYPE_LONGLONG，所以在Write_rows_log_event中字段值的内容占用8个字节，为0xCE56000000000000，因为是小端存储，所以实际的顺序为0x00000000000056CE，数据采用补码的方式表示有符号数，所以转换成10进制数值为22222</p>
<h4 id="MYSQL-TYPE-DECIMAL字段解析"><a href="#MYSQL-TYPE-DECIMAL字段解析" class="headerlink" title="MYSQL_TYPE_DECIMAL字段解析"></a>MYSQL_TYPE_DECIMAL字段解析</h4><p>MYSQL_TYPE_DECIMAL采用压缩存储的方式，将9个数字（十进制）使用4个字节来表示；每9位数字使用4个字节表示，剩余未满9位数字的，所需字节数参照下表。并且DECIMAL中整数部分与小数部分是单独分开表示的。</p>
<table>
<thead>
<tr>
<th>剩余位数</th>
<th>所需字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
</tr>
<tr>
<td>7</td>
<td>4</td>
</tr>
<tr>
<td>8</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>MYSQL_TYPE_DECIMAL类型的字段，在存储数值的时候，首先将数值按照整数部分以及小数部分划分。</p>
<p>整数部分从低位到高位，每9位数字使用4个字节存储，将每9位数字与正负号（正数：0，负数：-1）做异或运算之后，以大端、有符号整数存储，对于剩余不足9位数字的部分，参照表格存储，将剩余数字与正负号（正数：0，负数：-1）做异或运算之后并异或上一个0x80，以大端、有符号整数存储。</p>
<p>小数部分从高位到低位，每9位数字使用4个字节存储，将每9位数字与正负号（正数：0，负数：-1）做异或运算之后，以大端、有符号整数存储，对于剩余不足9位数字的部分，参照表格存储，将剩余数字与正负号（正数：0，负数：-1）做异或运算之后并异或上一个0x80，以大端、有符号整数存储。</p>
<p>例如数字12.34，整数部分12，2位数字需要一个字节，0x0C与0做异或操作结果是0x0C，小数部分34，2位数字需要一个字节，0x22与0做异或操作结果是0x22，所以数字12.34的MYSQL_TYPE_DECIMAL在binlog中以0xOC22方式存储。</p>
<p>上面的例子中，col6的类型是MYSQL_TYPE_NEWDECIMAL，按照MYSQL_TYPE_NEWDECIMAL存储要求，需要（(15/9)<em>4+3 + (10/9)</em>4+1）=12个字节，所以在Write_rows_log_event中字段值的内容占用12个字节，为0x80007b0756b5b306b08a2800，其中整数部分使用7个字节存储，内容为0x80007b0756b5b3，小数部分使用5个字节存储，内容为0x06b08a2800。</p>
<ul>
<li>首先解析整数部分</li>
</ul>
<p>MYSQL_TYPE_NEWDECIMAL类型值的符号可以从第一个字节中获取到，将第一个字节和0x80做与操作，如果结果不为0表示该值为正数，记mask=0；如果结果为0表示该值为负数，记mask=-1。</p>
<p>因为MYSQL_TYPE_NEWDECIMAL类型使用第一个字节的最高位来表示值的正负，所以在解析具体的值的时候，需要将该符号位忽略，所以真实的数值内容需要将第一个字节与0x80做异或运算。即上述内容中，整数部分数值内容为0x00007b0756b5b3，小数部分数值内容为0x06b08a2800。</p>
<p>整数部分因为最多存储15位数据，所以使用4+6=7个字节存储。因为整数部分是从低位到高位（从右往左）每9位数字使用4个字节存储，剩余位数按照要求存储，所以这7个字节中，前3个字节表示前（15-9）=6位，剩余4个字节表示后9位。将前三个字节0x00007b转换成10进制为123，因为存储的时候将数值与正负号（正数：0，负数：-1）做过异或运算，所以解析的时候需要将解析出来的123与mask做异或运算，即实际前6位数值为123。后4个字节0x0756b5b3转换成10进制为123123123，因为存储的时候将数值与正负号（正数：0，负数：-1）做过异或运算，所以解析的时候需要将解析出来的123与mask做异或运算，即后9位数字为123123123。将整数部分连接起来就是123123123123。</p>
<ul>
<li>接着解析小数部分</li>
</ul>
<p>小数部分因为最多存储10位数据，所以使用4+1=5个字节存储。因为小数部分是从高位到低位（从左往右）每9位数字使用4个字节存储，剩余位数按照要求存储，所以这5个字节中，前4个字节表示9位数字，剩余1个字节表示（10-9）=1位。前4个字节0x0ab08a28转换成10进制是112233000，因为存储的时候将数值与正负号（正数：0，负数：-1）做异或运算，所以解析的时候需要将解析出来的112233000与mask做异或运算，即实际前9位数字为112233000。后一个字节0x00转换成10进制为0，因为存储的时候将数值与正负号（正数：0，负数：-1）做异或运算，所以解析的时候需要将解析出来的0与mask做异或运算，即实际后1位数字为0。将小数部分连接起来就是1122330000。</p>
<p>将解析出来的整数部分与小数部分连接在一起就是123123123123.1122330000</p>
<h4 id="MYSQL-TYPE-FLOAT字段解析"><a href="#MYSQL-TYPE-FLOAT字段解析" class="headerlink" title="MYSQL_TYPE_FLOAT字段解析"></a>MYSQL_TYPE_FLOAT字段解析</h4><p>MYSQL_TYPE_FLOAT类型需要四个字节表示。</p>
<p>上面的例子中，col7的类型是MYSQL_TYPE_FLOAT，所以在Write_rows_log_event中字段值的内容占用4个字节，为0x3333f642，将字节内容强转成float类型的数据(MySQL在解析binlog的时候，也是将字节内容强转成float类型)，得到的结果取决于不同的编程语言。比如在Python中，0x3333f642内容强转成float的结果就是123.099998。</p>
<h4 id="MYSQL-TYPE-DOUBLE字段解析"><a href="#MYSQL-TYPE-DOUBLE字段解析" class="headerlink" title="MYSQL_TYPE_DOUBLE字段解析"></a>MYSQL_TYPE_DOUBLE字段解析</h4><p>MYSQL_TYPE_DOUBEL类型需要八个字节表示</p>
<p>上面的例子中，col8的类型是MYSQL_TYPE_DOUBLE，所以在Write_rows_log_event中字段值的内容占用8个字节，为0xcdcccccccccc5e40，将字节内容强转成double类型的数据（MySQL在解析binlog的时候，也是将字节内容强转成double类型），得到的结果取决于不同的编程语言。比如在Python中，0xcdcccccccccc5e40内容强转成double类型就是123.200000。</p>
<h4 id="MYSQL-TYPE-BIT字段解析"><a href="#MYSQL-TYPE-BIT字段解析" class="headerlink" title="MYSQL_TYPE_BIT字段解析"></a>MYSQL_TYPE_BIT字段解析</h4><p>MYSQL_TYPE_BIT类型需要（M+7）/8，M是字段定义的比特位数。</p>
<p>上面的例子中，col9类型是MYSQL_TYPE_BIT，对应的元数据中定义该字段为5个比特位，所以需要（5+7）/8=1个字节存储数值。所以在Write_row_event中字段值的内容占用1个字节，为0x06，对应的二进制表示方式为b’00110’，所以该字段的值为b’00110’。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/MySQL Binlog(七)——MySQL常见binlog event解析（下）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/MySQL Binlog(七)——MySQL常见binlog event解析（下）/" class="post-title-link" itemprop="url">MySQL Binlog(七)——MySQL常见binlog event解析（下）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-07 16:44:13" itemprop="dateCreated datePublished" datetime="2019-12-07T16:44:13+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-Binlog-七-——MySQL常见binlog-event解析（下）"><a href="#MySQL-Binlog-七-——MySQL常见binlog-event解析（下）" class="headerlink" title="MySQL Binlog(七)——MySQL常见binlog event解析（下）"></a>MySQL Binlog(七)——MySQL常见binlog event解析（下）</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文继续介绍binlog中常见event类型：Gtid_log_event、Previous_gtid_log_event、Anonymous_gtid_log_event。</p>
<h2 id="Gtid-log-event"><a href="#Gtid-log-event" class="headerlink" title="Gtid_log_event"></a>Gtid_log_event</h2><p>开启GTID模式的场景下，每次事务commit提交时，MySQL会在binlog中事务开始写入一个Gtid_log_event，记录该事务的GTID事务号。</p>
<h3 id="post-header部分"><a href="#post-header部分" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>commit_flag</td>
<td>1字节</td>
<td>标记事务是否提交，非0为已提交，为0表示，事务未提交</td>
</tr>
<tr>
<td>sid</td>
<td>16字节</td>
<td>记录GTID中uuid的部分（不记录‘-’），每1个字节表示uuid中2个字符</td>
</tr>
<tr>
<td>gno</td>
<td>8字节</td>
<td>小端存储，GTID中的事务号部分</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分"><a href="#event-body部分" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>checksum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例"><a href="#字节解析示例" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用mysqlbinlog工具解析binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 191</span><br><span class="line">#180109 18:31:08 server id 330619  end_log_pos 239 CRC32 0xd20330e8    GTID [commit=yes]</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;89fbcea2-da65-11e7-a851-fa163e618bac:5&apos;/*!*/;</span><br><span class="line"># at 239</span><br></pre></td></tr></table></figure>
<p>解析二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。。</span><br><span class="line">01 //commit_flag:标记事务是否已提交，表示已提交</span><br><span class="line">89 fb ce a2 da 65 11 e7 a8 51 fa 16 3e 61 8b ac //sid:GTID中uuid部分，转换为uuid为89fbcea2-da65-11e7-a851-fa163e618bac</span><br><span class="line">05 00 00 00 00 00 00 00 //gno:GTID中的事务号，小端存储，转换为10进制为5</span><br><span class="line">e8 30 03 d2 //checksum</span><br></pre></td></tr></table></figure>
<h2 id="Previous-gtid-log-event"><a href="#Previous-gtid-log-event" class="headerlink" title="Previous_gtid_log_event"></a>Previous_gtid_log_event</h2><p>在开启GTID的模式下，每个binlog文件开始会记录一个Previous_gtid_log_event，Previous_gtid_log_event中会包含当前binlog之前所有binlog中的GTID集合。</p>
<h3 id="post-header部分-1"><a href="#post-header部分-1" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>n_sids</td>
<td>8字节</td>
<td>小端存储，记录之后有几个GTID中的uuid号</td>
</tr>
<tr>
<td>sid</td>
<td>16字节</td>
<td>记录GTID中uuid的部分（不记录‘-’），每1个字节表示uuid中2个字符</td>
</tr>
<tr>
<td>n_intervals</td>
<td>8字节</td>
<td>记录每个sid对应有几个间隔，指的是事务号间隔</td>
</tr>
<tr>
<td>start</td>
<td>8字节</td>
<td>每个事务号间隔中的起始事务号</td>
</tr>
<tr>
<td>end</td>
<td>8字节</td>
<td>每个事务号间隔中的结束事务号+1</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-1"><a href="#event-body部分-1" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>checksum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-1"><a href="#字节解析示例-1" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用mysqlbinlog工具解析binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># at 120</span><br><span class="line">#180111 14:10:27 server id 330619  end_log_pos 279 CRC32 0x94a92478    Previous-GTIDs</span><br><span class="line"># 89fbcea2-da65-11e7-a851-fa163e618bac:1-5:999:1050-1052,</span><br><span class="line"># aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-2:5-7</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>解析二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">02 00 00 00 00 00 00 00 //n_sids:记录之后有几个GTID中的uuid号，小端存储，转换为10进制为2，表后后续有2个uuid号</span><br><span class="line">89 fb ce a2 da 65 11 e7 a8 51 fa 16 3e 61 8b ac //sid:GTID中的uuid号转换为uuid为89fbcea2-da65-11e7-a851-fa163e618bac</span><br><span class="line">03 00 00 00 00 00 00 00 //n_intervals:对应的sid中中对应几个事务号间隔，小端存储，转换为10进制为3，表示有3个事务号间隔</span><br><span class="line">01 00 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为1</span><br><span class="line">06 00 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为6，实际的间隔结束事务号为5</span><br><span class="line">e7 03 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为999</span><br><span class="line">e8 03 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为1000，实际的间隔结束事务号为999</span><br><span class="line">1a 04 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为1050</span><br><span class="line">1d 04 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为1053，实际的间隔结束事务号为1052</span><br><span class="line">aa aa aa aa aa aa aa aa aa aa aa aa aa aa aa aa //sid:GTID中的uuid号转换为uuid为aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa</span><br><span class="line">02 00 00 00 00 00 00 00 //n_intervals:对应的sid中中对应几个事务号间隔，小端存储，转换为10进制为2，表示有2个事务号间隔</span><br><span class="line">01 00 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为1</span><br><span class="line">03 00 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为3，实际的间隔结束事务号为2</span><br><span class="line">05 00 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为5</span><br><span class="line">08 00 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为8，实际的间隔结束事务号为7</span><br><span class="line">78 24 a9 94 //checksum</span><br></pre></td></tr></table></figure>
<h2 id="Anonymous-gtid-log-event"><a href="#Anonymous-gtid-log-event" class="headerlink" title="Anonymous_gtid_log_event"></a>Anonymous_gtid_log_event</h2><p>MySQL在binlog中记录每一个匿名事务之前会记录一个Anonymous_gtid_log_event表示接下来的事务是一个匿名事务。<br><strong>注意：因为在5.6.34中并不会产生Anonymous_gtid_log_event，所以以下内容是基于5.7.19版本解析</strong></p>
<h3 id="post-header部分-2"><a href="#post-header部分-2" class="headerlink" title="post-header部分"></a>post-header部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>gtid_flags</td>
<td>1字节</td>
<td>记录binlog格式，如果gtid_flags值为1，表示binlog中可能有以statement方式记录的binlog，如果为0表示，binlog中只有以row格式记录的binlog</td>
</tr>
<tr>
<td>sid</td>
<td>16字节</td>
<td>记录GTID中uuid的部分（不记录‘-’），每1个字节表示uuid中2个字符</td>
</tr>
<tr>
<td>gno</td>
<td>8字节</td>
<td>小端存储，GTID中的事务号部分</td>
</tr>
<tr>
<td>logical_timestamp_typecode</td>
<td>1字节</td>
<td>判断是否有last_commit和sequence_no，在logical_tmiestamp_typecode=2的情况下，有last_commit和sequence_no</td>
</tr>
<tr>
<td>last_commit</td>
<td>8字节</td>
<td>小端存储，上次提交的事务号</td>
</tr>
<tr>
<td>sequence_no</td>
<td>8字节</td>
<td>小端存储，本次提交的序列号</td>
</tr>
</tbody>
</table>
<h3 id="event-body部分-2"><a href="#event-body部分-2" class="headerlink" title="event-body部分"></a>event-body部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>checksum</td>
<td>4字节</td>
<td>校验码</td>
</tr>
</tbody>
</table>
<h3 id="字节解析示例-2"><a href="#字节解析示例-2" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用mysqlbinlog工具解析binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#180109 10:53:54 server id 9999  end_log_pos 5681 CRC32 0x46be0639    Anonymous_GTID    last_committed=20    sequence_number=21    rbr_only=yes</span><br><span class="line">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;/*!*/;</span><br><span class="line"># at 5681</span><br></pre></td></tr></table></figure>
<p>解析二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 //sid:</span><br><span class="line">00 00 00 00 00 00 00 00 //gno:</span><br><span class="line">02 //logical_timestamp_typecode:判断是否有last_commit和sequence_no，在logical_tmiestamp_typecode=2的情况下，有last_commit和sequence_no，所以这边的话，后续有last_commit和sequence_no部分的内容</span><br><span class="line">14 00 00 00 00 00 00 00 //last_commit:上次提交的事务号，小端存储，转换为10机制为20</span><br><span class="line">15 00 00 00 00 00 00 00 //sequence_no:本次提交的序列号，小端存储，转换为10进制为21</span><br><span class="line">39 06 be 46 //checksum:校验码</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Win-Man"
      src="/images/pig.jpeg">
  <p class="site-author-name" itemprop="name">Win-Man</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Win-Man" title="GitHub → https://github.com/Win-Man" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gang.shen0423@gmail.com" title="E-Mail → mailto:gang.shen0423@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/2855803080" title="Weibo → https://weibo.com/2855803080" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://blog.csdn.net/win_man" title="http://blog.csdn.net/win_man" rel="noopener" target="_blank">CSDN博客</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Win-Man</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1260159928&web_id=1260159928"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
