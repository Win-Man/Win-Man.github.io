<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Win-Man&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Win-Man&#39;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Win-Man&#39;s Blog">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>Win-Man's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Win-Man's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/09/058-simple-database-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/09/058-simple-database-4/" class="post-title-link" itemprop="url">Let's Build a Simple Database - Our First Tests(and Bugs)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-09 21:12:13" itemprop="dateCreated datePublished" datetime="2021-05-09T21:12:13+08:00">2021-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文地址：<a href="https://cstack.github.io/db_tutorial/parts/part4.html" target="_blank" rel="noopener">https://cstack.github.io/db_tutorial/parts/part4.html</a><br>原文作者： <a href="https://github.com/cstack" target="_blank" rel="noopener">cstack</a><br>译者：<a href="https://github.com/Win-Man" target="_blank" rel="noopener">Win-Man</a></p>
</blockquote>
<p>目前为止，我们的数据库具备了插入记录和输出所有记录行的能力。让我们花点时间测试一下目前数据库的能力。</p>
<p>我准备使用 <a href="http://rspec.info/" target="_blank" rel="noopener">rspec</a> 写测试，因为我对这个比较熟悉，并且语法比较易读。</p>
<p>我会定义一个简短的助手去发送一系列命令给我们的数据库程序，然后对返回的输出结果做断言。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">describe &apos;database&apos; do</span><br><span class="line">  def run_script(commands)</span><br><span class="line">    raw_output = nil</span><br><span class="line">    IO.popen(&quot;./db&quot;, &quot;r+&quot;) do |pipe|</span><br><span class="line">      commands.each do |command|</span><br><span class="line">        pipe.puts command</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      pipe.close_write</span><br><span class="line"></span><br><span class="line">      # Read entire output</span><br><span class="line">      raw_output = pipe.gets(nil)</span><br><span class="line">    end</span><br><span class="line">    raw_output.split(&quot;\n&quot;)</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  it &apos;inserts and retrieves a row&apos; do</span><br><span class="line">    result = run_script([</span><br><span class="line">      &quot;insert 1 user1 person1@example.com&quot;,</span><br><span class="line">      &quot;select&quot;,</span><br><span class="line">      &quot;.exit&quot;,</span><br><span class="line">    ])</span><br><span class="line">    expect(result).to match_array([</span><br><span class="line">      &quot;db &gt; Executed.&quot;,</span><br><span class="line">      &quot;db &gt; (1, user1, person1@example.com)&quot;,</span><br><span class="line">      &quot;Executed.&quot;,</span><br><span class="line">      &quot;db &gt; &quot;,</span><br><span class="line">    ])</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>这个简单的测试确保了我们得到了和我们输入一样的输出结果，并且这个测试确实通过了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bundle exec rspec</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">Finished in 0.00871 seconds (files took 0.09506 seconds to load)</span><br><span class="line">1 example, 0 failures</span><br></pre></td></tr></table></figure>
<p>然后就可以测试往数据库中插入大量的记录了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it &apos;prints error message when table is full&apos; do</span><br><span class="line">  script = (1..1401).map do |i|</span><br><span class="line">    &quot;insert #&#123;i&#125; user#&#123;i&#125; person#&#123;i&#125;@example.com&quot;</span><br><span class="line">  end</span><br><span class="line">  script &lt;&lt; &quot;.exit&quot;</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result[-2]).to eq(&apos;db &gt; Error: Table full.&apos;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>再重新运行测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bundle exec rspec</span><br><span class="line">..</span><br><span class="line"></span><br><span class="line">Finished in 0.01553 seconds (files took 0.08156 seconds to load)</span><br><span class="line">2 examples, 0 failures</span><br></pre></td></tr></table></figure>
<p>测试通过了，我们的数据库可以存储 1400 行数据目前，因为我们设置了最大的数据页大小是 100，并且每个数据页上可以存储 14 条记录。</p>
<p>重新翻看我们写的代码，我意识到我们可能没有正确的处理如何存储 text 字段。可以很容易的验证这个 case:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it &apos;allows inserting strings that are the maximum length&apos; do</span><br><span class="line">  long_username = &quot;a&quot;*32</span><br><span class="line">  long_email = &quot;a&quot;*255</span><br><span class="line">  script = [</span><br><span class="line">    &quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;,</span><br><span class="line">    &quot;select&quot;,</span><br><span class="line">    &quot;.exit&quot;,</span><br><span class="line">  ]</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result).to match_array([</span><br><span class="line">    &quot;db &gt; Executed.&quot;,</span><br><span class="line">    &quot;db &gt; (1, #&#123;long_username&#125;, #&#123;long_email&#125;)&quot;,</span><br><span class="line">    &quot;Executed.&quot;,</span><br><span class="line">    &quot;db &gt; &quot;,</span><br><span class="line">  ])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>然后测试就跑不通了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Failures:</span><br><span class="line"></span><br><span class="line">  1) database allows inserting strings that are the maximum length</span><br><span class="line">     Failure/Error: raw_output.split(&quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">     ArgumentError:</span><br><span class="line">       invalid byte sequence in UTF-8</span><br><span class="line">     # ./spec/main_spec.rb:14:in `split&apos;</span><br><span class="line">     # ./spec/main_spec.rb:14:in `run_script&apos;</span><br><span class="line">     # ./spec/main_spec.rb:48:in `block (2 levels) in &lt;top (required)&gt;&apos;</span><br></pre></td></tr></table></figure>
<p>如果我们手动测试这个例子，我们可以在输出的记录中看到一些奇怪的字符(我对字符串进行了缩写)：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db &gt; insert 1 aaaaa... aaaaa...</span><br><span class="line">Executed.</span><br><span class="line">db &gt; select</span><br><span class="line">(1, aaaaa...aaa\�, aaaaa...aaa\�)</span><br><span class="line">Executed.</span><br><span class="line">db &gt;</span><br></pre></td></tr></table></figure>
<p>这是怎么回事？我们再看一下我们对于 Row 的定义，我们给 username 字段分配了 32 字节的空间，email 字段分配了 255 字节的空间。但是 C 语言中 string 类型的字段应该是以 null 字符结尾的，我们并没有给这个结束符分配空间。所以这个问题的结局方案就是多分配一个字节的空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> <span class="keyword">uint32_t</span> COLUMN_EMAIL_SIZE = <span class="number">255</span>;</span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   <span class="keyword">uint32_t</span> id;</span><br><span class="line">-  <span class="keyword">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">-  <span class="keyword">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+  <span class="keyword">char</span> username[COLUMN_USERNAME_SIZE + <span class="number">1</span>];</span><br><span class="line">+  <span class="keyword">char</span> email[COLUMN_EMAIL_SIZE + <span class="number">1</span>];</span><br><span class="line"> &#125; Row;</span><br></pre></td></tr></table></figure>
<p>再次运行测试，可以看到测试通过了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> bundle exec rspec</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Finished in 0.0188 seconds (files took 0.08516 seconds to load)</span><br><span class="line">3 examples, 0 failures</span><br></pre></td></tr></table></figure>
<p>我们不应该允许插入的 username 和 email 字段的值超过我们定义的 column size ，可以增加一个测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it &apos;prints error message if strings are too long&apos; do</span><br><span class="line">  long_username = &quot;a&quot;*33</span><br><span class="line">  long_email = &quot;a&quot;*256</span><br><span class="line">  script = [</span><br><span class="line">    &quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;,</span><br><span class="line">    &quot;select&quot;,</span><br><span class="line">    &quot;.exit&quot;,</span><br><span class="line">  ]</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result).to match_array([</span><br><span class="line">    &quot;db &gt; String is too long.&quot;,</span><br><span class="line">    &quot;db &gt; Executed.&quot;,</span><br><span class="line">    &quot;db &gt; &quot;,</span><br><span class="line">  ])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>为了实现这个限制，我们需要更新一下我们的 parser 解析器。目前使用的是 scanf()：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">  statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">  <span class="keyword">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">      input_buffer-&gt;buffer, <span class="string">"insert %d %s %s"</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">      statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line">  <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是 scanf() 有一些缺点。如果读取的字符串大小超过了分配的空间，会导致缓存溢出并且数据会被写入到未知的空间。我们需要在拷贝数据到 Row 结构体之前先检查一下字符串的长度。为了实现这个，我们需要将输入通过空格切割一下。</p>
<p>我准备试用 strtok() 来实现这个。这个比较容易理解：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">+<span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">+  statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">char</span>* keyword = strtok(input_buffer-&gt;buffer, <span class="string">" "</span>);</span><br><span class="line">+  <span class="keyword">char</span>* id_string = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">+  <span class="keyword">char</span>* username = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">+  <span class="keyword">char</span>* email = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (id_string == <span class="literal">NULL</span> || username == <span class="literal">NULL</span> || email == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">int</span> id = atoi(id_string);</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(email) &gt; COLUMN_EMAIL_SIZE) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  statement-&gt;row_to_insert.id = id;</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.username, username);</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.email, email);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Statement* statement)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> prepare_insert(input_buffer, statement);</span><br><span class="line">-    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">-    <span class="keyword">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">-        input_buffer-&gt;buffer, <span class="string">"insert %d %s %s"</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">-        statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line">-    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">-      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">-    &#125;</span><br><span class="line">-    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在输入缓冲区上连续调用strtok，每当缓冲区到达分隔符(在本例中是空格)时，就插入一个空字符，从而将它分解为子字符串。它返回一个指向子字符串开头的指针。</p>
<p>可以调用 strlen() 函数确认每个 text 字段值是不是超过了长度限制。</p>
<p>我们可以像处理别的错误一样处理这个错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">enum</span> PrepareResult_t &#123;</span><br><span class="line">   PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_STRING_TOO_LONG,</span><br><span class="line">   PREPARE_SYNTAX_ERROR,</span><br><span class="line">   PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">   <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">+  <span class="keyword">case</span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">"String is too long.\n"</span>);</span><br><span class="line">+    <span class="keyword">continue</span>;</span><br><span class="line">   <span class="keyword">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"Syntax error. Could not parse statement.\n"</span>);</span><br><span class="line">     <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<p>再次运行测试，测试通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bundle exec rspec</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">Finished in 0.02284 seconds (files took 0.116 seconds to load)</span><br><span class="line">4 examples, 0 failures</span><br></pre></td></tr></table></figure>
<p>既然已经增加了一种错误情况，我们不妨再处理一个错误情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it &apos;prints an error message if id is negative&apos; do</span><br><span class="line">  script = [</span><br><span class="line">    &quot;insert -1 cstack foo@bar.com&quot;,</span><br><span class="line">    &quot;select&quot;,</span><br><span class="line">    &quot;.exit&quot;,</span><br><span class="line">  ]</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result).to match_array([</span><br><span class="line">    &quot;db &gt; ID must be positive.&quot;,</span><br><span class="line">    &quot;db &gt; Executed.&quot;,</span><br><span class="line">    &quot;db &gt; &quot;,</span><br><span class="line">  ])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">enum</span> PrepareResult_t &#123;</span><br><span class="line">   PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_NEGATIVE_ID,</span><br><span class="line">   PREPARE_STRING_TOO_LONG,</span><br><span class="line">   PREPARE_SYNTAX_ERROR,</span><br><span class="line">   PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">@@ <span class="number">-148</span>,<span class="number">9</span> +<span class="number">147</span>,<span class="number">6</span> @@ <span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> id = atoi(id_string);</span><br><span class="line">+  <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_NEGATIVE_ID;</span><br><span class="line">+  &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE) &#123;</span><br><span class="line">     <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">   &#125;</span><br><span class="line">@@ <span class="number">-230</span>,<span class="number">9</span> +<span class="number">226</span>,<span class="number">6</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">       <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_NEGATIVE_ID):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"ID must be positive.\n"</span>);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">       <span class="keyword">case</span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"String is too long.\n"</span>);</span><br><span class="line">         <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<p>目前这些测试已经足够了，下一个章节会是一个重要的特性：持久化。我们需要将数据存储到文件中，并且中文件中读取出来。</p>
<p>那会很棒的。</p>
<p>在这给出这个部分中与之前代码不同的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">@@ <span class="number">-22</span>,<span class="number">6</span> +<span class="number">22</span>,<span class="number">8</span> @@</span><br><span class="line"></span><br><span class="line"> <span class="keyword">enum</span> PrepareResult_t &#123;</span><br><span class="line">   PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_NEGATIVE_ID,</span><br><span class="line">+  PREPARE_STRING_TOO_LONG,</span><br><span class="line">   PREPARE_SYNTAX_ERROR,</span><br><span class="line">   PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">  &#125;;</span><br><span class="line">@@ <span class="number">-34</span>,<span class="number">8</span> +<span class="number">36</span>,<span class="number">8</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   <span class="keyword">uint32_t</span> id;</span><br><span class="line">-  <span class="keyword">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">-  <span class="keyword">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+  <span class="keyword">char</span> username[COLUMN_USERNAME_SIZE + <span class="number">1</span>];</span><br><span class="line">+  <span class="keyword">char</span> email[COLUMN_EMAIL_SIZE + <span class="number">1</span>];</span><br><span class="line"> &#125; Row;</span><br><span class="line"></span><br><span class="line">@@ <span class="number">-150</span>,<span class="number">18</span> +<span class="number">152</span>,<span class="number">40</span> @@ <span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table *table)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">-<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">-                                Statement* statement)</span> </span>&#123;</span><br><span class="line">-  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">   statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">-  <span class="keyword">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">-     input_buffer-&gt;buffer, <span class="string">"insert %d %s %s"</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">-     statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email</span><br><span class="line">-     );</span><br><span class="line">-  <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">char</span>* keyword = strtok(input_buffer-&gt;buffer, <span class="string">" "</span>);</span><br><span class="line">+  <span class="keyword">char</span>* id_string = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">+  <span class="keyword">char</span>* username = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">+  <span class="keyword">char</span>* email = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (id_string == <span class="literal">NULL</span> || username == <span class="literal">NULL</span> || email == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">   &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">int</span> id = atoi(id_string);</span><br><span class="line">+  <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+     <span class="keyword">return</span> PREPARE_NEGATIVE_ID;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE) &#123;</span><br><span class="line">+     <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(email) &gt; COLUMN_EMAIL_SIZE) &#123;</span><br><span class="line">+     <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  statement-&gt;row_to_insert.id = id;</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.username, username);</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.email, email);</span><br><span class="line">+</span><br><span class="line">   <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+      <span class="keyword">return</span> prepare_insert(input_buffer, statement);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">"select"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">@@ <span class="number">-223</span>,<span class="number">6</span> +<span class="number">247</span>,<span class="number">12</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">       <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_NEGATIVE_ID):</span><br><span class="line">+	<span class="built_in">printf</span>(<span class="string">"ID must be positive.\n"</span>);</span><br><span class="line">+	<span class="keyword">continue</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">+	<span class="built_in">printf</span>(<span class="string">"String is too long.\n"</span>);</span><br><span class="line">+	<span class="keyword">continue</span>;</span><br><span class="line">       <span class="keyword">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">"Syntax error. Could not parse statement.\n"</span>);</span><br><span class="line"> 	<span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<p>以及我们增加的测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">+describe &apos;database&apos; do</span><br><span class="line">+  def run_script(commands)</span><br><span class="line">+    raw_output = nil</span><br><span class="line">+    IO.popen(&quot;./db&quot;, &quot;r+&quot;) do |pipe|</span><br><span class="line">+      commands.each do |command|</span><br><span class="line">+        pipe.puts command</span><br><span class="line">+      end</span><br><span class="line">+</span><br><span class="line">+      pipe.close_write</span><br><span class="line">+</span><br><span class="line">+      # Read entire output</span><br><span class="line">+      raw_output = pipe.gets(nil)</span><br><span class="line">+    end</span><br><span class="line">+    raw_output.split(&quot;\n&quot;)</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it &apos;inserts and retrieves a row&apos; do</span><br><span class="line">+    result = run_script([</span><br><span class="line">+      &quot;insert 1 user1 person1@example.com&quot;,</span><br><span class="line">+      &quot;select&quot;,</span><br><span class="line">+      &quot;.exit&quot;,</span><br><span class="line">+    ])</span><br><span class="line">+    expect(result).to match_array([</span><br><span class="line">+      &quot;db &gt; Executed.&quot;,</span><br><span class="line">+      &quot;db &gt; (1, user1, person1@example.com)&quot;,</span><br><span class="line">+      &quot;Executed.&quot;,</span><br><span class="line">+      &quot;db &gt; &quot;,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it &apos;prints error message when table is full&apos; do</span><br><span class="line">+    script = (1..1401).map do |i|</span><br><span class="line">+      &quot;insert #&#123;i&#125; user#&#123;i&#125; person#&#123;i&#125;@example.com&quot;</span><br><span class="line">+    end</span><br><span class="line">+    script &lt;&lt; &quot;.exit&quot;</span><br><span class="line">+    result = run_script(script)</span><br><span class="line">+    expect(result[-2]).to eq(&apos;db &gt; Error: Table full.&apos;)</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it &apos;allows inserting strings that are the maximum length&apos; do</span><br><span class="line">+    long_username = &quot;a&quot;*32</span><br><span class="line">+    long_email = &quot;a&quot;*255</span><br><span class="line">+    script = [</span><br><span class="line">+      &quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;,</span><br><span class="line">+      &quot;select&quot;,</span><br><span class="line">+      &quot;.exit&quot;,</span><br><span class="line">+    ]</span><br><span class="line">+    result = run_script(script)</span><br><span class="line">+    expect(result).to match_array([</span><br><span class="line">+      &quot;db &gt; Executed.&quot;,</span><br><span class="line">+      &quot;db &gt; (1, #&#123;long_username&#125;, #&#123;long_email&#125;)&quot;,</span><br><span class="line">+      &quot;Executed.&quot;,</span><br><span class="line">+      &quot;db &gt; &quot;,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it &apos;prints error message if strings are too long&apos; do</span><br><span class="line">+    long_username = &quot;a&quot;*33</span><br><span class="line">+    long_email = &quot;a&quot;*256</span><br><span class="line">+    script = [</span><br><span class="line">+      &quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;,</span><br><span class="line">+      &quot;select&quot;,</span><br><span class="line">+      &quot;.exit&quot;,</span><br><span class="line">+    ]</span><br><span class="line">+    result = run_script(script)</span><br><span class="line">+    expect(result).to match_array([</span><br><span class="line">+      &quot;db &gt; String is too long.&quot;,</span><br><span class="line">+      &quot;db &gt; Executed.&quot;,</span><br><span class="line">+      &quot;db &gt; &quot;,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it &apos;prints an error message if id is negative&apos; do</span><br><span class="line">+    script = [</span><br><span class="line">+      &quot;insert -1 cstack foo@bar.com&quot;,</span><br><span class="line">+      &quot;select&quot;,</span><br><span class="line">+      &quot;.exit&quot;,</span><br><span class="line">+    ]</span><br><span class="line">+    result = run_script(script)</span><br><span class="line">+    expect(result).to match_array([</span><br><span class="line">+      &quot;db &gt; ID must be positive.&quot;,</span><br><span class="line">+      &quot;db &gt; Executed.&quot;,</span><br><span class="line">+      &quot;db &gt; &quot;,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+end</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/06/057-simple-database-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/06/057-simple-database-3/" class="post-title-link" itemprop="url">Let's Build a Simple Database - An In-Memory,Append-Only,Sinle-Table Database</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-06 21:12:13" itemprop="dateCreated datePublished" datetime="2021-05-06T21:12:13+08:00">2021-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文地址：<a href="https://cstack.github.io/db_tutorial/parts/part3.html" target="_blank" rel="noopener">https://cstack.github.io/db_tutorial/parts/part3.html</a><br>原文作者： <a href="https://github.com/cstack" target="_blank" rel="noopener">cstack</a><br>译者：<a href="https://github.com/Win-Man" target="_blank" rel="noopener">Win-Man</a></p>
</blockquote>
<p>我们通过在我们数据库上设置很多限制，从一个小的数据库开始。这一节，我们会做这些内容：</p>
<ul>
<li>支持两种操作：插入一行数据和查询出所有数据行</li>
<li>将数据存储在内存中（不持久化到硬盘上）</li>
<li>支持单个、表结构固定的表</li>
</ul>
<p>我们表结构固定的表示用于存储用户的，结构是：</p>
<table>
<thead>
<tr>
<th>column</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>integer</td>
</tr>
<tr>
<td>username</td>
<td>varchar(32)</td>
</tr>
<tr>
<td>email</td>
<td>varchar(255)</td>
</tr>
</tbody>
</table>
<p>这是一个简单的表结构，但是可以让我们去支持多种数据格式和多种数据大小。</p>
<p>insert 语句会类似于这个形式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="number">1</span> cstack foo@bar.com</span><br></pre></td></tr></table></figure>
<p>这意味着我们需要更新我们的 <code>prepare_statement</code> 函数去解析参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="keyword">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">+        input_buffer-&gt;buffer, <span class="string">"insert %d %s %s"</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">+        statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line">+    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+    &#125;</span><br><span class="line">     <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">"select"</span>) == <span class="number">0</span>) &#123;</span><br></pre></td></tr></table></figure>
<p>我们将这些解析出来的参数存储到一个 Row 数据结构中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+  <span class="keyword">uint32_t</span> id;</span><br><span class="line">+  <span class="keyword">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">+  <span class="keyword">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+&#125; Row;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   StatementType type;</span><br><span class="line">+  Row row_to_insert;  <span class="comment">// only used by insert statement</span></span><br><span class="line"> &#125; Statement;</span><br></pre></td></tr></table></figure>
<p>现在我们需要将 Row 结构体中的数据拷贝到能代表 table 数据的结构中。 SQLite 使用了 B-tree 数据结构，可以提升查询、插入、删除的速度。我们开始的会更简单一点。类似于 B-tree, 会将行记录分组到 page 页上，但是是将这些数据页以数据形式存储，而不是以树的形式存储。</p>
<p>我们的计划是：</p>
<ul>
<li>将数据行存储在内存页中</li>
<li>每个数据页可以存储尽可能多的行</li>
<li>记录行被序列化成一种压缩的形式</li>
<li>数据页只有在需要的时候才会分配</li>
<li>保持一个固定大小的数据页指针数组</li>
</ul>
<p>首先，我们需要定义一下一行记录的压缩格式是怎么样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line">+</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_SIZE = size_of_attribute(Row, id);</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_SIZE = size_of_attribute(Row, username);</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_SIZE = size_of_attribute(Row, email);</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_OFFSET = ID_OFFSET + ID_SIZE;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_OFFSET = USERNAME_OFFSET + USERNAME_SIZE;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ROW_SIZE = ID_SIZE + USERNAME_SIZE + EMAIL_SIZE;</span><br></pre></td></tr></table></figure>
<p>这意味着被序列化之后的一行数据会是这样的：</p>
<table>
<thead>
<tr>
<th>column</th>
<th>size(bytes)</th>
<th>offset</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>4</td>
<td>0</td>
</tr>
<tr>
<td>username</td>
<td>32</td>
<td>4</td>
</tr>
<tr>
<td>email</td>
<td>255</td>
<td>36</td>
</tr>
<tr>
<td>total</td>
<td>291</td>
</tr>
</tbody>
</table>
<p>我们也需要将编写转换、反转换的代码.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, <span class="keyword">void</span>* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(<span class="keyword">void</span>* source, Row* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;id), source + ID_OFFSET, ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;username), source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;email), source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>
<p>接着，Table 的数据结构就是一个数据页指针和记录这个表内有多少数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> PAGE_SIZE = <span class="number">4096</span>;</span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / ROW_SIZE;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> TABLE_MAX_ROWS = ROWS_PER_PAGE * TABLE_MAX_PAGES;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+  <span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">+  <span class="keyword">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+&#125; Table;</span><br></pre></td></tr></table></figure>
<p>我将我们数据页的大小设置为了 4KB ，因为这也是大多数操作系统使用的数据页大小。意味着我们的使用的数据页大小和操作系统数据页大小是一致的。操作系统会将数据页作为一个整体进行交换，而不是将他们拆散成多个数据页。</p>
<p>我随意设置了一个限制，限制我们只能分配 100 个数据页。当我们转成树结构的时候，我们数据库的最大大小受限于单个文件的大小（尽管我们还是有设置我们在内存中保留多少数据页）</p>
<p>一行数据不能跨数据页存储。因为相邻的数据页可能不会同时存在在内存中，这个限制可以让读写行数据更加容易。</p>
<p>说到这个，看一下我们是如果在内存中定位到需要读取的某一行数据的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+<span class="function"><span class="keyword">void</span>* <span class="title">row_slot</span><span class="params">(Table* table, <span class="keyword">uint32_t</span> row_num)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">+  <span class="keyword">void</span>* page = table-&gt;pages[page_num];</span><br><span class="line">+  <span class="keyword">if</span> (page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+    <span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">+    page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">+  <span class="keyword">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">+  <span class="keyword">return</span> page + byte_offset;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们可以让 execute_statement 从表结构体中读取或者写入数据了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">-<span class="function"><span class="keyword">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (table-&gt;num_rows &gt;= TABLE_MAX_ROWS) &#123;</span><br><span class="line">+    <span class="keyword">return</span> EXECUTE_TABLE_FULL;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Row* row_to_insert = &amp;(statement-&gt;row_to_insert);</span><br><span class="line">+</span><br><span class="line">+  serialize_row(row_to_insert, row_slot(table, table-&gt;num_rows));</span><br><span class="line">+  table-&gt;num_rows += <span class="number">1</span>;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  Row row;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; table-&gt;num_rows; i++) &#123;</span><br><span class="line">+    deserialize_row(row_slot(table, i), &amp;row);</span><br><span class="line">+    print_row(&amp;row);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">     <span class="keyword">case</span> (STATEMENT_INSERT):</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">"This is where we would do an insert.\n"</span>);</span><br><span class="line">-      <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">return</span> execute_insert(statement, table);</span><br><span class="line">     <span class="keyword">case</span> (STATEMENT_SELECT):</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">"This is where we would do a select.\n"</span>);</span><br><span class="line">-      <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">return</span> execute_select(statement, table);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们需要初始化一下表，创建释放各自内存的函数以及处理更多错误的情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ <span class="function">Table* <span class="title">new_table</span><span class="params">()</span> </span>&#123;</span><br><span class="line">+  Table* table = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Table));</span><br><span class="line">+  table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+     table-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> table;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; table-&gt;pages[i]; i++) &#123;</span><br><span class="line">+	<span class="built_in">free</span>(table-&gt;pages[i]);</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="built_in">free</span>(table);</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">+  Table* table = new_table();</span><br><span class="line">   InputBuffer* input_buffer = new_input_buffer();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     print_prompt();</span><br><span class="line">@@ <span class="number">-105</span>,<span class="number">13</span> +<span class="number">203</span>,<span class="number">22</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">       <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"Syntax error. Could not parse statement.\n"</span>);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">       <span class="keyword">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"Unrecognized keyword at start of '%s'.\n"</span>,</span><br><span class="line">                input_buffer-&gt;buffer);</span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">-    execute_statement(&amp;statement);</span><br><span class="line">-    <span class="built_in">printf</span>(<span class="string">"Executed.\n"</span>);</span><br><span class="line">+    <span class="keyword">switch</span> (execute_statement(&amp;statement, table)) &#123;</span><br><span class="line">+      <span class="keyword">case</span> (EXECUTE_SUCCESS):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"Executed.\n"</span>);</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (EXECUTE_TABLE_FULL):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"Error: Table full.\n"</span>);</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>经过这些修改，我们就可以真正的在我们的数据库中存储数据了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~ ./db</span><br><span class="line">db &gt; insert 1 cstack foo@bar.com</span><br><span class="line">Executed.</span><br><span class="line">db &gt; insert 2 bob bob@example.com</span><br><span class="line">Executed.</span><br><span class="line">db &gt; select</span><br><span class="line">(1, cstack, foo@bar.com)</span><br><span class="line">(2, bob, bob@example.com)</span><br><span class="line">Executed.</span><br><span class="line">db &gt; insert foo bar 1</span><br><span class="line">Syntax error. Could not parse statement.</span><br><span class="line">db &gt; .exit</span><br></pre></td></tr></table></figure>
<p>这时候是写一些测试的好时候了，因为以下几个原因：</p>
<ul>
<li>我们计划修改数据结构去存储我们的表，有测试的话可以方便捕捉到回归错误</li>
<li>有一些边缘 case 我们没有手动测试（比如填满一张表）</li>
</ul>
<p>我们会在下一个部分做这些内容。现在先看下这个部分完整修改的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line">@@ <span class="number">-2</span>,<span class="number">6</span> +<span class="number">2</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   <span class="keyword">char</span>* buffer;</span><br><span class="line">@@ <span class="number">-10</span>,<span class="number">6</span> +<span class="number">11</span>,<span class="number">105</span> @@ <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"> &#125; InputBuffer;</span><br><span class="line"></span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; EXECUTE_SUCCESS, EXECUTE_TABLE_FULL &#125; ExecuteResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  META_COMMAND_SUCCESS,</span><br><span class="line">+  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">+&#125; MetaCommandResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_SYNTAX_ERROR,</span><br><span class="line">+  PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">+ &#125; PrepareResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+  <span class="keyword">uint32_t</span> id;</span><br><span class="line">+  <span class="keyword">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">+  <span class="keyword">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+&#125; Row;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+  StatementType type;</span><br><span class="line">+  Row row_to_insert; <span class="comment">//only used by insert statement</span></span><br><span class="line">+&#125; Statement;</span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line">+</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_SIZE = size_of_attribute(Row, id);</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_SIZE = size_of_attribute(Row, username);</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_SIZE = size_of_attribute(Row, email);</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_OFFSET = ID_OFFSET + ID_SIZE;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_OFFSET = USERNAME_OFFSET + USERNAME_SIZE;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ROW_SIZE = ID_SIZE + USERNAME_SIZE + EMAIL_SIZE;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> PAGE_SIZE = <span class="number">4096</span>;</span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / ROW_SIZE;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">uint32_t</span> TABLE_MAX_ROWS = ROWS_PER_PAGE * TABLE_MAX_PAGES;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+  <span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">+  <span class="keyword">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+&#125; Table;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">printf</span>(<span class="string">"(%d, %s, %s)\n"</span>, row-&gt;id, row-&gt;username, row-&gt;email);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, <span class="keyword">void</span>* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(<span class="keyword">void</span> *source, Row* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;id), source + ID_OFFSET, ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;username), source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;email), source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span>* <span class="title">row_slot</span><span class="params">(Table* table, <span class="keyword">uint32_t</span> row_num)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">+  <span class="keyword">void</span> *page = table-&gt;pages[page_num];</span><br><span class="line">+  <span class="keyword">if</span> (page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+     <span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">+     page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">+  <span class="keyword">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">+  <span class="keyword">return</span> page + byte_offset;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">Table* <span class="title">new_table</span><span class="params">()</span> </span>&#123;</span><br><span class="line">+  Table* table = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Table));</span><br><span class="line">+  table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+     table-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> table;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; table-&gt;pages[i]; i++) &#123;</span><br><span class="line">+     <span class="built_in">free</span>(table-&gt;pages[i]);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="built_in">free</span>(table);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(InputBuffer));</span><br><span class="line">   input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">@@ <span class="number">-40</span>,<span class="number">17</span> +<span class="number">140</span>,<span class="number">105</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">free</span>(input_buffer);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">+<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table *table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    close_input_buffer(input_buffer);</span><br><span class="line">+    free_table(table);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">+  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="keyword">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">+	input_buffer-&gt;buffer, <span class="string">"insert %d %s %s"</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">+	statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email</span><br><span class="line">+	);</span><br><span class="line">+    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+	<span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">"select"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (table-&gt;num_rows &gt;= TABLE_MAX_ROWS) &#123;</span><br><span class="line">+     <span class="keyword">return</span> EXECUTE_TABLE_FULL;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Row* row_to_insert = &amp;(statement-&gt;row_to_insert);</span><br><span class="line">+</span><br><span class="line">+  serialize_row(row_to_insert, row_slot(table, table-&gt;num_rows));</span><br><span class="line">+  table-&gt;num_rows += <span class="number">1</span>;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  Row row;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; table-&gt;num_rows; i++) &#123;</span><br><span class="line">+     deserialize_row(row_slot(table, i), &amp;row);</span><br><span class="line">+     print_row(&amp;row);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table *table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">+    <span class="keyword">case</span> (STATEMENT_INSERT):</span><br><span class="line">+       	<span class="keyword">return</span> execute_insert(statement, table);</span><br><span class="line">+    <span class="keyword">case</span> (STATEMENT_SELECT):</span><br><span class="line">+	<span class="keyword">return</span> execute_select(statement, table);</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">+  Table* table = new_table();</span><br><span class="line">   InputBuffer* input_buffer = new_input_buffer();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     print_prompt();</span><br><span class="line">     read_input(input_buffer);</span><br><span class="line"></span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      close_input_buffer(input_buffer);</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'.\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (do_meta_command(input_buffer, table)) &#123;</span><br><span class="line">+        <span class="keyword">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="keyword">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line">+	<span class="built_in">printf</span>(<span class="string">"Syntax error. Could not parse statement.\n"</span>);</span><br><span class="line">+	<span class="keyword">continue</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"Unrecognized keyword at start of '%s'.\n"</span>,</span><br><span class="line">+               input_buffer-&gt;buffer);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">switch</span> (execute_statement(&amp;statement, table)) &#123;</span><br><span class="line">+	<span class="keyword">case</span> (EXECUTE_SUCCESS):</span><br><span class="line">+	    <span class="built_in">printf</span>(<span class="string">"Executed.\n"</span>);</span><br><span class="line">+	    <span class="keyword">break</span>;</span><br><span class="line">+	<span class="keyword">case</span> (EXECUTE_TABLE_FULL):</span><br><span class="line">+	    <span class="built_in">printf</span>(<span class="string">"Error: Table full.\n"</span>);</span><br><span class="line">+	    <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/12/057-travis-troubleshooting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/12/057-travis-troubleshooting/" class="post-title-link" itemprop="url">hexo next 主题通过 travis ci 执行 hexo generate 报错</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-12 21:12:13" itemprop="dateCreated datePublished" datetime="2021-04-12T21:12:13+08:00">2021-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/troubleshooting/" itemprop="url" rel="index"><span itemprop="name">troubleshooting</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><p>前段时间给 github page 换了一个 hexo 主题，换成了 <a href="https://theme-next.iissnan.com/" target="_blank" rel="noopener">next</a> 主题，但是在更换主题之后，发现 travis 上的 CI 无法跑过了，查看日志内容如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> node --version</span><br><span class="line">v6.9.4</span><br><span class="line"><span class="meta">$</span> npm --version</span><br><span class="line">3.10.10</span><br><span class="line"><span class="meta">$</span> nvm --version</span><br><span class="line">0.37.2</span><br><span class="line">before_install.1</span><br><span class="line">0.01s$ export TZ='Asia/Shanghai'</span><br><span class="line">before_install.2</span><br><span class="line">6.90s$ npm install -g hexo</span><br><span class="line">before_install.3</span><br><span class="line">2.81s$ npm install -g hexo-cli</span><br><span class="line">install</span><br><span class="line">1.54s$ npm install</span><br><span class="line">before_script.1</span><br><span class="line">0.01s$ git config --global user.name "Win-Man"</span><br><span class="line">before_script.2</span><br><span class="line">0.00s$ git config --global user.email 825895587@qq.com</span><br><span class="line">before_script.3</span><br><span class="line">0.00s$ sed -i'' "s~git@github.com:Win-Man/win-man.github.io.git~https://$&#123;CI_TOKEN&#125;@github.com/Win-Man/win-man.github.io.git~" _config.yml</span><br><span class="line">0.67s$ hexo clean</span><br><span class="line">The command "hexo clean" exited with 0.</span><br><span class="line">1.17s$ hexo generate</span><br><span class="line">INFO  Start processing</span><br><span class="line">FATAL Something's wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">TypeError: Object.values is not a function</span><br><span class="line">    at points.views.forEach.type (/home/travis/build/Win-Man/win-man.github.io/themes/next/scripts/events/lib/injects.js:82:46)</span><br><span class="line">    at Array.forEach (native)</span><br><span class="line">    at module.exports.hexo (/home/travis/build/Win-Man/win-man.github.io/themes/next/scripts/events/lib/injects.js:67:16)</span><br><span class="line">    at Hexo.hexo.on (/home/travis/build/Win-Man/win-man.github.io/themes/next/scripts/events/index.js:9:27)</span><br><span class="line">    at emitNone (events.js:86:13)</span><br><span class="line">    at Hexo.emit (events.js:185:7)</span><br><span class="line">    at Hexo._generate (/home/travis/build/Win-Man/win-man.github.io/node_modules/hexo/lib/hexo/index.js:399:8)</span><br><span class="line">    at loadDatabase.then.then (/home/travis/build/Win-Man/win-man.github.io/node_modules/hexo/lib/hexo/index.js:249:22)</span><br><span class="line">    at tryCatcher (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">    at Promise._settlePromiseFromHandler (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">    at Promise._settlePromise (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">    at Promise._settlePromise0 (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise.js:649:10)</span><br><span class="line">    at Promise._settlePromises (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise.js:729:18)</span><br><span class="line">    at Promise._fulfill (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise.js:673:18)</span><br><span class="line">    at PromiseArray._resolve (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise_array.js:127:19)</span><br><span class="line">    at PromiseArray._promiseFulfilled (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise_array.js:145:14)</span><br><span class="line">    at Promise._settlePromise (/home/travis/build/Win-Man/win-man.github.io/node_modules/bluebird/js/release/promise.js:609:26)</span><br><span class="line">The command "hexo generate" exited with 2.</span><br><span class="line">cache.2</span><br><span class="line">store build cache</span><br></pre></td></tr></table></figure>
<p>但是在我本地电脑执行 <code>hexo g</code>,<code>hexo s</code>,<code>hexo d</code> 都没啥问题，怀疑到了 node js 版本的问题，因为这个 repo 中的 <code>.travis.yml</code> 配置文件还是好几年前的了，于是尝试修改 node js 版本与本地版本一致。修改版本并提交之后还是有报错，但是报错信息变了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> node --version</span><br><span class="line">v13.11.0</span><br><span class="line"><span class="meta">$</span> npm --version</span><br><span class="line">6.13.7</span><br><span class="line"><span class="meta">$</span> nvm --version</span><br><span class="line">0.37.2</span><br><span class="line">before_install.1</span><br><span class="line">0.01s$ export TZ='Asia/Shanghai'</span><br><span class="line">before_install.2</span><br><span class="line">5.40s$ npm install -g hexo</span><br><span class="line">3.16s$ npm install -g hexo-cli</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@~2.3.1 (node_modules/hexo-cli/node_modules/chokidar/node_modules/fsevents):</span><br><span class="line">npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@2.3.2: wanted &#123;"os":"darwin","arch":"any"&#125; (current: &#123;"os":"linux","arch":"x64"&#125;)</span><br><span class="line">npm ERR! code EEXIST</span><br><span class="line">npm ERR! syscall symlink</span><br><span class="line">npm ERR! path ../lib/node_modules/hexo-cli/bin/hexo</span><br><span class="line">npm ERR! dest /home/travis/.nvm/versions/node/v13.11.0/bin/hexo</span><br><span class="line">npm ERR! errno -17</span><br><span class="line">npm ERR! EEXIST: file already exists, symlink '../lib/node_modules/hexo-cli/bin/hexo' -&gt; '/home/travis/.nvm/versions/node/v13.11.0/bin/hexo'</span><br><span class="line">npm ERR! File exists: /home/travis/.nvm/versions/node/v13.11.0/bin/hexo</span><br><span class="line">npm ERR! Remove the existing file and try again, or run npm</span><br><span class="line">npm ERR! with --force to overwrite files recklessly.</span><br><span class="line">npm ERR! A complete log of this run can be found in:</span><br><span class="line">npm ERR!     /home/travis/.npm/_logs/2021-04-12T06_49_56_362Z-debug.log</span><br><span class="line">The command "npm install -g hexo-cli" failed and exited with 239 during .</span><br></pre></td></tr></table></figure>
<p>根据错误信息查找到一个链接<br><a href="https://segmentfault.com/a/1190000018759308" target="_blank" rel="noopener">https://segmentfault.com/a/1190000018759308</a></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>参考链接中的结果方案在 <code>npm install</code> 中加上 <code>-f</code> 选项。<br>附上完整的 <code>.travis.yml</code> 内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">language: node_js</span><br><span class="line">node_js:</span><br><span class="line">- &apos;13.11.0&apos;</span><br><span class="line">branches:</span><br><span class="line">  only:</span><br><span class="line">  - dev</span><br><span class="line">cache:</span><br><span class="line">  directories:</span><br><span class="line">  - node_modules</span><br><span class="line">before_install:</span><br><span class="line">- export TZ=&apos;Asia/Shanghai&apos;</span><br><span class="line">- npm install -g hexo</span><br><span class="line">- npm install -g hexo-cli -f</span><br><span class="line">before_script:</span><br><span class="line">- git config --global user.name &quot;Win-Man&quot;</span><br><span class="line">- git config --global user.email 825895587@qq.com</span><br><span class="line">- sed -i&apos;&apos; &quot;s~git@github.com:Win-Man/win-man.github.io.git~https://$&#123;CI_TOKEN&#125;@github.com/Win-Man/win-man.github.io.git~&quot; _config.yml</span><br><span class="line">install:</span><br><span class="line">- npm install -f</span><br><span class="line">script:</span><br><span class="line">- hexo clean</span><br><span class="line">- hexo generate</span><br><span class="line">after_success:</span><br><span class="line">- hexo deploy</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/11/056-simple-database-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/11/056-simple-database-2/" class="post-title-link" itemprop="url">Let's Build a Simple Database - World's Simplest SQL Compiler and Virtual Machine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-11 21:12:13" itemprop="dateCreated datePublished" datetime="2021-04-11T21:12:13+08:00">2021-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文地址：<a href="https://cstack.github.io/db_tutorial/parts/part2.html" target="_blank" rel="noopener">https://cstack.github.io/db_tutorial/parts/part2.html</a><br>原文作者： <a href="https://github.com/cstack" target="_blank" rel="noopener">cstack</a><br>译者：<a href="https://github.com/Win-Man" target="_blank" rel="noopener">Win-Man</a></p>
</blockquote>
<h2 id="世界上最简单的-SQL-编译器和字节码虚拟机"><a href="#世界上最简单的-SQL-编译器和字节码虚拟机" class="headerlink" title="世界上最简单的 SQL 编译器和字节码虚拟机"></a>世界上最简单的 SQL 编译器和字节码虚拟机</h2><p>我们正在写一个 sqlite 的克隆版本。sqlite 中 SQL 编译器是一个解析一个 string 输入并输出一个内部可识别的字节码。然后 sqlite 编译之后的字节码传给字节码虚拟机，在虚拟机中执行 SQL。</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch2.gif" alt></p>
<p><center>SQLite Architecture (<a href="https://www.sqlite.org/arch.html" target="_blank" rel="noopener">https://www.sqlite.org/arch.html</a>)<center></center></center></p>
<p>将这些内容拆成两个步骤有一些优势点：</p>
<ul>
<li>减少每个部门的复杂度（例如：字节码虚拟机不用考虑语法错误）</li>
<li>对于相同的查询可以只需要编译一次，将编译后的字节码缓存住，以此可以提高性能</li>
</ul>
<p>基于这个想法，我们重构一下我们的主函数来支持两个新的关键字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = new_input_buffer();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     print_prompt();</span><br><span class="line">     read_input(input_buffer);</span><br><span class="line"></span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'.\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (do_meta_command(input_buffer)) &#123;</span><br><span class="line">+        <span class="keyword">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="keyword">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"Unrecognized keyword at start of '%s'.\n"</span>,</span><br><span class="line">+               input_buffer-&gt;buffer);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    execute_statement(&amp;statement);</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">"Executed.\n"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>像 <code>.exit</code> 这种非 SQL 的语句被称为“元指令”。这些元指令都是以 <code>.</code> 开始的，所以我们可以将这类语句单独在一个独立的函数中处理。</p>
<p>接下来，我们增加一个步骤用于将输入的行转换为数据库内部表达式。这就是我们对于 sqlite 前端的 hack 版本。</p>
<p>最后，我们将预处理好的语句传递给 <code>execute_statement</code>。这个函数后续会演进成我们的字节码虚拟机。</p>
<p>需要需要的是我们新增加了两个函数，并且这两个函数返回 enum 来表示成功或者失败。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">  META_COMMAND_SUCCESS,</span><br><span class="line">  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">&#125; MetaCommandResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; PREPARE_SUCCESS, PREPARE_UNRECOGNIZED_STATEMENT &#125; PrepareResult;</span><br></pre></td></tr></table></figure>
<p>“Unrecognized statement” 语句表示这个语句像是一个表达式，但是表达式有错误，所以我们在任何情况都使用 enum 枚举结果代码。C 语言的编译器会报错如果我的 switch 语句不能处理枚举的项，所以我们可以确保处理了这个函数的每个结果。在将来可能会添加更多的结果代码。</p>
<p><code>do_meta_command</code> 只是现有函数的一个封装，为了之后可处理更多的命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前我们的预处理语句只是包含了有两个可能结果的枚举数组。这可能会包含更多的数据如果我们允许在语句中传入参数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  StatementType type;</span><br><span class="line">&#125; Statement;</span><br></pre></td></tr></table></figure>
<p><code>prepare_statement</code>（我们的 SQL 编译器）目前还无法识别 SQL 语句。事实上这个函数只能识别两个单词：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PrepareResult prepare_statement(InputBuffer* input_buffer,</span><br><span class="line">                                Statement* statement) &#123;</span><br><span class="line">  if (strncmp(input_buffer-&gt;buffer, &quot;insert&quot;, 6) == 0) &#123;</span><br><span class="line">    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">    return PREPARE_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line">  if (strcmp(input_buffer-&gt;buffer, &quot;select&quot;) == 0) &#123;</span><br><span class="line">    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">    return PREPARE_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是我们使用 strncmp 对比 insert 因为 insert 关键字之后会跟着插入的数据。（例如：insert 1 cstack <a href="mailto:foo@bar.com" target="_blank" rel="noopener">foo@bar.com</a>）</p>
<p>最后，<code>execute_statement</code> 包含了一些分支：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> (STATEMENT_INSERT):</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"This is where we would do an insert.\n"</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> (STATEMENT_SELECT):</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"This is where we would do a select.\n"</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这边并没有返回任何错误码因为目前为止这边还不会发生任何错误。</p>
<p>经过这些重构之后，我们现在的 sqlite 可以认识两个新的关键字。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ ./db</span><br><span class="line">db &gt; insert foo bar</span><br><span class="line">This is where we would <span class="keyword">do</span> an insert.</span><br><span class="line">Executed.</span><br><span class="line">db &gt; <span class="keyword">delete</span> foo</span><br><span class="line">Unrecognized keyword <span class="keyword">at</span> <span class="keyword">start</span> <span class="keyword">of</span> <span class="string">'delete foo'</span>.</span><br><span class="line">db &gt; <span class="keyword">select</span></span><br><span class="line">This <span class="keyword">is</span> <span class="keyword">where</span> we would <span class="keyword">do</span> a select.</span><br><span class="line">Executed.</span><br><span class="line">db &gt; .tables</span><br><span class="line">Unrecognized command <span class="string">'.tables'</span></span><br><span class="line">db &gt; .exit</span><br><span class="line">~</span><br></pre></td></tr></table></figure>
<p>我们数据库的基本框架基本已经形成了，如果不用存储数据的话，这是不是很好？在下一个部分，我们会去实现 insert 和 select 语句，创造世界上最差劲的存储引擎。同时在这给出这一差异部分的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">@@ <span class="number">-10</span>,<span class="number">6</span> +<span class="number">10</span>,<span class="number">23</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">InputBuffer_t</span> &#123;</span></span><br><span class="line"> &#125; InputBuffer;</span><br><span class="line"> </span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  META_COMMAND_SUCCESS,</span><br><span class="line">+  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">+&#125; MetaCommandResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; PREPARE_SUCCESS, PREPARE_UNRECOGNIZED_STATEMENT &#125; PrepareResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+  StatementType type;</span><br><span class="line">+&#125; Statement;</span><br><span class="line">+</span><br><span class="line"> <span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(InputBuffer));</span><br><span class="line">   input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">@@ <span class="number">-40</span>,<span class="number">17</span> +<span class="number">57</span>,<span class="number">67</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">free</span>(input_buffer);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    close_input_buffer(input_buffer);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">+  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">"insert"</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">"select"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">+    <span class="keyword">case</span> (STATEMENT_INSERT):</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">"This is where we would do an insert.\n"</span>);</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+    <span class="keyword">case</span> (STATEMENT_SELECT):</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">"This is where we would do a select.\n"</span>);</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = new_input_buffer();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     print_prompt();</span><br><span class="line">     read_input(input_buffer);</span><br><span class="line"> </span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      close_input_buffer(input_buffer);</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'.\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (do_meta_command(input_buffer)) &#123;</span><br><span class="line">+        <span class="keyword">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="keyword">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (prepare_statement(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"Unrecognized keyword at start of '%s'.\n"</span>,</span><br><span class="line">+               input_buffer-&gt;buffer);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    execute_statement(&amp;statement);</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">"Executed.\n"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/27/055-simple-database-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/27/055-simple-database-1/" class="post-title-link" itemprop="url">Let's Build a Simple Database - Introduction and Setting up the REPL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-27 21:12:13" itemprop="dateCreated datePublished" datetime="2021-03-27T21:12:13+08:00">2021-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文地址：<a href="https://cstack.github.io/db_tutorial/parts/part1.html" target="_blank" rel="noopener">https://cstack.github.io/db_tutorial/parts/part1.html</a><br>原文作者： <a href="https://github.com/cstack" target="_blank" rel="noopener">cstack</a><br>译者：<a href="https://github.com/Win-Man" target="_blank" rel="noopener">Win-Man</a></p>
</blockquote>
<h2 id="介绍并设置-REPL"><a href="#介绍并设置-REPL" class="headerlink" title="介绍并设置 REPL"></a>介绍并设置 REPL</h2><p>作为一个 Web 开发人员，我每天的工作中都会使用到关系型数据库，但是这些数据库对于我来说就是一个黑盒。因此我有一些疑问：</p>
<ul>
<li>在内存中、在磁盘上数据存储格式是怎么样的？</li>
<li>什么时候数据库从内存转移到磁盘？</li>
<li>为什么每个表只能有一个主键？</li>
<li>事务回滚是如何工作的？</li>
<li>索引的格式是怎么样的？</li>
<li>什么时候会发生全表扫以及全表扫是如何工作的？</li>
<li>预处理语句是以什么形式存储的？</li>
</ul>
<p>简而言之，问题就是数据库是怎么工作的？</p>
<p>为了搞清楚这些问题，我从头开始写了一个数据库。它是模拟 sqlite 数据库实现的，因为 sqlite 设计的就是一个比 MySQL 或者 PostgreSQL 特性更少的数据库。所以我更有希望理解它。这整个数据库都存储在一个文件中。</p>
<h2 id="Sqlite"><a href="#Sqlite" class="headerlink" title="Sqlite"></a>Sqlite</h2><p>sqlite 官网上有很多关于 <a href="https://www.sqlite.org/arch.html" target="_blank" rel="noopener">sqlite 内核</a>的文档，除此之外我还有一份资料 <a href="https://play.google.com/store/books/details?id=9Z6IQQnX1JEC" target="_blank" rel="noopener">SQLite Database System: Design and Implementation</a></p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch1.gif" alt></p>
<p><center>sqlite architecture(<a href="https://www.sqlite.org/zipvfs/doc/trunk/www/howitworks.wiki" target="_blank" rel="noopener">https://www.sqlite.org/zipvfs/doc/trunk/www/howitworks.wiki</a>)<center></center></center></p>
<p>一个查询如果要获得数据或者修改数据的话，需要经过一系列的组件。前端包括：</p>
<ul>
<li>tokenizer</li>
<li>parser</li>
<li>code generator</li>
</ul>
<p>前端的输入是一个 SQL 查询. 输出的是 sqlite 虚拟机字节码(本质上是一个可以在数据库上操作的编译程序)</p>
<p>后端包括：</p>
<ul>
<li>virtual machine</li>
<li>B-tree</li>
<li>pager</li>
<li>os interface</li>
</ul>
<p>virtual machine 虚拟机接收前端生成的字节码作为指令。这些指令可以操作一个或多个表、索引，表和索引都是以 B 树的数据结构存储的。虚拟机本质上是一个大的语句与字节码指令转换器。</p>
<p>每棵 B-tree 包含很多节点。每个节点的长度是一页。B 树可以从磁盘上读取一页的数据或者通过命令将数据写回到数据库。</p>
<p>pager 组件接收读取或者写入数据的指令。它需要在正确的数据库数据文件位置写入或者读取数据，也需要将最近访问到的数据页缓存到内存中，并且决定什么时候将这些数据缓存页写到磁盘上。</p>
<p>os interface 操作系统接口层取决于 sqlite 是在哪个操作系统层编译的。在这个课程中，我不会支持多个操作系统平台。</p>
<p>千里之行，始于足下，让我们从一些比较简单的内容开始：REPL（交互式顶层构件）。</p>
<h2 id="实现一个简单的-REPL"><a href="#实现一个简单的-REPL" class="headerlink" title="实现一个简单的 REPL"></a>实现一个简单的 REPL</h2><p>当你从命令行启动 sqlite client 的时候，会启动一个循环读取命令并执行命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~ sqlite3</span><br><span class="line">SQLite version <span class="number">3.16</span><span class="number">.0</span> <span class="number">2016</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">09</span>:<span class="number">39</span></span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">Connected to a transient in-memory database.</span><br><span class="line">Use <span class="string">".open FILENAME"</span> to reopen on a persistent database.</span><br><span class="line">sqlite&gt; <span class="function">create table <span class="title">users</span> <span class="params">(id <span class="keyword">int</span>, username varchar(<span class="number">255</span>), email varchar(<span class="number">255</span>))</span></span>;</span><br><span class="line">sqlite&gt; .tables</span><br><span class="line">users</span><br><span class="line">sqlite&gt; .<span class="built_in">exit</span></span><br><span class="line">~</span><br></pre></td></tr></table></figure>
<p>为了实现这个，我们的主函数会有一个无限输出提示符的循环，它会从读取一行输入，然后处理一行输入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = new_input_buffer();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    print_prompt();</span><br><span class="line">    read_input(input_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      close_input_buffer(input_buffer);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'.\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要定义一个 <code>InputBuffer</code> 结构体来存储 <code>getline()</code> 函数得到的内容及信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span>* buffer;</span><br><span class="line">  <span class="keyword">size_t</span> buffer_length;</span><br><span class="line">  <span class="keyword">ssize_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = (InputBuffer*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(InputBuffer));</span><br><span class="line">  input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">  input_buffer-&gt;buffer_length = <span class="number">0</span>;</span><br><span class="line">  input_buffer-&gt;input_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> input_buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>print_prompt()</code> 函数用于输出提示符。我们需要在读取输入之前需要打印提示符。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_prompt</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">"db &gt; "</span>); &#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>getline()</code> 函数读取一行输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">getline</span><span class="params">(<span class="keyword">char</span> **lineptr, <span class="keyword">size_t</span> *n, FILE *stream)</span></span>;</span><br></pre></td></tr></table></figure>
<p>lineptr: 存储输入内容的缓冲区地址指针。如果被 getline() 函数 mallocated 了 NULL 值，那么用户需要手动释放该空间，即使命令执行失败了。</p>
<p>n：存储分配的缓冲区大小值的变量指针</p>
<p>stream: 读取输入流，我们会从标准输入中读取。</p>
<p>返回值：读取的字节数，有可能比缓冲区大小小。</p>
<p>我们通过 getline() 函数，将读取的输入存储在 <code>input_buffer-&gt;buffer</code> 中，分配的缓冲区大小存储在 <code>input_buffer-&gt;buffer_length</code> 中。并且将返回结构存储在 <code>input_buffer-&gt;input_length</code>。</p>
<p>初始环境下，缓冲区是空的，所以 getline 需要分配足够的内存用于存放输入并将指针指向缓冲区。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> bytes_read =</span><br><span class="line">      getline(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length), <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error reading input\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ignore trailing newline</span></span><br><span class="line">  input_buffer-&gt;input_length = bytes_read - <span class="number">1</span>;</span><br><span class="line">  input_buffer-&gt;buffer[bytes_read - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就该定义一个函数用来释放 <code>InputBuffer *</code> 实例的内存以及相应结构中的元素内存（getline 会在 read_input 的时候分配内存给 input_buffer-&gt;buffer）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">    <span class="built_in">free</span>(input_buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们需要解析并执行命令。目前这只能识别一个命令 <code>.exit</code>，用于退出程序。其他的输入命令我们会输出一个错误然后继续读取新的输入。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">  close_input_buffer(input_buffer);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'.\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来尝试一下！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ ./db</span><br><span class="line">db &gt; .tables</span><br><span class="line">Unrecognized command '.tables'.</span><br><span class="line">db &gt; .exit</span><br><span class="line">~</span><br></pre></td></tr></table></figure>
<p>好了，我们现在有了一个可以使用的 REPL 程序。在下一部分中，我们会开始开发我们的命令语言。同时，在这给出这个部分的完整程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span>* buffer;</span><br><span class="line">  <span class="keyword">size_t</span> buffer_length;</span><br><span class="line">  <span class="keyword">ssize_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(InputBuffer));</span><br><span class="line">  input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">  input_buffer-&gt;buffer_length = <span class="number">0</span>;</span><br><span class="line">  input_buffer-&gt;input_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> input_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_prompt</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">"db &gt; "</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> bytes_read =</span><br><span class="line">      getline(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length), <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error reading input\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ignore trailing newline</span></span><br><span class="line">  input_buffer-&gt;input_length = bytes_read - <span class="number">1</span>;</span><br><span class="line">  input_buffer-&gt;buffer[bytes_read - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">    <span class="built_in">free</span>(input_buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = new_input_buffer();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    print_prompt();</span><br><span class="line">    read_input(input_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">".exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      close_input_buffer(input_buffer);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Unrecognized command '%s'.\n"</span>, input_buffer-&gt;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/27/054-simple-database-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/27/054-simple-database-0/" class="post-title-link" itemprop="url">Let's Build a Simple Database - How Does a Database Work</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-27 17:12:13" itemprop="dateCreated datePublished" datetime="2021-03-27T17:12:13+08:00">2021-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文地址：<a href="https://cstack.github.io/db_tutorial/" target="_blank" rel="noopener">https://cstack.github.io/db_tutorial/</a><br>原文作者： <a href="https://github.com/cstack" target="_blank" rel="noopener">cstack</a><br>译者：<a href="https://github.com/Win-Man" target="_blank" rel="noopener">Win-Man</a></p>
</blockquote>
<h2 id="一个数据库是如何工作的？"><a href="#一个数据库是如何工作的？" class="headerlink" title="一个数据库是如何工作的？"></a>一个数据库是如何工作的？</h2><ul>
<li>在内存中、在磁盘上数据存储格式是怎么样的？</li>
<li>什么时候数据库从内存转移到磁盘？</li>
<li>为什么每个表只能有一个主键？</li>
<li>事务回滚是如何工作的？</li>
<li>索引的格式是怎么样的？</li>
<li>什么时候会发生全表扫以及全表扫是如何工作的？</li>
<li>预处理语句是以什么形式存储的？</li>
</ul>
<p>简而言之，问题就是数据库是怎么工作的？</p>
<p>为了搞明白这个问题，我用 C 写了一个 <a href="https://www.sqlite.org/arch.html" target="_blank" rel="noopener">sqlite</a> 的克隆版本，并且记录了我的整个过程。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="https://cstack.github.io/db_tutorial/parts/part1.html" target="_blank" rel="noopener">Part1 - 介绍并设置 REPL</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part2.html" target="_blank" rel="noopener">Part2 - 世界上最简单的 SQL 编译器以及虚拟机</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part3.html" target="_blank" rel="noopener">Part3 - 一个只允许追加、单表、内存数据库</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part4.html" target="_blank" rel="noopener">Part4 - 我们的第一个测试(Bug)</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part5.html" target="_blank" rel="noopener">Part5 - 磁盘持久化</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part6.html" target="_blank" rel="noopener">Part6 - 抽象游标</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part7.html" target="_blank" rel="noopener">Part7 - B 树介绍</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part8.html" target="_blank" rel="noopener">Part8 - B 树叶子节点结构</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part9.html" target="_blank" rel="noopener">Part9 - 二进制搜索以及重复键</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part10.html" target="_blank" rel="noopener">Part10 - 叶子节点的分裂</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part11.html" target="_blank" rel="noopener">Part11 - B 树的递归搜索</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part12.html" target="_blank" rel="noopener">Part12 - 扫描 Multi-Level B 树</a></li>
<li><a href="https://cstack.github.io/db_tutorial/parts/part13.html" target="_blank" rel="noopener">Part13 - 分裂之后更新父节点</a></li>
</ul>
<p>“What I cannot create, I do not understand” - Richard Feynman</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch2.gif" alt="sqlite architecture"></p>
<center>sqlite architecture (<a href="https://www.sqlite.org/arch.html" target="_blank" rel="noopener">https://www.sqlite.org/arch.html</a>)</center>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/23/053-mysql-query-rewrite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/23/053-mysql-query-rewrite/" class="post-title-link" itemprop="url">MySQL query rewrite</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-23 10:52:34" itemprop="dateCreated datePublished" datetime="2021-02-23T10:52:34+08:00">2021-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-query-rewrite"><a href="#MySQL-query-rewrite" class="headerlink" title="MySQL query rewrite"></a>MySQL query rewrite</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>MySQL 从 5.7.6 版本开始支持 SQL 改写的功能，对于符合条件的 SQL 可以进行对应的修改。在 8.0.12 之前的版本只支持 SELECT 语句的改写，8.0.12 版本开始支持 SELECT/INSERT/REPLACE/UPDATE/DELETE 语句的改写。</p>
<h2 id="Query-Rewrite-Plugin-安装"><a href="#Query-Rewrite-Plugin-安装" class="headerlink" title="Query Rewrite Plugin 安装"></a>Query Rewrite Plugin 安装</h2><p>安装 Query Rewrite Plugin 直接通过运行 install_rewriter.sql 中的 SQL 来进行安装即可，如果需要卸载的话，执行 uninstall_rewriter.sql 就可以，这两个 sql 文本文件存放在安装目录的 share 目录下。</p>
<ul>
<li>执行 install_rewriter.sql 安装插件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -uroot -p -h127.0.0.1 &lt; install_rewriter.sql</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过变量确认插件开启</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@127.0.0.1 : (none) 03:53:58&gt; SHOW GLOBAL VARIABLES LIKE 'rewriter_enabled';</span><br><span class="line">+<span class="comment">------------------+-------+</span></span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+<span class="comment">------------------+-------+</span></span><br><span class="line">| rewriter_enabled | ON    |</span><br><span class="line">+<span class="comment">------------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果需要每次重启 rewriter_enabled 参数都是开启的话，可以在配置文件中配置对应参数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">rewriter_enabled=ON</span><br></pre></td></tr></table></figure>
<ul>
<li>动态修改参数可以通过以下方式开启或者关闭插件，在刚安装完插件的时候，默认是开启的</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rewriter_enabled = <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rewriter_enabled = <span class="keyword">OFF</span>;</span><br></pre></td></tr></table></figure>
<p>安装完 Query Rewrite Plugin 插件之后自从创建一个 query_rewrite 的 database，该 database 下有一张 rewrite_rules 表，用于记录对应的改写规则。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@127.0.0.1 : query_rewrite 06:48:28&gt; show create table query_rewrite.rewrite_rules\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: rewrite_rules</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`rewrite_rules`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`pattern`</span> <span class="built_in">varchar</span>(<span class="number">5000</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`pattern_database`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`replacement`</span> <span class="built_in">varchar</span>(<span class="number">5000</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`enabled`</span> enum(<span class="string">'YES'</span>,<span class="string">'NO'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'YES'</span>,</span><br><span class="line">  <span class="string">`message`</span> <span class="built_in">varchar</span>(<span class="number">1000</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`pattern_digest`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`normalized_pattern`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="Query-Rewrite-Plugin-使用"><a href="#Query-Rewrite-Plugin-使用" class="headerlink" title="Query Rewrite Plugin 使用"></a>Query Rewrite Plugin 使用</h2><p>使用语句改写的话，只需要将改写规则写入到 rewrite_rules 表中并且通过 CALL query_rewrite.flush_rewrite_rules() 加载生效即可。</p>
<p>比如将 SELECT ? 语句改写为 SELECT ? + 1 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@127.0.0.1 : query_rewrite 07:32:41&gt; INSERT INTO query_rewrite.rewrite_rules (pattern, replacement)</span><br><span class="line">    -&gt; VALUES('SELECT ?', 'SELECT ? + 1');</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : query_rewrite 07:32:51&gt; CALL query_rewrite.flush_rewrite_rules();</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : query_rewrite 07:33:01&gt; select 2;</span><br><span class="line">+<span class="comment">-------+</span></span><br><span class="line">| 2 + 1 |</span><br><span class="line">+<span class="comment">-------+</span></span><br><span class="line">|     3 |</span><br><span class="line">+<span class="comment">-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Note (Code <span class="number">1105</span>): <span class="keyword">Query</span> <span class="string">'select 2'</span> rewritten <span class="keyword">to</span> <span class="string">'SELECT 2 + 1'</span> <span class="keyword">by</span> a <span class="keyword">query</span> rewrite <span class="keyword">plugin</span></span><br></pre></td></tr></table></figure>
<p>SQL 改写的话没有语句类型的限制，改写前的语句类型可以跟改写后的语句类型不一致，比如可以将 SELECT 语句改写为 INSERT 语句。如果调用 CALL query_rewrite.flush_rewrite_rules(); 使改写规则生效的时候报错了，可以查看 rewrite_rules 表中对应的 message 字段，会有具体的错误信息提示。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">root@127.0.0.1 : query_rewrite 07:34:51&gt; use gangshen;</span><br><span class="line">Database changed</span><br><span class="line">root@127.0.0.1 : gangshen 07:37:13&gt; create table t(id int primary key,name varchar(20));</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : gangshen 07:37:36&gt; INSERT INTO query_rewrite.rewrite_rules (pattern, replacement) VALUES('SELECT * from t', 'insert into t values(3,"aa")');</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : gangshen 07:39:12&gt; CALL query_rewrite.flush_rewrite_rules();</span><br><span class="line">ERROR 1644 (45000): Loading of some rule(s) failed.</span><br><span class="line">root@127.0.0.1 : gangshen 07:39:26&gt; select * from query_rewrite.rewrite_rules;</span><br><span class="line">+<span class="comment">----+-----------------+------------------+------------------------------+---------+--------------------------------------------------+------------------------------------------------------------------+--------------------+</span></span><br><span class="line">| id | pattern         | pattern_database | replacement                  | enabled | message                                          | pattern_digest                                                   | normalized_pattern |</span><br><span class="line">+<span class="comment">----+-----------------+------------------+------------------------------+---------+--------------------------------------------------+------------------------------------------------------------------+--------------------+</span></span><br><span class="line">|  2 | <span class="keyword">SELECT</span> ?        | <span class="literal">NULL</span>             | <span class="keyword">SELECT</span> ? + <span class="number">1</span>                 | YES     | <span class="literal">NULL</span>                                             | d1b44b0c19af710b5a679907e284acd2ddc285201794bc69a2389d77baedddae | <span class="keyword">select</span> ?           |</span><br><span class="line">|  <span class="number">3</span> | <span class="keyword">SELECT</span> * <span class="keyword">from</span> t | <span class="literal">NULL</span>             | <span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">"aa"</span>) | YES     | <span class="keyword">Parse</span> <span class="keyword">error</span> <span class="keyword">in</span> pattern: &gt;&gt;<span class="keyword">No</span> <span class="keyword">database</span> selected&lt;&lt; | <span class="literal">NULL</span>                                                             | <span class="literal">NULL</span>               |</span><br><span class="line">+<span class="comment">----+-----------------+------------------+------------------------------+---------+--------------------------------------------------+------------------------------------------------------------------+--------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> : gangshen <span class="number">07</span>:<span class="number">39</span>:<span class="number">36</span>&gt; <span class="keyword">update</span> query_rewrite.rewrite_rules <span class="keyword">set</span> pattern=<span class="string">'SELECT * from gangshen.t'</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">3</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : gangshen 07:40:18&gt; update query_rewrite.rewrite_rules set replacement='insert into gangshen.t values(3,"aa")' where id = 3;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : gangshen 07:40:50&gt; CALL query_rewrite.flush_rewrite_rules();</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@127.0.0.1 : gangshen 07:40:54&gt; select * from gangshen.t limit 5;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> : gangshen <span class="number">07</span>:<span class="number">41</span>:<span class="number">55</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> gangshen.t;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">Note (Code 1105): Query '<span class="keyword">select</span> * <span class="keyword">from</span> gangshen.t<span class="string">' rewritten to '</span><span class="keyword">insert</span> <span class="keyword">into</span> gangshen.t <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">"aa"</span>)<span class="string">' by a query rewrite plugin</span></span><br><span class="line"><span class="string">root@127.0.0.1 : gangshen 07:42:00&gt; select * from gangshen.t limit 5;</span></span><br><span class="line"><span class="string">+----+------+</span></span><br><span class="line"><span class="string">| id | name |</span></span><br><span class="line"><span class="string">+----+------+</span></span><br><span class="line"><span class="string">|  3 | aa   |</span></span><br><span class="line"><span class="string">+----+------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>
<h2 id="Query-Rewrite-Plugin-的限制"><a href="#Query-Rewrite-Plugin-的限制" class="headerlink" title="Query Rewrite Plugin 的限制"></a>Query Rewrite Plugin 的限制</h2><ul>
<li>8.0.12 之前的版本只支持 SELECT 语句的改写，8.0.12 版本开始支持 SELECT/INSERT/REPLACE/UPDATE/DELETE 语句的改写</li>
<li>只支持单独语句以及 prepare 语句的改写，视图或者存储过程相关的语句无法改写</li>
<li>改写没有语句类型的限制，比如 SELECT 语句可以改写为 INSERT 语句</li>
</ul>
<h2 id="Query-Rewrite-Plugin-场景及总结"><a href="#Query-Rewrite-Plugin-场景及总结" class="headerlink" title="Query Rewrite Plugin 场景及总结"></a>Query Rewrite Plugin 场景及总结</h2><p>个人能想到的 SQL 改写可以使用到的场景：</p>
<ol>
<li>对于危险 SQL 比如 delete from table_name 这种，可以做到拦截，避免不小心将表数据完全删除</li>
<li>业务上线后，发现某条 SQL 对数据库造成很大压力影响，可以将该 SQL 改写为 SELECT 1 这种语句，临时降低对数据库的负载</li>
<li>数据库升级之后，SQL 执行计划不正确导致数据库负载过高，在不修改业务代码的情况下，可以通过 SQL 改写的方式让 SQL 走更优的执行计划</li>
<li>历史库场景，过滤 DELETE 操作</li>
<li>SQL 改写可以理解为简单的触发器功能，可以参考 pt-osc 的方式支持在线字段变更</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/10/050-2020-year-end-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/10/050-2020-year-end-summary/" class="post-title-link" itemprop="url">2020 年终总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-10 21:46:13" itemprop="dateCreated datePublished" datetime="2021-02-10T21:46:13+08:00">2021-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂/" itemprop="url" rel="index"><span itemprop="name">杂</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2020-年终总结"><a href="#2020-年终总结" class="headerlink" title="2020 年终总结"></a>2020 年终总结</h1><p>每次在到了年底回顾的时候，最初的反应都是，这一年又过去了，好像什么也没干啊。但是仔细翻翻过去一年的记录，发现还是发生过很多事情的，但是有意义或者印象深刻的不多。如果利用好时间，一年时间可以做很多事情。 2020 年，以疫情轰轰烈烈地作为开头开始了不一样的一年。年初的时候因为疫情的原因，第一次过年没有走亲戚，大家都老老实实在家待着，跟家人待在一起，上一次这么长时间在家，应该需要追溯到高考结束那个暑假了吧。从上大学开始到工作，都没有这么长时间的在家了。也因为疫情的原因体验了一把在家远程上班的感觉，比去办公室上班累多了，因为担心被怀疑在摸鱼，所以需要时刻注意着消息提示，看到消息提示得马上回复；因为大家没办法面多面交流，为了快速达成一致就需要大家频繁地开会，我一个普通员工都开会开到难受，老板应该更难受，全天会议轰炸。</p>
<p>不过疫情对我来说也有好的一面，因为我本身就是一个不是很喜欢社交的人，因为疫情的原因，控制大家都不要出门，对于我来说这是一个很好的宅着的理由。让我有更多的时间可以跟自己独处，可以剖析我自己。遇到剖析不了的时候，那就去读书，去锻炼。起码这两件事不会有什么错误。</p>
<p>10 月份终于从上海回到了杭州工作，回来之后还是觉得在杭州比较自在，毕竟生活了二十几年，待久了想离开，离开了又想回来的地方。即使杭州这个地方变得让我有很多不喜欢的，但是回来的感觉真好。</p>
<p>人生中的第一本书也终于出来了，也算是了了自己一个小小的心愿，很长一段时间应该都不会想写第二本书了，从写第一本书的经历来看，自己肚子里还是很缺乏内容，我理解的写书是一种由内而外溢出来，自然而然的一个写作过程，而不是一种类似于学习的方式。我更希望我写的书是对读者能有用的，而不是多作者是有用的。所以我想着还是再积累积累，有生之年也不知道会不会有让我觉得有冲动可以写一本书的时候了。觉得缺少了很多输出的锻炼，无论是对技术文章还是其他的内容，总觉得没有感觉，准备写的时候，脑袋里空空的，啥也没有。所以 2021 年想让自己多输出、输出。</p>
<h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>19 年立了不少 flag ，虽然倒了不少，但是该有的复盘还是得要有的：</p>
<ol>
<li>25 本书：完成，数量上虽然完成了，但是质量上感觉没上去，读书一直感觉没有读进去，只是从我脑子中过了一年</li>
<li>坚持锻炼，体重减到 140：未完成，年年 flag 140 ，年年完成不了，距离目标最近的时候是 73.2KG ，那是 12 月份跟人打赌，一个月减掉了 10 斤，但是后续没有坚持减下去，不过有养成锻炼的习惯了，健身房离公司近，离家近真的很重要</li>
<li>找个女朋友，从“想”变成实际行动：未完成，的确还停留在 “找个女朋友的实际行动中”</li>
<li>做一个开源项目或者成为 TiDB Contributer：完成，零零总总也差不多给 tidb 提了 10 来个 PR 今年，虽然对 tidb 还是不了解，但是有些事情做了会发现没有想象中的那么难，干就完了</li>
<li>多赚钱：完成，这个没有具体标准来衡量，但是今年新增了一种投资手段——股票，幸运的是今年的股市行情还不错，所以第一年入股市没有亏，还赚了点。但是本身没有完备的投资体系，所以赚钱还都是因为运气，需要学习加总结。真想一夜暴富</li>
<li>发展一项爱好：算完成吧，今年尝试了一些消磨时间的爱好，比如拼模型、乐高、摩托车（考驾照中）、画画，虽然没有发现真正的爱好，但是做了不少尝试。</li>
</ol>
<p>回顾下来，flag 的确倒了不少，但还好是完成的多于未完成的。2021 再接再厉。</p>
<h2 id="立目标"><a href="#立目标" class="headerlink" title="立目标"></a>立目标</h2><p>21 年不立目标，低头做事。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/01/052-haproxy-ip/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/01/052-haproxy-ip/" class="post-title-link" itemprop="url">TiDB + HAProxy 配置透传 IP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-01 16:43:13" itemprop="dateCreated datePublished" datetime="2020-07-01T16:43:13+08:00">2020-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TiDB/" itemprop="url" rel="index"><span itemprop="name">TiDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><ul>
<li>TiDB 版本：v4.0.0</li>
<li>HAProxy 版本：1.5.18</li>
<li>IP 信息：<ul>
<li>tidb-server IP: 172.16.5.189:14000</li>
<li>HAProxy IP: 172.16.5.171:12345</li>
<li>mysql client IP：172.16.5.169</li>
</ul>
</li>
</ul>
<h2 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h2><p>配置 HAProxy 透传 IP ，主要是需要在 haproxy 配置文件中配置 <code>send-proxy</code> 选项，以及设置 tidb 配置 <code>proxy-protocol.networks</code> 为 HAProxy 所在机器IP</p>
<ul>
<li>查看集群信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[tidb@node5169 gangshen]$ tiup cluster display sg-latest</span><br><span class="line">Starting component `cluster`: /home/tidb/.tiup/components/cluster/v1.0.7/tiup-cluster display sg-latest</span><br><span class="line">TiDB Cluster: sg-latest</span><br><span class="line">TiDB Version: v4.0.0</span><br><span class="line">ID                  Role        Host          Ports        OS/Arch       Status  Data Dir                                           Deploy Dir</span><br><span class="line">--                  ----        ----          -----        -------       ------  --------                                           ----------</span><br><span class="line">172.16.5.189:13000  grafana     172.16.5.189  13000        linux/x86_64  Up      -                                                  /home/tidb/gangshen/install/deploy/grafana-13000</span><br><span class="line">172.16.4.235:12379  pd          172.16.4.235  12379/12380  linux/x86_64  Up|L    /home/tidb/gangshen/install/data/pd-12379          /home/tidb/gangshen/install/deploy/pd-12379</span><br><span class="line">172.16.4.237:12379  pd          172.16.4.237  12379/12380  linux/x86_64  Up|UI   /home/tidb/gangshen/install/data/pd-12379          /home/tidb/gangshen/install/deploy/pd-12379</span><br><span class="line">172.16.5.189:12379  pd          172.16.5.189  12379/12380  linux/x86_64  Up      /home/tidb/gangshen/install/data/pd-12379          /home/tidb/gangshen/install/deploy/pd-12379</span><br><span class="line">172.16.5.189:19090  prometheus  172.16.5.189  19090        linux/x86_64  Up      /home/tidb/gangshen/install/data/prometheus-19090  /home/tidb/gangshen/install/deploy/prometheus-19090</span><br><span class="line">172.16.5.189:14000  tidb        172.16.5.189  14000/20080  linux/x86_64  Up      -                                                  /home/tidb/gangshen/install/deploy/tidb-14000</span><br><span class="line">172.16.5.171:30160  tikv        172.16.5.171  30160/30180  linux/x86_64  Up      /home/tidb/gangshen/install/data/tikv-30160        /home/tidb/gangshen/install/deploy/tikv-30160</span><br><span class="line">172.16.5.172:30160  tikv        172.16.5.172  30160/30180  linux/x86_64  Up      /home/tidb/gangshen/install/data/tikv-30160        /home/tidb/gangshen/install/deploy/tikv-30160</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 tidb 配置 <code>proxy-protocol.networks</code> 为 HAProxy 所在机器IP并 reload 重启生效</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tiup cluster edit-config sg-latest</span><br><span class="line">tiup cluster reload sg-latest -R tidb</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20200701213442.png" alt></p>
<ul>
<li>修改 haproxy 配置，在 backend server 配置中添加 <code>send-proxy</code> 选项</li>
</ul>
<p>具体 haproxy 安装以及配置可以参考 TiDB 官网 <a href="https://docs.pingcap.com/zh/tidb/v4.0/haproxy-best-practices#%E5%90%AF%E5%8A%A8-haproxy" target="_blank" rel="noopener">HAProxy 在 TiDB 中的最佳实践</a></p>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20200701213525.png" alt></p>
<ul>
<li>修改 haproxy 配置之后，重启 haproxy 生效配置</li>
</ul>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>在 172.16.5.169 机器上用 mysql client 连接 haproxy 并通过 <code>show processlist</code> 查看连接来源 IP</p>
<p><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20200701213551.png" alt></p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="连接报-ERROR-2013-HY000-Lost-connection-to-MySQL-server-at-39-reading-initial-communication-packet-39-system-error-0"><a href="#连接报-ERROR-2013-HY000-Lost-connection-to-MySQL-server-at-39-reading-initial-communication-packet-39-system-error-0" class="headerlink" title="连接报 ERROR 2013 (HY000): Lost connection to MySQL server at &#39;reading initial communication packet&#39;, system error: 0"></a>连接报 <code>ERROR 2013 (HY000): Lost connection to MySQL server at &#39;reading initial communication packet&#39;, system error: 0</code></h3><p>问题现象：<br><img src="https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/20200701213624.png" alt><br>问题原因：<br>haproxy 配置中没有配置 <code>send-proxy</code> 选项，修改 haproxy 配置之后正常。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/16/051-pd-recovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/pig.jpeg">
      <meta itemprop="name" content="Win-Man">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Win-Man's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/16/051-pd-recovery/" class="post-title-link" itemprop="url">TiDB 异常断电恢复后 PD 节点启动失败</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-16 16:43:13" itemprop="dateCreated datePublished" datetime="2020-06-16T16:43:13+08:00">2020-06-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-26 14:42:58" itemprop="dateModified" datetime="2021-05-26T14:42:58+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TiDB/" itemprop="url" rel="index"><span itemprop="name">TiDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境信息及故障现象"><a href="#环境信息及故障现象" class="headerlink" title="环境信息及故障现象"></a>环境信息及故障现象</h2><h3 id="集群版本"><a href="#集群版本" class="headerlink" title="集群版本"></a>集群版本</h3><p>v4.0.0</p>
<h3 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h3><p>TiDB 集群的物理机异常断电重启,机器恢复后,通过 <code>tiup cluster start &lt;cluster-name&gt;</code> 启动集群，发现有两个 <code>PD</code> 节点启动失败</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# tiup cluster start t11</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.0.0/cluster start t11</span><br><span class="line">Starting cluster t11...</span><br><span class="line">+ [ Serial ] - SSHKeySet: privateKey=/root/.tiup/storage/cluster/clusters/t11/ssh/id_rsa, publicKey=/root/.tiup/storage/cluster/clusters/t11/ssh/id_rsa.pub</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.128</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.151</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.152</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.153</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.151</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.152</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.155</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.128</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.128</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.154</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.153</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.73.128</span><br><span class="line">+ [ Serial ] - ClusterOperate: operation=StartOperation, options=&#123;Roles:[] Nodes:[] Force:false SSHTimeout:5 OptTimeout:60 APITimeout:300&#125;</span><br><span class="line">Starting component pd</span><br><span class="line">	Starting instance pd 192.168.73.153:2379</span><br><span class="line">	Starting instance pd 192.168.73.151:2379</span><br><span class="line">	Starting instance pd 192.168.73.152:2379</span><br><span class="line">	Start pd 192.168.73.151:2379 success</span><br><span class="line">retry error: operation timed out after 1m0s</span><br><span class="line">	pd 192.168.73.153:2379 failed to start: timed out waiting for port 2379 to be started after 1m0s, please check the log of the instance</span><br><span class="line">retry error: operation timed out after 1m0s</span><br><span class="line">	pd 192.168.73.152:2379 failed to start: timed out waiting for port 2379 to be started after 1m0s, please check the log of the instance</span><br><span class="line"></span><br><span class="line">Error: failed to start: failed to start pd: 	pd 192.168.73.153:2379 failed to start: timed out waiting for port 2379 to be started after 1m0s, please check the log of the instance: timed out waiting for port 2379 to be started after 1m0s</span><br><span class="line"></span><br><span class="line">Verbose debug logs has been written to /root/logs/tiup-cluster-debug-2020-06-16-16-28-39.log.</span><br><span class="line">Error: run `/root/.tiup/components/cluster/v1.0.0/cluster` (wd:/root/.tiup/data/S23ruRB) failed: exit status 1</span><br></pre></td></tr></table></figure>
<p>登陆到 <code>PD</code> 节点所在机器，查看 <code>pd-server</code> 进程的确不存在，通过 <code>pd.log</code> 日志查看 <code>PD</code> 启动失败的原因：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[2020/06/16 16:29:10.180 +08:00] [INFO] [systime_mon.go:26] [&quot;start system time monitor&quot;]</span><br><span class="line">[2020/06/16 16:29:10.181 +08:00] [INFO] [backend.go:79] [&quot;opened backend db&quot;] [path=/tidb/tidb-data/pd-2379/member/snap/db] [took=739.112µs]</span><br><span class="line">[2020/06/16 16:29:10.182 +08:00] [INFO] [server.go:443] [&quot;recovered v2 store from snapshot&quot;] [snapshot-index=1400015] [snapshot-size=&quot;22 kB&quot;]</span><br><span class="line">[2020/06/16 16:29:10.195 +08:00] [WARN] [db.go:92] [&quot;failed to find [SNAPSHOT-INDEX].snap.db&quot;] [snapshot-index=1400015] [snapshot-file-path=/tidb/tidb-data/pd-2379/member/snap/0000000000155ccf.snap.db] [error=&quot;snap: snapshot file doesn&apos;t exist&quot;]</span><br><span class="line">[2020/06/16 16:29:10.195 +08:00] [PANIC] [server.go:454] [&quot;failed to recover v3 backend from snapshot&quot;] [error=&quot;failed to find database snapshot file (snap: snapshot file doesn&apos;t exist)&quot;]</span><br><span class="line">[2020/06/16 16:29:10.195 +08:00] [FATAL] [log.go:292] [panic] [recover=&quot;\&quot;invalid memory address or nil pointer dereference\&quot;&quot;] [stack=&quot;github.com/pingcap/log.Fatal\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/pkg/mod/github.com/pingcap/log@v0.0.0-20200117041106-d28c14d3b1cd/global.go:59\ngithub.com/pingcap/pd/v4/pkg/logutil.LogPanic\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/src/github.com/pingcap/pd/pkg/logutil/log.go:292\nruntime.gopanic\n\t/usr/local/go/src/runtime/panic.go:679\nruntime.panicmem\n\t/usr/local/go/src/runtime/panic.go:199\nruntime.sigpanic\n\t/usr/local/go/src/runtime/signal_unix.go:394\ngo.etcd.io/etcd/etcdserver.NewServer.func1\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/pkg/mod/go.etcd.io/etcd@v0.5.0-alpha.5.0.20191023171146-3cf2f69b5738/etcdserver/server.go:335\nruntime.gopanic\n\t/usr/local/go/src/runtime/panic.go:679\ngo.uber.org/zap/zapcore.(*CheckedEntry).Write\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/pkg/mod/go.uber.org/zap@v1.13.0/zapcore/entry.go:230\ngo.uber.org/zap.(*Logger).Panic\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/pkg/mod/go.uber.org/zap@v1.13.0/logger.go:225\ngo.etcd.io/etcd/etcdserver.NewServer\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/pkg/mod/go.etcd.io/etcd@v0.5.0-alpha.5.0.20191023171146-3cf2f69b5738/etcdserver/server.go:454\ngo.etcd.io/etcd/embed.StartEtcd\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/pkg/mod/go.etcd.io/etcd@v0.5.0-alpha.5.0.20191023171146-3cf2f69b5738/embed/etcd.go:211\ngithub.com/pingcap/pd/v4/server.(*Server).startEtcd\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/src/github.com/pingcap/pd/server/server.go:257\ngithub.com/pingcap/pd/v4/server.(*Server).Run\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/src/github.com/pingcap/pd/server/server.go:441\nmain.main\n\t/home/jenkins/agent/workspace/build_pd_multi_branch_v4.0.0/go/src/github.com/pingcap/pd/cmd/pd-server/main.go:118\nruntime.main\n\t/usr/local/go/src/runtime/proc.go:203&quot;]</span><br></pre></td></tr></table></figure>
<p>看到两个 <code>PD</code> 节点都报 <code>failed to recover v3 backedn from snapshot</code> 错误。</p>
<h3 id="故障原因分析"><a href="#故障原因分析" class="headerlink" title="故障原因分析"></a>故障原因分析</h3><h3 id="故障解决步骤"><a href="#故障解决步骤" class="headerlink" title="故障解决步骤"></a>故障解决步骤</h3><p>参考官方文档 <a href="https://docs.pingcap.com/zh/tidb/v4.0/pd-recover#pd-recover-%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3" target="_blank" rel="noopener">PD Recover 使用文档</a> ,通过 <code>pd-recovery</code> 工具恢复集群。</p>
<p>根据文档内容主要分为 3 个步骤：1. 找到 <code>cluster id</code> 2. 找到当前最大 <code>alloc id</code> 3. 通过 pd-recovery 恢复 pd 集群</p>
<p>这边的话，都是通过 PD 日志来查找 <code>cluster id</code> 和 <code>alloc id</code>。</p>
<p><strong>操作步骤</strong></p>
<ol>
<li>查找 cluster id</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat /tidb/tidb-bin/pd-2379/log/pd.log | grep &quot;init cluster id&quot;</span><br><span class="line">[2020/05/06 23:37:02.121 +08:00] [INFO] [server.go:340] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/05/07 00:03:25.132 +08:00] [INFO] [server.go:340] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/05/07 11:45:39.338 +08:00] [INFO] [server.go:340] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/05/25 14:54:50.076 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/05/25 16:45:55.526 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/05/25 16:48:21.462 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/06/01 19:13:17.478 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/06/04 02:28:29.655 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/06/05 22:27:46.152 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/06/08 22:50:30.045 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/06/08 22:50:59.534 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br><span class="line">[2020/06/11 01:48:35.936 +08:00] [INFO] [server.go:336] [&quot;init cluster id&quot;] [cluster-id=6823755660393880966]</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>查找当前最大的 <code>alloc id</code> ，因为 pd-recovery 去恢复的时候需要指定一个比当前最大的 <code>alloc id</code> 更大的 <code>alloc id</code>，所以需要对所有的 pd 节点日志进行查找</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pd-1</span><br><span class="line">[root@localhost ~]# cat /tidb/tidb-bin/pd-2379/log/pd.log | grep &quot;allocates&quot;</span><br><span class="line">[2020/05/06 23:37:04.752 +08:00] [INFO] [id.go:110] [&quot;idAllocator allocates a new id&quot;] [alloc-id=1000]</span><br><span class="line">[2020/05/12 11:21:28.271 +08:00] [INFO] [id.go:110] [&quot;idAllocator allocates a new id&quot;] [alloc-id=2000]</span><br><span class="line"></span><br><span class="line">pd-2</span><br><span class="line">[root@localhost ~]# cat /tidb/tidb-bin/pd-2379/log/pd.log | grep &quot;allocates&quot;</span><br><span class="line"></span><br><span class="line">pd-3</span><br><span class="line">[root@localhost ~]# cat /tidb/tidb-bin/pd-2379/log/pd.log | grep &quot;allocates&quot;</span><br><span class="line">[2020/05/27 11:20:20.687 +08:00] [INFO] [id.go:110] [&quot;idAllocator allocates a new id&quot;] [alloc-id=3000]</span><br><span class="line">[2020/06/10 18:04:43.361 +08:00] [INFO] [id.go:110] [&quot;idAllocator allocates a new id&quot;] [alloc-id=4000]</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>删除旧 PD 集群 data 目录下的所有内容，因为这个集群 PD 节点 data 目录为 /tidb/tidb-data/pd-2379 ,所以删除 /tidb/tidb-data/pd-2379 目录下所有内容</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">查看 data 目录</span><br><span class="line">[root@localhost ~]# tiup cluster display t11</span><br><span class="line">......</span><br><span class="line">192.168.73.151:2379   pd            192.168.73.151  2379/2380                        linux/x86_64  Healthy    /tidb/tidb-data/pd-2379            /tidb/tidb-bin/pd-2379</span><br><span class="line">192.168.73.152:2379   pd            192.168.73.152  2379/2380                        linux/x86_64  Healthy    /tidb/tidb-data/pd-2379            /tidb/tidb-bin/pd-2379</span><br><span class="line">192.168.73.153:2379   pd            192.168.73.153  2379/2380                        linux/x86_64  Healthy|L  /tidb/tidb-data/pd-2379            /tidb/tidb-bin/pd-2379</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">删除数据目录</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mv /tidb/tidb-data/pd-2379/* /tmp</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>启动 PD 集群</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tiup cluster start t11 -R pd</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>通过 pd-recovery 恢复集群，<code>--endpoints</code> 指定一个 pd 节点，<code>-cluster-id</code> 指定查找到的 cluster-id ,<code>-alloc-id</code> 指定比查找到的最大 alloc id 更大的一个数字，所以这边只要指定一个比 4000 更大的数字即可</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ./pd-recover -endpoints http://192.168.73.151:2379 -cluster-id 6823755660393880966 -alloc-id 10000</span><br><span class="line">recover success! please restart the PD cluster</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>重启 PD 集群</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tiup cluster restart t11 -R pd</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>启动集群</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tiup cluster start t11</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>查看集群状态，恢复正常</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tiup cluster display t11</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<blockquote>
<p>通过 tiup 部署的 TiDB 集群需要用户自己下载 pd-recovery 工具，可以通过 <code>http://download.pingcap.org/tidb--linux-amd64.tar.gz</code> 链接进行下载</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Win-Man"
      src="/images/pig.jpeg">
  <p class="site-author-name" itemprop="name">Win-Man</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Win-Man" title="GitHub → https://github.com/Win-Man" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gang.shen0423@gmail.com" title="E-Mail → mailto:gang.shen0423@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/2855803080" title="Weibo → https://weibo.com/2855803080" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://blog.csdn.net/win_man" title="http://blog.csdn.net/win_man" rel="noopener" target="_blank">CSDN博客</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Win-Man</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1260159928&web_id=1260159928"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
